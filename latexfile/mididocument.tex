\documentclass[uplatex, 10pt, dvipdfmx]{jsarticle}
\usepackage[dvipdfmx]{hyperref}
\setcounter{secnumdepth}{4}
\usepackage{color}
\usepackage[deluxe]{otf}
\usepackage[noto-otc]{pxchfon}
\usepackage[left=25mm,right=25mm,top=30mm,bottom=30mm]{geometry}
\usepackage{bm}
\usepackage{fancyvrb}
\usepackage{comment}
\usepackage{bigints}
\usepackage{autobreak}
\usepackage{plext}
\usepackage{breqn}
\usepackage{empheq}
\usepackage{here}
\usepackage{wrapfig}
\usepackage{amsmath,amsthm,amssymb}
\usepackage{physics}
\usepackage{cancel}
\usepackage{ascmac}
\usepackage{listings}
\usepackage{tikz}
\usepackage{listings,jlisting}
\usepackage{here}
\usepackage{enumitem}
\usepackage{dirtree} 
\usepackage[subrefformat=parens]{subcaption}
\usepackage{graphicx}
\usepackage{pxjahyper}
\usepackage{floatflt}
%%見出しに関する命令
\usepackage{titlesec}
\titleformat*{\section}{\LARGE\bfseries\gtfamily}
\titleformat*{\subsection}{\Large\bfseries\gtfamily}
\titleformat*{\subsubsection}{\large\bfseries\gtfamily}
\titleformat*{\paragraph}{\normalsize\bfseries\gtfamily}

\lstset{
  basicstyle={\ttfamily},
  identifierstyle={\small},
  commentstyle={\smallitshape},
  keywordstyle={\small\bfseries},
  ndkeywordstyle={\small},
  stringstyle={\small\ttfamily},
  frame={tb},
  breaklines=true,
  columns=[l]{fullflexible},
  numbers=left,
  xrightmargin=0zw,
  xleftmargin=3zw,
  numberstyle={\scriptsize},
  stepnumber=1,
  numbersep=1zw,
  lineskip=-0.5ex
}
\usetikzlibrary{intersections,calc,positioning,angles,patterns,arrows,decorations.markings,through,quotes}
%\mathtoolsset{showonlyrefs=true}
\numberwithin{equation}{section}
\usepackage{xcolor}
\hypersetup{
    colorlinks=true,
    citecolor=blue,
    linkcolor=blue,
    urlcolor=blue,
}
\newcommand{\emphj}[1]{\textbf{\textrm{\textgt{{#1}}}}}
\renewcommand{\lstlistingname}{ソース}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{document}
\VerbatimFootnotes
\columnseprule=0.2mm
\title{エレクトーン演奏演技におけるMIDIの活用}
\author{wakmin (\href{https://twitter.com/wakmin_}{@wakmin\_})}
\date{2022年8月}
\maketitle

%\jot=6pt

\setcounter{tocdepth}{4}
\tableofcontents
\clearpage

\section{はじめに}

エレクトーンは1000を超える音\cite{製品情報}を有し、1台で3($+$2)パート\footnote{鍵盤3本$+$ドラム2本。}まで演奏できるため、本来的には合奏しないと演奏できない曲でも1人で演奏しきることができる。エレクトーン単体の性能の自己完結ぶりは、他のどの電子楽器よりも優っていると言っても過言ではない。

その一方で、エレクトーン単体で完結しないようなエディットは非常に敷居が高い。例えば、自動演奏補助としてXGサポートが存在するが、XGボイスリストは公式で公開されておらず、XGサポートを作るためのGUIを備えた現代的なエディタはもはや存在しない。スタイルは他の電子楽器に搭載されているスタイルクリエーターを使わないとエディットできず、それも隠しパラメーターが存在する。そもそもこれらの仕様に関しては知名度が低く、エディットができることすら知られていない上に、製作しようと志すことができたとしても、体系的にまとまっているテキストがほとんど存在しない。そのため、「知る人ぞ知る」エレクトーンの隠し機能として、現在まで埋もれていた。

そこで本稿では、読者が自力でオリジナルの自動演奏補助が作れるようにすることを目的に、これらエレクトーンの「隠し機能」を初学者にも分かりやすく解説する。MIDIに関する低級な話題はあまり紹介せずに、即演奏に応用できるような情報のみをセレクトしたつもりである。ぜひ自分のエレクトーンで試してみて、演奏表現の幅を広げてほしい。ただし、節によっては内容が難しくなってしまったり、実用的でない情報も含まれたりしてしまったため、そのような節には「*」を付けておいた。興味がある読者や、MIDIの取り扱いに慣れた読者でなければ飛ばして構わない。

また本稿の最後には、エレクトーンの演奏演技の幅を広げる手段として、Arduinoを用いたデバイス開発のすすめを書いた。自動演奏補助とは異なるが、sysEXをリアルタイム演奏に活用したり、エレクトーンのインターフェースを拡張したりできる。ぜひチャレンジしてほしい。

\subsection{免責}
できる限り正確な情報をまとめたつもりであるが、独自研究が多く含まれているため、\emphj{本稿の内容を実行してどのような問題が生じたとしても、私はいかなる責任も取らない。本稿を読んで実行したことに対して、読者は自己責任で実行することを認めたものとする}。


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\clearpage

\section{MIDIデータの基礎知識}
この節では、MIDIのデータ部の基礎知識を解説する。とはいえ、MIDIについての解説はネットで検索すればいくらでも質の良いものがあるため、エレクトーンに応用する知識のみを紹介する。早くXGサポートを作ってみたい読者は\emphj{読み飛ばして構わない。}
\begin{itembox}{この節の参考書}
\begin{itemize}
\item MIDI 入門\cite{MIDI入門}

MIDIに関するヤマハの初心者向けテキストである。電子楽器に明るくない人が一番最初に読む文献としてふさわしいと思う。

\item MIDI1.0 規格書\cite{規格}

MIDIのほとんど全ての情報を得ることができる。ただし、量が多いので全部読もうとするのは勧めない。辞書がわりに使うのが良い。

\item ELS-02/ELS-02C/ELS-02X MIDIリファレンス\cite{MIDIリファレンス}

ELS-02シリーズが対応しているMIDIメッセージの一覧。エレクトーンに対してどのような命令をMIDIで行えるのかの参考になる。Domino（後述）を使うならMIDIメッセージのバイナリ表現を気にする必要はほとんどないのだが、MIDIが本来的には数情報の羅列であることは心に留めておいてほしい。

\end{itemize}
\end{itembox}

\subsection{MIDIとは}
\emphj{MIDI}とはMusical Instrument Digital Interfaceの略で、異なる機種・異なるメーカー間であっても「演奏情報」をコミュニケーションするために策定された規格である\cite{規格}。実際の音色は各楽器で合成されるが、通信されるのは「何番目の音を」「どれくらいの強さで」「弾き始める」などという情報である。このような演奏情報を、\emphj{MIDIチャンネルメッセージ}と呼ぶ。また、演奏情報以外の情報を、\emphj{MIDIシステムメッセージ}と呼ぶ。これら2つを合わせて、\emphj{MIDIメッセージ}と呼ぶ。本稿では、MIDIメッセージの具体的な表現（バイナリ表現）には立ち入らず、「どのような情報が流れているか」に焦点を絞って説明する\footnote{本稿ではArduino MIDI LibraryやDominoを用いてMIDIの処理をするため、具体的な表現はほぼほぼ必要にならない（それらに上手くパッケージ化されている）。ただし、MIDIシステムエクスクルーシブメッセージをArduinoで制御しようとしたときは値を直接打ち込む必要がある。}。

我々がエレクトーンの3段の鍵盤を触ったり、パネルを操作したりすると、それらの操作1つ1つに対応するMIDIメッセージが音源部に送信されて、実際の音に反映される。単に演奏するだけであればこのことを意識する必要はないが、自動伴奏や自動演奏を製作しようとすれば、これら演奏情報を（実際のリアルタイムな演奏無しで）音源部に送信しなければならないため、MIDIメッセージの理解が不可欠となる。

\subsection{General MIDIとXG、ELボイス}
MIDIはもともと演奏情報を取り扱う規格であって、受信側でどのような音を発生させるかはメーカーごとに異なっていた。これを統一するために現れた規格が\emphj{General MIDI (GM)}であり、プログラムチェンジ（後述）やドラムマップ\footnote{ドラムマップとは、鍵盤上にドラムパーカッションを並べるとき、どのキーがどのパーカッションに対応しているかの割り当て。C2にキック、D2にスネアなど、GMによって決まっている。}の統一などがなされた\cite{GMwiki}\cite{GMdtm}。ヤマハはGMを拡張して\emphj{XG}\footnote{XGは、DTMの開祖・ローランドのGS規格に対抗するために打ち立てられた\cite{全面戦争}DTM音源の規格であった。1996年にローランドがSC-88Proという伝説的な機体を出したのもこの頃である。お互いに音源規格の覇権を争っていたが、両社とも2001年にGM Level 2に合流することで戦争は収束に向かい\cite{戦争収束}、「XG音源」を前面に打ち出す必要がなくなった。DTM用音源がその後の時代でプラグイン音源に置き換わったため、XGは2021年現在、表舞台から姿を消した。EL3桁代の頃はDTM用音源との互換性のために、XGの基本機体であるMU50相当の音源を搭載していたが、それより先のELS-01、02シリーズになると、もはやDTM用音源のためのXGとは違った独自の方向へと進化したようである\href{http://els01stylefile.music.coocan.jp/Stagea_Style/Stagea_Style_P78.htm}{【8-78】}（スタイル入門講座へのリンク）}という独自規格を作り、GMで作られたデータを再生できるようにしつつ、表現能力を高めた。

さて、エレクトーンはXG規格楽器である。しかし、エレクトーンの鍵盤で演奏する音色がXGによるものかというと、（大部分が）そうではない。エレクトーンには、\emphj{自動演奏のためのボイス（XGボイス）}と、\emphj{鍵盤で演奏するためのボイス（ELボイス）}とが存在する。\emphj{XGボイス、ELボイスという呼び方は本稿の便宜であるため、公式的な呼称でないことに注意してほしい}。XGボイスはスタイルとXGサポートでしか現れない\footnote{キーボードパーカッションでも扱うが、この場合XGパーカッションを例外的に鍵盤で使っているものと理解できる。}。本稿ではXGボイスを主に紹介する。

\subsection{MIDIチャンネルメッセージ}

\begin{figure}[htbp]
  \centering
  \includegraphics[width=150mm]{figMIDImessage.pdf}
  \caption{MIDIメッセージの種類。}
  \label{figMIDImessage}
\end{figure}

図\ref{figMIDImessage}にMIDIメッセージの種類を示す。図の上半分にあるMIDIチャンネルメッセージについて、この節では解説する。

MIDIチャンネルメッセージは、演奏に関する情報と、音色の設定の情報である。よく使用されるメッセージは、\emphj{ノートオン・オフ}、\emphj{チャンネルプレッシャー}、\emphj{ピッチベンドチェンジ}、\emphj{プログラムチェンジ}、\emphj{コントロールチェンジ}である。

MIDIチャンネルメッセージは16の独立した\emphj{チャンネル}を持っており、それぞれのチャンネルでバラバラに演奏をすることができるようになっている。MIDIチャンネルメッセージは全て、1から16までの\footnote{余談：チャンネルは内部的には0（\texttt{0H}\footnotemark）から15(\texttt{FH})の値である。sysEXなどでチャンネル指定するとき、Ch.9を指定しようとしてうっかり\texttt{09H}を送信してしまうことがよくある（実際には\texttt{08H}を送信しなくてはならない）。}チャンネルを指定しながら送信する。\footnotetext{数字\texttt{H}という書き方は、書かれた数字が16進数表現であることを示す。16進数とは、1桁に0から15までの16通りの数字を書くことができる数の表現であり、10は\texttt{AH}、11は\texttt{BH}、...、15は\texttt{FH}と書く。16から繰り上がりが生じ、16は\texttt{10H}となる。16進数表現から10進数表現に直すには、(上の位)$\times16+$(下の位)を計算する。例えば、\texttt{4AH}$=4\times16+10=74$のようにする。MIDIメッセージは16進数で2桁の数字を用いて説明されることが多い。}
エレクトーンにおいて、MIDIチャンネルはデフォルト\footnote{受信チャンネルは図\ref{figelch}で固定（ELモードの場合）だが、送信チャンネルはSTAGEAの本体設定で変更することができる。変更する場合、UTILITYボタンを押して、画面上部のタブメニューからMIDIを選択すれば良い。}で図\ref{figelch}のように鍵盤ごとに割り当てられている。図\ref{figelch}を見ればわかるように、Ch.5からCh.14までのMIDIチャンネルはエレクトーン側に対応するコントローラが存在していない。

\begin{figure}[htbp]
  \centering
  \includegraphics[width=15cm]{figelch.pdf}
  \caption{エレクトーンのデフォルトMIDIチャンネル設定。図はELモードの場合。XGモードの場合は後述。}
  \label{figelch}
\end{figure}

\subsubsection{ノートオン・オフ}
\emphj{ノートオン}とは、ノート\footnote{\emphj{ノート}とは、音符の演奏情報のことである。鍵盤のキーひとつ分に対応する。}を演奏開始する命令である。キーが押されたときに送信される。押されたキーの位置は\emphj{ノートナンバー}という値で指定され、ノートナンバーは中央C$=$60と定められている。また、演奏の強さは\emphj{ベロシティ}という（0から127を取る）値で指定される。ベロシティは、エレクトーンではイニシャルタッチの強さに関係がある。

\emphj{ノートオフ}とは、ノートの演奏を終了する命令である。キーが離されたときに送信される。なお、ノートオンのベロシティ0はノートオフと同じとして解釈される\footnote{MIDIの通信はデータの最初に命令の種類を書くのだが、命令の種類を省いた場合は前の命令と同じ命令であると解釈される（ランニングステータス）。発音を止めたいときは、ノートオンとして出力した方がランニングステータスのおかげでデータが圧縮できるため、通常はノートオフを出力せずに、ノートオンのベロシティ0を出力する。なお、一応ノートオフにもベロシティが存在し、離す強さを表すことができるが、私は対応しているハードウェアを見たことがない。}。

ノートオンからノートオフまでの時間のことを、\emphj{ゲートタイム}（またはデュレーション）と呼ぶ。

\subsubsection{チャンネルプレッシャー}
チャンネルプレッシャーは、そのチャンネルのアフタータッチの強さを指定する命令である\footnote{ELS-02Cにおいて、アフタータッチは各鍵盤に1つずつ、計3つの感圧センサーで鍵盤への力を測定して処理している。このような、チャンネルごとのアフタータッチをチャンネルプレッシャーと呼ぶ。なお、キーごとにアフタータッチを認識する場合、ポリフォニックキープレッシャーという別の命令で処理されるが、ELS02シリーズには未搭載である。}。0から127の値をとる。ELボイスのみ音色変化が起こり、XGボイスでは無視される。

\subsubsection{ピッチベンドチェンジ}
ピッチベンドチェンジは、そのチャンネルのサウンドのピッチを変化させる命令である。エレクトーンの場合、\emphj{ホリゾンタルタッチ}の強さが送信される。16384段階に量子化されており\footnote{128通りを表現できるデータバイトを2個組み合わせて使っているため、$128\times128=16384$通りを表現できる。}、デフォルトで0で、-8192から8191の値をとると表されることが多い。

\subsubsection{プログラムチェンジ (PC)}
プログラムチェンジは\emphj{PC}とも書かれ\footnote{PCとだけ書くとPersonal Computerと混同するため、本稿ではなるべくプログラムチェンジと書く。}、そのチャンネルの音色を変更する命令である。ほとんどの場合、後述のCC\texttt{\#}00/32と組み合わせて使う。ただし、\emphj{エレクトーンの場合、Ch.16のPC$=$1からPC$=$16はそれぞれレジストレーションメモリーに対応しており}\footnote{レジストレーションメモリーはsysEX（後述）でも操作できる。}、メモリーしたレジストを呼び出すことに使える。XGボイスの変更に使用し、ELボイスでは使用しない。プログラムチェンジ自体は1から128までの値\footnote{プログラムチェンジの番号は、内部的には0(\texttt{0H})から127(\texttt{7FH})の値。}をとるが、CC\texttt{\#}00/32と組み合わせて使うため、膨大な種類がある。単に「プログラムチェンジ」と言った場合、CC\texttt{\#}00/32と組み合わされて表現される1つのボイスの番地を表すことが多い。

\subsubsection{コントロールチェンジ (CC)}
コントロールチェンジは\emphj{CC}とも書かれ、音量や音の性質を変化させる命令である。2つの値がセットになっており、1つ目の値を\emphj{コントロールチェンジ番号(CC\texttt{\#})}と呼ぶ。2つ目の値がデータ値(0から127をとる)である。CC\texttt{\#}は0から127まで存在するが、よく使われるのは十数種類程度しかない。CCについての詳細な説明は\href{http://quelque.sakura.ne.jp/midi_cc.html}{コントロールチェンジ一覧表}\footnote{\url{http://quelque.sakura.ne.jp/midi_cc.html}}などを参照してほしい。多くのCCがXGボイス（Ch.5-Ch.14）にしか対応していないが、CC\texttt{\#}04 フットコントローラーとCC\texttt{\#}11 エクスプレッションはエレクトーン本体にコントローラーがついており、ELボイスの操作で使うことができる\cite{MIDIリファレンス}。それ以外は基本的にXGボイスの調節で使うと考えて構わない。以下、エレクトーン奏者が使うと思われる代表的なCCを列挙する。

\begin{description}
\item[\emphj{CC\texttt{\#}00/32 バンクセレクト}]\

プログラムチェンジで大まかな音色を指定し、CC\texttt{\#}00でそのサブカテゴリを指定、CC\texttt{\#}32でさらにそのサブカテゴリを指定する。XGボイスの音色指定で使う。CC\texttt{\#}00→CC\texttt{\#}32→プログラムチェンジの順に送信する。エレクトーンのXGボイスリストは、公式には発表されておらず、\href{http://www.comcom2.com/lib/els_ext_xg_voice_list.html}{株式会社コムコムのデータライブラリ}\footnote{\url{http://www.comcom2.com/lib/els_ext_xg_voice_list.html}}などで入手する。
\item[\emphj{CC\texttt{\#}01 モジュレーション}]\

多くの場合、ビブラートの強さを指定する。

\item[\emphj{CC\texttt{\#}04 フットコントローラー}]\

\emphj{ELボイスで使う。}セカンドエクスプレッションペダルの値。エレクトーンの場合、Ch.4(リード分離の場合)またはCh.16の命令のみボイスに作用する。

\item[\emphj{CC\texttt{\#}06 データエントリー}]\

CC\texttt{\#}98/99/100/101と一緒に使う。説明はそちらを参照してほしい。

\item[\emphj{CC\texttt{\#}07 ボリューム}]\

チャンネルのボリュームを指定する。CC\texttt{\#}11 エクスプレッションと挙動はほとんど同じだが、CC\texttt{\#}07はパート間の音量バランス調整で使い、ミキサー的な役割を担う。通常はセットアップ小節でのみ設定し、曲中では動かさない。デフォルトはCC\texttt{\#}07=100。

\item[\emphj{CC\texttt{\#}10 パン}]\

チャンネルのパンを指定する。CC\texttt{\#}10$=$0でパンを左に全振りした状態になる。中央はCC\texttt{\#}10$=$64。

\item[\emphj{CC\texttt{\#}11 エクスプレッション}]\

\emphj{ELボイス、XGボイス両方で使う。}エクスプレッションペダルの値。音量の抑揚表現やアクセントのために用いる。CC\texttt{\#}07と異なり、曲中で連続的に動かす用途を想定されている。デフォルトはCC\texttt{\#}11=127。XGボイス(Ch.5からCh.14)およびELボイス(Ch.16)で使う。

\item[\emphj{CC\texttt{\#}64 サスティン}]\

サスティンペダル。64以上でオン、未満でオフ。通常は0または127の値のみ使う。

\item[\emphj{CC\texttt{\#}65 ポルタメント}]\

ポルタメントとは、2つの異なるノートを演奏したときに、その間の音程を滑らかにつなぐ奏法。64以上でオン、未満でオフ。通常は0または127の値のみ使う。

\item[\emphj{CC\texttt{\#}71 レゾナンス}]\

CC\texttt{\#}74 ブライトネスで指定した周波数の周りの周波数特性を変えて、特徴的な音色を出す。64で効果なし。

\item[\emphj{CC\texttt{\#}74 ブライトネス}]\

ローパスフィルターをかけて高音を削ることで音の明るさを調整する。64で効果なし。それより上げるとカット周波数が高くなり高音が多くなり、下げるとカット周波数が低くなり高音が少なくなる。

\item[\emphj{CC\texttt{\#}72 リリースタイム}]
\item[\emphj{CC\texttt{\#}73 アタックタイム}]
\item[\emphj{CC\texttt{\#}75 ディケイタイム}]\

エンベロープの調整をする。64で効果なし。上げるとタイムが長くなり、下げるとタイムが短くなる。エンベロープについての解説は\href{https://ja.wikipedia.org/wiki/ADSR}{Wikipedia}\footnote{\url{https://ja.wikipedia.org/wiki/ADSR}}などにある。古典的なシンセサイザーはアタックタイム・ディケイタイム・サスティンレベル・リリースタイムの4つのパラメータを使って、波形の時間的な包絡線（エンベロープ）を設計する。このそれぞれのパラメータの頭文字を取って、エンベロープをADSRと呼ぶことがある。これらADSRはシンセサイザーの基本であるため、電子楽器使いなら知っておくべきである。また、\href{https://wakmin.blog.fc2.com/blog-entry-11.html}{ドラムキットにかけることで面白い効果}を得られる\cite{wakminblog}。

\item[\emphj{CC\texttt{\#}91-95 エフェクトセンドレベル}]\

エフェクトをどれくらいかけるかを設定する。エレクトーンで使うのは、CC\texttt{\#}91 リバーブ、CC\texttt{\#}93 コーラス、CC\texttt{\#}94 バリエーションである。これらはsysEX（後述）でリバーブ・コーラス・バリエーションの種類を決めておいて、CC\texttt{\#}91-95でかかり具合を調節する形で使う。リバーブの種類はレジスト全体設定になるため、XGボイスそれぞれで別々のリバーブタイプを設定することはできない\href{http://els01stylefile.music.coocan.jp/Stagea_Style/P0605.htm}{【6-5】}（スタイル入門講座へのリンク）。リバーブのデフォルトは40で、他は0。

\item[\emphj{CC\texttt{\#}98/99 NRPN（ノンレジスタードパラメータナンバー）}]\

NRPNは、GM規格によって動作が定義されていない、機器固有の命令を送信するために使われる。CC\texttt{\#}98とCC\texttt{\#}99の組み合わせで命令の種類を決定し、CC\texttt{\#}06でその値を送信する。命令の種類を指定した後は、CC\texttt{\#}06だけでその値を弄ることができる。値の調整が終わった後は、後述のRPNヌルを送信して、誤作動を防止する。エレクトーンにおいてNRPNはXGボイスのみ使われ、その動作の定義はXG仕様書に書いてある\cite{XG仕様}。

\item[\emphj{CC\texttt{\#}100/101 RPN（レジスタードパラメータナンバー）}]\

RPNはNRPNとは違い、GM規格で動作が定義されているようなチャンネル設定を行う。CC\texttt{\#}100とCC\texttt{\#}101の組み合わせで命令の種類を決定し、CC\texttt{\#}06でその値を送信する。命令の種類を指定した後は、CC\texttt{\#}06だけでその値を弄ることができる。値の調整が終わった後は、RPNヌルを送信して、誤作動を防止する。RPNの動作定義は以下の表の通り。
\begin{table}[h]
\caption{RPNの定義}
\centering
\begin{tabular}{cccc}
CC\texttt{\#}101 & CC\texttt{\#}100 & 動作 & 説明 \\
\hline
00 & 00 & ピッチベンド感度 & ピッチベンドの効きの強さを指定する。\\
00 & 01 & チャンネルファインチューン & ピッチを微量調節する。\\
00 & 02 & チャンネルコースチューン & ピッチを調節する。\\
00 & 05 & モジュレーションデプスレンジ & モジュレーションのビブラートの幅を調節する。\\
127 & 127 & RPNヌル & RPNのターゲットを指定していない状態にする。\\
\hline
\end{tabular}
\end{table}

\end{description}

\subsection{MIDIシステムメッセージ}
この節では、図\ref{figMIDImessage}の下半分にあるMIDIシステムメッセージについて解説する。

MIDIシステムメッセージは、チャンネル指定はなく、演奏情報以外の楽器全体に関わるMIDIメッセージである。\emphj{システムコモンメッセージ}と\emphj{システムリアルタイムメッセージ}、\emphj{システムエクスクルーシブメッセージ}に分けられる。

\subsubsection{システムコモンメッセージ}
sysEX（後述）の開始コードと終了コード、および複数のMIDI機器を同期させて演奏するためのメッセージ群である。少なくとも私はそこまで重要ではないと思うため、割愛する。興味のある読者はMIDI規格書を参照してほしい。

\subsubsection{システムリアルタイムメッセージ}
短いバイト数で、優先度も高く設定されており、リアルタイム性を保証するメッセージ群である。このメッセージが来ると、受信機器は現在の処理に割り込んで処理しなければならないとされている。こちらについても全ては解説せず、重要だと思う3つについて説明する。

\begin{description}
\item[\emphj{スタート}]\

エレクトーンではリズムスタートとして扱われる。

\item[\emphj{ストップ}]\

同様に、リズムストップとして扱われる。

\item[\emphj{アクティブセンシング}]\

接続ができているかの確認用の信号。演奏の途中でMIDIケーブルが抜けてしまった場合、ノートオフ命令が届かずに音が鳴り続けてしまうなどの問題が起こりうる。これを防止するために、まともなMIDI機器は接続中に常に一定の間隔でアクティブセンシングを送り続けており、受信側はアクティブセンシングが消えた段階でノートをオフしたり、リズムをストップしたりする\footnote{外部MIDI鍵盤とELS-02Cとを繋いで演奏していて、外部鍵盤を接続したELのリズムが勝手に止まるのはアクティブセンシング(と、勝手に抜けるMIDI端子)のせいである。}。
\end{description}

\subsubsection{システムエクスクルーシブメッセージ (sysEX)}
システムエクスクルーシブメッセージは\emphj{sysEX}とも書かれ、メーカーや機器ごとに特有の命令を書くためのメッセージである。GMでは\texttt{F0H}から始まり\texttt{F7H}で終わることしか定義されていない。

ELS-02シリーズのMIDIリファレンス\cite{MIDIリファレンス}を参照すれば、\emphj{エレクトーンのほぼ\footnote{ほぼ全て、の「ほぼ」について、例えばライトフットスイッチの命令がMIDIリファレンスに見当たらない。他にも操作できない操作子が存在するかもしれない。}全ての命令をsysEXで制御できる}ことがわかる。しかもエレクトーンが対応しているsysEXはこれだけではなく、\emphj{XG規格のsysEXはここに載っていないし、公表されているXG規格に載っていないXGパラメーターも存在する}\footnote{ヤマハ公式サイトから入手できるXG規格書\cite{XG仕様}は1999年のもので、ELS-01（2004年）よりも昔である。当然、01シリーズで追加されたXGのsysEXはXG規格に載っていない。しかも、ELS-01シリーズの取扱説明書にも載っていない。このため、ELSシリーズのXG規格周りは完全にブラックボックス化している。本稿を書くモチベーションは、このブラックボックスと化したXGやスタイルの周りの仕様をまとめ、分かりやすく伝えることにある。}。この膨大な種類の命令が存在するおかげで、MIDIを駆使することによってしかできないパフォーマンスが可能になる。例えば、レジストレーションメモリーを消費せずに、8つのボイス全てのエフェクトパラメータを同時に操作できたり、セカンドエクスプレッションペダルでELボイスのローパスフィルターのカット周波数を操作できたりする。

このように、sysEXをうまく活用することで表現の幅がグッと広がる。MIDIリファレンスを眺めながら、どのような工夫ができそうか考えてみてほしい。

\subsection{スタンダードMIDIファイル (SMF)}
これまでのMIDIメッセージの説明は、全てリアルタイムな演奏情報のやり取りのための約束である。これとは対照的に、\emphj{スタンダードMIDIファイル(SMF)}は、あらかじめMIDIメッセージを保存しておいて、順次送信や再生をするための規格である。

エレクトーンでMDR録音をしたファイルをパソコンで覗くと、（バルクファイル「.B00」の他に）MIDIファイル「.MID」が確認できる。この「.MID」ファイルが、SMFである。世の中に出す「きちんとした」SMFには様々な取り決めがあるが、XGサポートやスタイルファイルの製作に用いる程度にしか使わないのであれば、次の点を理解しておけば良い。
\begin{itemize}
\item SMFにはフォーマット0、1、2の3種類があり\footnote{フォーマット0は1トラックで16チャンネル分のデータを格納する。フォーマット1はトラック毎に情報を独立して持っており、マルチトラックとして編集ができるほか、1つのチャンネルに複数のトラックを対応させることができる。フォーマット2は複数の曲を1つのデータに格納できるらしいが、普及しておらず、私も全くわからない。}、XGサポートやスタイルファイルは\emphj{フォーマット0}で製作する。
\item SMFが処理できる最小の時間単位を\emphj{分解能}と呼び、この分解能の最小単位のことを\emphj{Tick}と呼ぶ。Dominoを初めとする多くのMIDIシーケンサーにおいて、一般的に分解能は1/480四分音符がよく用いられる。エレクトーンの場合、MDR録音したデータの分解能は1/480四分音符であり、リズムパターンプログラムやスタイルの分解能は1/1920四分音符である（ただし、エレクトーンがリズムパターンプログラムで表示する見掛け上の分解能は1/480四分音符である）\footnotemark 。
\item できるだけMIDIメッセージが同じタイミングに重複しないように、メッセージ間は最低1 Tickずつインターバルを空けるのが望ましい。
\end{itemize}
\footnotetext{スタイルにおけるエレクトーンの分解能が1/1920四分音符であることについて、スタイル入門講座が解説をしている\href{http://els01stylefile.music.coocan.jp/Stagea_Style/Stagea_Style_P116.htm}{【10-116】}。また、後述のEL Data Analyzerで切り出したスタイルを開いても、分解能が1/1920四分音符であることが確認できる。たとえ480でスタイルを自作しても、エレクトーン側で1920に自動的に再計算して読み込まれるため、この仕様の差について注意する必要はない。}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\clearpage

\section{XGサポート}
この節では、エレクトーンの自動演奏・演奏支援であるXGサポートを作る方法について説明する。加えて、WindowsでMIDIを扱う上で非常に頼りになるフリーソフトであるDominoの使い方も、XGサポートを作りながら解説する。

\begin{itembox}{Dominoの参考書}
\begin{itemize}

\item Domino マニュアル

Dominoに付属しているマニュアルである。最も信頼できる参考書である。

\item XG楽曲データ製作の指針\cite{XG指針}

XGデータを作成する際に気をつけるべきことがまとまっているYAMAHA製のテキスト。XGサポートを作るなら一度は目を通しておくべきであろう。

\item Dr.青山のXG解体新書\cite{Dr青}

YAMAHAの読み物。主にDTM用XG音源のフラグシップモデルであったMUシリーズの仕様について解説してある。ELS-02はMU50相当のXG音源再生能力・拡張XG音源を搭載しており、XGの基本的な使用は共通していると思われる。これを読むことができれば、XGについてさらに深い知識を得ることができる。


\end{itemize}
\end{itembox}

\subsection{XGサポートとは}
既に図\ref{figelch}で示したように、エレクトーンのMDR録音機能を使って記録することができるMIDIチャンネルメッセージは、上鍵盤(Ch.1)、下鍵盤(Ch.2)、足鍵盤(Ch.3)、上鍵盤リードボイス(Ch.4)、キーボードパーカッション(Ch.15)、コントロール(Ch.16)である。これら以外のチャンネル(Ch.5-14)は、エレクトーン単体では演奏に使うことはできないが、エレクトーンのMDR機能を使って、XGサポートデータが記録されているSMFを再生することで使うことができる。このようにして、Ch.5-14も使って自動演奏や演奏補助をすることを、本稿では\emphj{XGサポート}と呼ぶ。

なお、一般的にはXGサポートデータは\emphj{リズム付きの楽曲}の\emphj{出だしから終わりまで}を一つのSMFで作る。これは、XGサポートデータはあくまでシーケンスであり、人間の演奏の具合で動的に変更できるものではないからである。リズム無しの曲にもサポートを付けられないということはないが、製作難易度も演奏難易度も上がる。また、曲の途中からXGサポートを再生する事もできるが、MIDIの読み込みにラグがあり、MIDI再生と同時にリズムがストップするため、現実的ではない。

\subsection{Domino}
\emphj{Domino}はたかぼー氏によって製作されたWindows用MIDIシーケンサである。\href{https://takabosoft.com/domino}{公式サイト}\footnote{\url{https://takabosoft.com/domino}}から入手できる。本稿執筆時点での最新バージョンは1.44であるため、このバージョンのDominoを用いて解説を進める。他のMIDIシーケンサーでも同様のことはできるが、エレクトーン用に製作された音源定義ファイル（後述）があるため、Dominoを使うことを勧める。
\subsubsection{音源定義ファイル}

\emphj{音源定義ファイル}とは、楽器固有のプログラムチェンジやsysEXなどを手軽に扱えるようにするための、Domino専用のモジュールである。MIDIの低級な部分\footnote{ここでの「低級」は「機械語に近い」という意味である。MIDIリファレンス\cite{MIDIリファレンス}を見ればわかるように、本来的にはMIDIの制御は数字の羅列を取り扱う必要があるが、音源定義ファイルを使うことで、そのような面倒な部分を意識せずとも良くなる。}を意識することなくMIDI編集を行うことができるようになる。すずとも氏（\href{https://twitter.com/SuzuTomo2001}{@SuzuTomo2001}）と私が製作した。\href{https://www.kamekyame.com/el/domino-define}{公式サイト}\footnote{\url{https://www.kamekyame.com/el/domino-define}}からダウンロードできる。本稿ではこの音源定義ファイルを導入する。

\subsubsection{Dominoの初期設定}
\paragraph{エレクトーンとパソコンの接続}\

まず、パソコンとエレクトーンをUSBケーブルで接続する。ELS-02/02C/02X, ELC-02, ELB-02の場合\footnote{その他のエレクトーンの場合は、ヤマハ公式からUSB-MIDI Driverをインストールする必要がある。詳しくは、\href{https://yamaha.custhelp.com/app/answers/detail/a_id/10045/}{ヤマハ公式のQ\&A}\footnote{\url{https://yamaha.custhelp.com/app/answers/detail/a_id/10045/}}を参照せよ。}は、USB Type A-Bケーブル（俗にプリンタケーブルと呼ばれる）でエレクトーンの「TO HOST」端子に接続し、パソコンにエレクトーンを認識させる（図\ref{figELUSB}）。

\begin{figure}[h]
  \centering
  \includegraphics[width=8cm]{usbtypeab.png}
  \caption{エレクトーンのTO HOST端子とパソコンを接続する。エレクトーンとはUSBでMIDIをやりとりできる。画像は\href{https://yamaha.custhelp.com/app/answers/detail/a_id/1316/related/1}{ヤマハQ\&Aサイト}より引用。}
  \label{figELUSB}
\end{figure}

\paragraph{音源定義ファイルの導入}\

エレクトーンの接続が終わったら、以下の通りに音源定義ファイルを導入する。\href{https://www.kamekyame.com/el/domino-define}{音源定義ファイルの公式サイト}からダウンロードしたelectone.xmlをDominoのModuleフォルダの中に移動させ、Domino.exeをダブルクリックして起動する。Dominoのメニューから「ファイル(F)」$\rightarrow$「環境設定(E)...」を開く（もしくはF12キーを押す）。現れた環境設定ウィンドウの左側のカテゴリから「MIDI-OUT」を選択し、ポートAの音源定義ファイルを「YAMAHA」フォルダの中の「Electone」に設定すれば、導入が完了する（図\ref{figDominoSetup}）。

\begin{figure}[h]
  \centering
  \includegraphics[scale=0.5]{dominosetup_gray.png}
  \caption{DominoのMIDI-OUT環境設定の例。初期設定が終われば以降は設定する必要はない。}
  \label{figDominoSetup}
\end{figure}

\paragraph{MIDI-OUTの設定}\

同じ画面でMIDI-OUTの設定を行う。MIDI-OUTデバイスとして「ELS-02C」のようなエレクトーンが選択できるようになっているから、ポートAのMIDI-OUTデバイスをエレクトーンにしよう（図\ref{figDominoSetup}）。これにより、Dominoで入力した（ポートAの）MIDIデータはエレクトーンに送信されるようになった。もしもエレクトーンが表示されていなければ、Dominoを一旦終了して、エレクトーンとパソコンをUSBで接続してからDominoを再起動する。エレクトーンをパソコンから操作しようとするときは、\emphj{エレクトーンとパソコンをUSBで接続してからDominoを起動}しなければならないことを覚えておこう。

\paragraph{MIDI-INの設定}\

必要であればMIDI-INの設定を行う\footnote{私はノートの打ち込みは全てCubaseで行っているため、MIDI-INの設定はしていない。Cubaseで打ち込みをするには次のようにすれば良い：Cubaseで打ち込んだデータをSMFとして書き出す。Dominoを2台立ち上げ、片方はスタイルファイルやXGサポートのフォーマットを整え、もう片方でCubaseのMIDIを開く。Dominoはウィンドウ間でのコピーアンドペーストができるため、CubaseのMIDIを全選択してコピーし、もう片方のDominoに貼り付ける。}。MIDI-INの設定を行うと、エレクトーンを含むMIDIキーボードによる演奏をDominoで認識することができるようになり、打ち込みの速度が飛躍的に向上する。ただし、エレクトーンはオクターブシフトができず、特にドラムの打ち込みに難があるため、エレクトーン以外のMIDIキーボードを新しく準備することを勧める。

\paragraph{その他の設定}\

以上の他に、（必須ではないが）設定しておくと作業が捗る設定が複数存在する。本稿では\emphj{以下に示す設定を設定済みとして解説を進める}。設定しておくことを強く勧める。

\begin{itemize}
  \item メニューバーの「表示(V)」$\rightarrow$ 「トラックセレクトペイン(A)」を押し、「トラックセレクトペイン」を表示する。これを表示することにより複数のトラックの行き来がGUIで簡単に行えるようになる。
  \item 全般(1)で「時間の表し方」を「Measure:Beat:Tick」にする。イベントリストで拍が表示されるようになる。
  \item 同じく全般(1)で「オクターブ」を「Note\texttt{\#}60=C3」にする。Note\texttt{\#}60は国際式とヤマハ式でキーが違っており、このように設定するとヤマハ式にできる。
  \item 全般(2)で「マクロ番号の表示」を「表示する」に設定する。\emphj{コントロールチェンジマクロ(CCM)}\footnote{コントロールチェンジマクロ(CCM)とは、RPN/NRPNやsysEXなどの複雑な命令をコントロールチェンジ(CC)のように簡単に取り扱えるように設計されたDominoの機能である。CCは1番から127番までしか存在しないが、CCMは1300番まで使用できるようになっている。本稿ではCCM\texttt{\#}としてCCMの番号を指定する。なお、CCMは音源定義ファイルによって定義されているため、音源定義ファイルが異なれば挙動が全く違うものになる。したがって、\emphj{本稿で紹介したすずとも氏の音源定義ファイル以外を使う場合は、本稿のCCM\texttt{\#}の記述は全く役に立たない}ことに注意してほしい。}の番号が表示されるようになる。
  \item イベントリスト(1)で「コントロールチェンジイベントの番号」を「表示する」に設定する。
  \item 同じくイベントリスト(1)で「リズムノートイベントのノート番号」を「表示する」に設定する。ドラムトラックは打ち込んだノートが楽器名で表示されるが、ここにノートナンバーを付記することができる。
\end{itemize}

\subsection{XGサポートの作り方}
いよいよXGサポートデータを作っていく。この節では詳細な仕様の解説はせずに、XGサポートを作るための最小の手順を解説する。

なお、前提として\emphj{USBメモリの中にプロテクトソングは無い方が良い}\footnote{プロテクトソングは鍵付きのアイコンで表される。ヤマハ公式が配布しているソングや有料で購入したソングなどがこれに含まれる。なお、\emphj{プロテクトソングをパソコンから適当に触ってはいけない}。移動するには「ヤマハミュージックソフトダウンローダー」というソフトが必要である。今からソングをエクスプローラで細工するため、事故防止のために、プロテクトソングが1つも入っていないUSBメモリを準備した方が良い。}。また、\emphj{Windowsの設定で拡張子を表示するように変更しておかなければならない}。また、本稿の内容を実行する場合は、\emphj{本稿の内容を実行して生じる結果について、私が一切の責任を負わない}ことを認めたものとする。

\subsubsection{ファイルの作成}

曲の始めから終わりまでのソングデータ（シーケンスを含む）を完成させた後、このソングだけが入っているようなフォルダをエレクトーン上で用意する。以下ではこのフォルダを「\texttt{XGSupportFolder}」と名付けたことにする。

図\ref{figMDRrec}のように、このソングに演奏を付け足すMDR録音をする。録音待機の画面で録音するチャンネルを選択できるので、「コントロール」だけを録音するように設定し、録音を開始する。録音中にシーケンスをONにしてリズムスタートさせ、楽曲が終わるまで（演奏せずに）待つ。シーケンスが終わったら録音を停止する。

\begin{figure}[h]
  \centering
  \includegraphics[keepaspectratio,width=150mm]{figMDR.pdf}
  \caption{XGサポートの付け方。①1つのソングだけが入ったフォルダを用意し、②そのソングに録音を付け足す。③コントロールだけを録音するよう設定し（他についてはOFFまたはPLAYにする）、シーケンスを曲の終わりまで流す。}
  \label{figMDRrec}
\end{figure}

\newpage

\begin{wrapfigure}[8]{r}[3mm]{45mm}
  \centering
  \includegraphics[keepaspectratio,width=35mm]{figdirectory.pdf}
  \caption{ソング内の構造。}
  \label{figDirectory}
\end{wrapfigure}

次に先ほどの録音データが入っているUSBメモリをパソコンで開き、ソングデータを確認してみよう。図\ref{figDirectory}のように、ソングが1つだけ入っているフォルダ（\texttt{XGSupportFolder}）の中に「\texttt{ELS_SONG.NAM}」と「\texttt{SONG_001}」という名前のフォルダがある。\texttt{SONG_001}の中にある「\texttt{MDR_000.MID}」が、演奏情報が入っているSMFである。なお、「\texttt{REG_00X.B00}」(\texttt{X}は数字が入る)は\emphj{バルクファイル}といって、エレクトーンのレジストデータ\footnote{.B00ファイルにはレジストデータ、レジストシフトの順番、ユーザーボイス、オルガンフルート、シーケンス、ユーザーリズムが連結して入っている\cite{B00}。余談だが、ユーザーリズムの手前までは固定長データで、ユーザーリズムからは可変長になるため、01シリーズのユーザーリズムデータ（スタイルという）の切り出しは容易であった（スタイルは基本的にはSMFであり、SMFデータは\texttt{4DH 54H 68H 64H}から始まるため、これを探せば良い）。02シリーズになると、拡張フォーマットとしてユーザーリズムデータの後ろに固定長のデータが付く。}が入っている。ネクストレジストを使う場合は2つ以上存在する。

\subsubsection{XGサポートファイル製作の下準備}
\texttt{MDR_000.MID}にXGサポートの情報を書き加えていく前に、Dominoの基本的な使い方を確認しつつ、不必要なデータを削除していこう\footnote{基本的に、不必要なMIDIメッセージは書くべきではない。受信楽器に負担を強いることになるし、編集上邪魔になる。}。

まず、先ほどエレクトーンで作成した演奏データ「\texttt{MDR_000.MID}」をパソコンにコピーした後、Dominoにドラッグアンドドロップすることで開く。開くときに、「MIDIデータを解析してコントロールチェンジマクロを復元しますか？」と聞かれるので、「はい」を選択する。これにより、SMF(.midファイル)からDominoのプロジェクトファイル(.dmsファイル)に変換される。Dominoで編集している途中のファイルや、プロジェクトのバックアップは.dmsファイルで保存する。

読み込みが完了したら、まずメニューバーの「ファイル(F)」$\rightarrow$ 「名前をつけて保存(A)...」（または「Ctrl$+$Shift$+$S」）から、プロジェクトファイルの保存をしよう。保存された.dmsファイルを用いて、以降は編集や保存を行う。

\paragraph{バルクダンプの削除} \ 

\begin{figure}[h]
  \centering
  \includegraphics[keepaspectratio,width=150mm]{domino_gamen.png}
  \caption{Dominoの画面名称。図はDominoマニュアルから引用。}
  \label{figdominogamen}
\end{figure}


最初に［System Setup］の内容を見ていく。図\ref{figdominogamen}画面一番左にある\footnote{トラックセレクトペインが表示されていない人は、「Dominoの初期設定」の節を読み直してほしい。}「トラックセレクトペイン」から、［System Setup］をクリックしよう。すると、表示・編集するトラック（カレントトラックという）が［System Setup］になる。この［System Setup］トラックは、MIDIシステムメッセージの記述に使う。主にsysEXの記述に用いる\footnote{sysEXは動作に時間がかかるため、同一Tickに複数存在してはいけない。そのため、sysEX専用のトラックを用意して各チャンネルトラックにsysEXがばらけないようになっている。}。

［System Setup］のイベントリストを見ると、2つめのイベントとして「Ex:f0h 43h 70h 78h ...」が入っているだろう。このイベントをダブルクリックすると、1画面に表示しきれないほどの大量のメッセージで構成されていることが確認できる。これは\emphj{バルクダンプ}といって、この演奏データ「\texttt{MDR_000.MID}」がエレクトーンで呼び出された際に設定される一番最初のレジストの情報が入っている。しかし、脚注\footnote{バルクダンプデータは非常に大きいメッセージで、MIDI受信ソフトウェアによってはバッファ容量を超過するようである。実際、私がテストデータとしてエレクトーンで作ったSMFをDominoで開いたところ、バルクダンプデータが\texttt{F7H}で終わっていないように見えた。sysEXは必ず\texttt{F7H}で終わる必要があるので、Domino側で処理できていないと思われる。よって、このバルクダンプを放置するとエレクトーン側で誤作動する恐れがあるため、必ず削除しよう。参考：\url{https://wikiwiki.jp/tkbsoft/domino/%E8%A6%81%E6%9C%9B003/207}}で示すように、このデータを残すとエレクトーンが誤作動を起こす恐れがある。イベントリストでクリックして黒く選択した上で、キーボードのdeleteキーを押して\emphj{必ず削除}しよう。

その他、［1206 Bar Signal\footnote{バーシグナルは、エレクトーン本体左手のテンポ液晶の上にあるBAR/BEAT表示の赤いLEDが点灯すると送信される。}］や、［509 Rhythm Stop\footnote{［509 Rhythm Stop］はリズムが止まったときに送信される。シーケンスを組まないなら実用的（手でリズムを止めるのと同等のメッセージ）だが、シーケンスを組んでいればシーケンスの終わりで自動的にリズムが止まるため、この場合は無くても構わない。}］なども削除することができる。必要に応じて削除しよう。

\paragraph{Ch.16のメッセージの削除} \ 

必要であればCh.16のメッセージを削除する。画面左のトラックセレクトペインから、［Ch.16］を選択すると、［011 Expression］や［004 2nd Expression］が表示されているだろう。これらはエクスプレッションペダルやセカンドエクスプレッションペダルの入力の記録である。録音中にエレクトーンを操作していれば、それ以外にも様々なコントロールが記録される。XGサポートにおいて再生して欲しくないコントロールがあれば、ここを削除すると良いだろう\footnote{なお、XGサポート再生中はエレクトーンのデフォルト設定ではエクスプレッションペダルが操作できない（Ch.16に追従する）。これを操作可能にするには、エレクトーン本体液晶右側のUTILITYボタンを押し、画面上部のタブメニューよりMIDIを選択し、エクスプレッションペダルを「インターナル」に設定すれば良い。}。

\subsubsection{XGサポートデータの記述}
ここまでで下準備が終わったので、サポートデータを打ち込んでいくことができる。

\paragraph{XGモードへの変更} \ 

起動した時点ではエレクトーンは\emphj{ELモード}である。これに対し、取扱説明書には載っていないが、\emphj{XGモード}というモードもエレクトーンにはある。XGモードはDTM用音源と互換性のあるモードで、エレクトーンをXG音源装置として用いることができるようになる。外部からのXG命令を受け付けるようにするために、エレクトーンをXGモードに変更する。なお、現在のモードがどちらなのかをエレクトーン上で確認することはできない。

［System Setup］トラックを開いて、一番最初のメッセージである［1205 EL ON］をダブルクリックする。これを［205 XG System ON］に変更して、ウィンドウ左下の「テスト送信」を押してからOKを押す。これにより、エレクトーンがXGモードになった。XGモードにしておかないと、外部からXG拡張音源のプログラムチェンジを送信したときにXGボイスに変更されない。\emphj{XG音源の選択の際にはXGモードにしておく必要がある}。

XGサポートの打ち込みが終わった後は、冒頭のリセット命令を［1205 EL ON］に戻すことができる。戻した場合は、ELモードの状態で\footnote{ELモードであっても、MDR機能を使って再生している場合は、XGモードと同様にXG拡張音源が再生される。}XGサポートが再生される。ただし、
エレクトーンがELモードのとき、受信したチャンネルメッセージは表\ref{EL受信チャンネル}のように、ELボイスとXGボイスに分かれて作用する。一方、XGモードのとき、受信したチャンネルメッセージは全てXGボイスに作用する\footnote{XGモードのときも、上鍵盤の演奏は上鍵盤ボイスで再生される。2つのモードは、あくまでも外部から受信したチャンネルメッセージをどのボイスで再生するかという違いであって、たとえXGモードだとしてもXGボイスをエレクトーンの鍵盤で演奏できるようにはならない。}\footnote{XGサポートでXGボイスだけを打ち込むならばXGモードで十分だが、たとえば「Ch.1から4もMIDIを打ち込んでおいて、ELボイスを同時に鳴らしたい」という場合にELモードが有効である。}。

\begin{table}[htbp]
  \caption{モードによって受信したチャンネルメッセージが作用するボイスが異なる。}
  \label{EL受信チャンネル}
  \centering
  \begin{tabular}{c|cc}
  受信チャンネル & ELモードの場合 & XGモードの場合 \\
  \hline
  Ch.1 & 上鍵盤ボイス & XGボイス\\
  Ch.2 & 下鍵盤ボイス & XGボイス\\
  Ch.3 & 足鍵盤ボイス & XGボイス\\
  Ch.4 & リードボイス\footnotemark & XGボイス\\
  Ch.5, \dots , 14 & XGボイス & XGボイス\\
  Ch.15 & キーボードパーカッション & XGボイス\\
  Ch.16 & コントロール & XGボイス\\
  \hline
  \end{tabular}
  \end{table}
\footnotetext{エレクトーン本体の設定画面でリードボイス発音設定をエクスターナルにしたときに限り、受信したCh.4がリードボイスで再生される。}

ところで、［205 XG System ON］や、［1205 EL ON］を送信するとエレクトーンのモードが変わり、\emphj{XGボイスの設定がリセット}される。これらのモード指定がないSMFを再生すると、チャンネル設定などがその前に再生したソングのままになってしまい、意図した効果が出せない恐れがある。事故を防ぐために、\emphj{SMFの最初には必ず、モードを指定する命令を書いて、機器の初期化をしなければならない}\footnote{この初期化には時間がかかるため、本来は30 Tickほど（XG規格では50 msほどの実行時間であると説明されている\cite{XG仕様}）空白を設けて次のメッセージを書くのが良いとされる。ところがエレクトーンで生成したSMFはノータイムで次の命令が書いてあり、あるべき空白が存在しない。エレクトーンは処理能力が高いのか、もしくはセットアップ小節の内容は順次実行されるようになっており、インターバルが必要ないのかもしれない。}。

また、演奏会などでXGモードにしたまま他の人が演奏すると、例えば外部MIDIキーボードをエレクトーンに接続してELボイスを鳴らそうとしても、XGボイスが再生されてしまう。エレクトーンは基本的にELモードで使うべきであるから、XGサポートデータが終わったら［1205 EL ON］をしてELモードに戻しておこう。ELモードでXGサポートデータを再生する場合は［1205 EL ON］は必要ないが、そのような場合分けは事故の原因となりうるため、再生するモードにかかわらず、
\begin{screen}
  \centering
  {\emphj{XGサポートデータの一番最後には［1205 EL ON］を入れることを強く要請する}。}
\end{screen}


\paragraph{楽器指定（プログラムチェンジ）} \ 

次はXGサポートに用いる楽器を指定しよう。

トラックを［Ch.5］に合わせ\footnote{XGサポートをCh.5から打ち込むのは、Ch.1-4がエレクトーンの鍵盤に対応しており、ELモードの場合にELボイスが鳴るためである。XGモードで再生することが確定していれば、Ch.1から打ち込み始めても構わない。}、ピアノロール上で1小節目の3拍目をクリックし、演奏線を1:3:0\footnote{本稿ではSMFにおける時刻を「Measure:Beat:Tick」と表記することにする。1:3:0であれば、1小節目3拍目0Tickである。}に合わせる。そうしたら、メニューバーから「挿入(I)」$\rightarrow$ 「プログラムチェンジ(P)」を選択する。イベントリストに［Program Change］が挿入されるので、その文字列をダブルクリックしよう。するとプログラムチェンジを指定するウィンドウが表示される。（エレクトーンを繋いでいれば）このウィンドウで音色を選択するとエレクトーンからXGボイスが鳴るはずなので、それを聞きながら好きな音色を選択しよう。

\paragraph{その他のチャンネルセットアップ} \ 

プログラムチェンジの次はXGボイス用のチャンネルセットアップを行おう。

まず、ピアノロールを適当にクリックしよう。このときペンツールになっていた場合は、ノートが打ち込まれてしまうが、そのノートはダブルクリックで消そう。ピアノロールをクリックしたことにより、ピアノロールの演奏線上でコントロールチェンジの挿入が行われるようになった。次に画面上部の「MEAS」をクリックして演奏位置を1:3:10に指定する\footnote{今回はプログラムチェンジを1:3:0で行ったので、それより後でチャンネルセットアップを行う必要がある。そのため、今回は1:3:10でチャンネルセットアップを開始するように解説した。プログラムチェンジよりも後にチャンネルセットアップを行っていればどこで入力しても良いが、最初の発音（ノートオン）はセットアップの終わりから余裕を持ってインターバルを取るのが良い。}。そうしたらメニューバーから「挿入(I)」$\rightarrow$ 「コントロールチェンジ（複数）(G)」を選ぶ。挿入するコントロールチェンジを選択できるので、CC\texttt{\#}7, 11, 91, 93のチェックボックスにチェックを付けよう\footnote{コントロールチェンジ（複数）のウィンドウ左下にあるStepはイベント間のTick数を指定できる。デフォルトでは10 Stepとなっており、これで問題ないが、1小節目（セットアップ小節）の中に収まりきらないようであれば、間隔を詰めるために1 Stepなどに設定することができる。}。OKを押すとイベントリストに先ほど選択したCCが追加されるので、1:3:10から順番にCCが追加されていることを確認したら、追加されたCCをダブルクリックして、表\ref{tabXGchannelsetup}に示されるデフォルトの値を打ち込んでいく。

\begin{table}[htbp]
  \caption{記述が義務付けられているチャンネルセットアップのコントロールチェンジ\cite{XG指針}。}
  \label{tabXGchannelsetup}
  \centering
  \begin{tabular}{ccc}
  CC\texttt{\#} & 説明 & デフォルトの値\cite{XG仕様}\\
  \hline
  \texttt{\#}7 & Volume & 100 \\
  \texttt{\#}11 & Expression & 127 \\
  \texttt{\#}91 & Reverb Send & 40 \\
  \texttt{\#}93 & Chorus Send & 0\\
  \texttt{\#}94 & Variation Send\footnotemark & 0\\
  \hline
  \end{tabular}
\end{table}
\footnotetext{チャンネルセットアップでCC\texttt{\#}94 Variationを入力する必要があるのはバリエーションエフェクトがシステムエフェクトの場合のみである。システムエフェクトに関する解説は次の節で行う。}

指定しなかったデータはデフォルトの値で補完されるため、MIDIデータが重くならないように必要のないデータは記述しない方が良い。ただし、表\ref{tabXGchannelsetup}に示すデータは、デフォルトであっても記述することになっている\footnote{XGデータ製作指針\cite{XG指針}で示されているから説明しているが、CC\texttt{\#}7, 11, 91, 93のイベントの入力をサボった場合はデフォルトの値で補完されるようなので、自分で使うだけならこの段取りは必要ないかもしれない。}。記述することが指示されているMIDIメッセージ（表\ref{tabXGchannelsetup}）以外にも、CC\texttt{\#}10 Pan(デフォルト64)、CC\texttt{\#}74 Brightness(デフォルト64)などを入力することができる。これらのCCを使って音作りをしたい場合は、同様にセットアップで入力すると良い。デフォルト値はXGの仕様\cite{XG仕様}などで確認する。

このように、SMFにおいて1小節目は\emphj{セットアップ小節}として用いられる。原則としてノートは打ち込まず、システムセットアップやチャンネルセットアップを入力する。今回は［Ch.5］トラックだけ解説しているが、複数のチャンネルを使って打ち込みをするなら、全てのチャンネルでチャンネルセットアップを行わなくてはならない。

\paragraph{ステップ録音} \ 

いよいよノートを打ち込んでいこう。ピアノロール上でマウスでカチカチと打ち込んでもいいが、ここではMIDIキーボードを用いて行う\emphj{ステップ録音}を解説する。ステップ録音とは、一音（一和音）ずつ時間を止めながら演奏を録音することができる機能である。ゆっくりと自分のペースで演奏できるため、無駄なく正確にノートを打ち込むことができる。MIDI-INの設定をしていればエレクトーンを初めとしたMIDIキーボードを使うことができるし、そうでなくともパソコンのqwertyキーボード\footnote{ここでqwertyキーボードと呼んでいるものは、パソコンで文字などを入力するための装置である。単に「キーボード」と書くと演奏用の装置と区別がつかないため、「qwerty」を語頭に付けた。}を用いて打ち込むこともできる。

ステップ録音ウィンドウを表示するには、メニューバーの「編集(E)」$\rightarrow$ 「ステップ録音(S)」を選択するか、もしくは画面上部「MEAS」の右横にある「$\vert\vert$●」アイコンを押す。現れたステップ録音ウィンドウがアクティブなときにMIDIキーボード（もしくは、「PCキーボード」を押すと出てくる鍵盤に対応するキー）を演奏すると、ピアノロールの演奏線の位置に、ステップ録音ウィンドウで選択されている音価（Step）でノートが打ち込まれる。「PCキーボード」で打ち込んでいる場合は「Velocity」を変更することで打ち込まれるノートのベロシティを変更できるほか、「オクターブ」を変更することでオクターブシフトができる。「Gate(G)」を変更すると、指定した音価に対するゲートタイムの割合を指定できる。PCキーボードで「Ctrl + Z」を入力することでUndoできるほか（Redoは「Ctrl + Y」）、矢印キーでStepを移動させることもできる。

［System Setup］トラックを見て、［508 Rhythm Start］のイベントの時刻（おそらく2:1:0であろう）を確認しよう。そこから計算することで自分がXGサポートを打ち込みたい時刻がわかるだろう。その時刻に演奏線を移動させて、［Ch.5］にステップ録音でフレーズを打ち込もう。

なお、音価の変更にキーボードショートカットを設定しておくことを\emphj{強く推奨}する\footnote{私は楽譜製作ソフトウェアMusescoreのステップ入力と一貫性を保つように、全音符を数字「7」キーに、2分音符を数字「6」キーに、$\cdots$、32分音符を数字「2」キーに設定している。}。ステップ録音ウィンドウの「設定(C)...」からキーボードショートカットを設定できる。慣れてくればマウスを使わずに、リアルタイムで演奏するよりも早く打ち込みすることができるようになる。

\paragraph{ピアノロール} \

\emphj{ピアノロール}は縦軸にキー、横軸に拍をとった楽譜の表現の一つである。Dominoで打ち込むノートは、基本的にピアノロールかイベントリスト（後述）で編集することになる。

Domino画面左上部のペンのアイコンをクリックするか、またはメニューバーの「ツール(T)」$\rightarrow$ 「ペン(P)」からピアノロール上のマウスポインタを\emphj{ペンツール}として使用することができる。この状態でピアノロール上の空白をクリックするとノートを配置できる。配置されたノートの左端か右端をドラッグアンドドロップすることでノートを伸ばすことができる。ダブルクリックでノートを消すこともできる。ノートの配置が\emphj{クオンタイズ}\footnote{クオンタイズとは、MIDIイベントのタイミングを拍のキリのいい場所に揃える機能のことである。}されているときは、Domino画面左上のドロップダウンメニューからクオンタイズの拍を選ぶことができるほか、そのすぐ右のアイコンでクオンタイズをしないようにすることもできる。

ペンアイコンの右は\emphj{選択ツール}である。ピアノロール上でドラッグアンドドロップすると、複数のノートを範囲選択できる。選択した状態でドラッグアンドドロップすれば、移動・縮小・拡大などの操作ができる。また範囲内を右クリックすれば様々な操作が行える。

選択アイコンの右は\emphj{消しゴムツール}である。ピアノロール上で範囲選択し、その中のノートを消すことができる。

\paragraph{イベントグラフ} \ 

ステップ録音やペンツールを使ってノートの情報を打ち込んだら、次はベロシティの調節やエクスプレッションの書き込みなど、ノートではない情報の仕上げをしよう。このときに便利なのが\emphj{イベントグラフ}である。図\ref{figEventG}にベロシティの変更の例を示す。イベントグラフ上で曲線を描くと、その曲線に沿って様々なデータが指定される。

イベントグラフペイン左上で曲線の種類を選択できる。図\ref{figEventG}の例では直線を選択した。他に、フリーハンドやプリセットの曲線を選択できる。また、関数を自分で作り、オリジナルの曲線を設定することもできる。

イベントグラフペイン中央上のプルダウンメニューからは、音源定義ファイルで設定されているCCMとベロシティの中から、イベントグラフで編集するパラメータを指定できる。また、イベントグラフペインの右上には使用頻度の高いパラメータ\footnote{Domino Ver.1.44時点で、アイコンからVelocity, Pitch Bend, Modulation, Expression, Volume, Panpot, Hold, Brightness, Resonance, Master Volumeが指定できる。}がアイコンで指定できるようになっている。

なお、イベントグラフペインは最大2つまで同時に表示できる。メニューバーの「表示(V)」$\rightarrow$ 「イベントグラフペイン1/2」から表示切替が行える。
\begin{figure}[h]
  \centering
  \includegraphics[keepaspectratio,width=70mm]{figEventG.png}
  \caption{イベントグラフの使い方。ベロシティを編集するモードで直線を描くと、配置されているノートのベロシティが描いた直線に沿って指定される。}
  \label{figEventG}
\end{figure}
\clearpage

\subsubsection{XGサポートデータの保存とエレクトーンでの読み込み}
\paragraph{EL ONの配置とEnd of Trackの調節}\

全ての編集が終わったら、\emphj{最後のイベントの後に［System Setup］トラックで［1205 EL ON］を配置する}。［1205 EL ON］は全てのXG設定がリセットされるため、曲の途中で［1205 EL ON］を配置してはならない。必ず曲の最後に［1205 EL ON］を配置する。

［1205 EL ON］を配置したら、キーボードのTabキーを押すか、またはメニューバーの「表示(V)」$\rightarrow$ 「トラックリスト(L)」から\emphj{トラックリスト}を表示する。先程配置した［1205 EL ON］の次の小節に演奏線を合わせ、メニューバーの「イベント(N)」$\rightarrow$ 「End of Trackの調節(D)」を選択して、\emphj{End of Track}\footnote{End of Track とはMIDIデータにおけるトラックの最終時刻である。End of Trackの時刻で、エレクトーンはXGサポートの再生を終了する。}を設定する。これでXGサポートデータは完成である。なお、トラックリストビューから戻るには、もう一度Tabキーを押せば良い。

\paragraph{XGサポートデータの保存}\

プロジェクトファイル（.dmsファイル）はエレクトーンで読み込みできないため、SMFを書き出す必要がある。メニューバーの「ファイル(F)」$\rightarrow$ 「SMF書き出し(M)...」を選び、現れたウィンドウで保存場所と名前を指定する。このとき、\emphj{フォーマットを「format 0」にする}ことを忘れないこと。また、名前は半角アルファベットのみにすることが望ましい。ここでは、例として「\texttt{XGS.MID}」と設定したとする。

\paragraph{USBメモリへの転送とELS\_SONG.NAMの編集}\

\begin{wrapfigure}[9]{r}[3mm]{80mm}
  \centering
  \includegraphics[keepaspectratio,width=75mm]{figXGS.pdf}
  \caption{もともと存在した\texttt{MDR_000.MID}を消去し、作成したXGサポートデータを入れる。}
  \label{figXGS}
\end{wrapfigure}

作成したSMF(\texttt{XGS.MID})を、エレクトーンで録音データを作成した場所に戻す。この際、もともと存在した\texttt{MDR_000.MID}は消去する。

図\ref{figXGS}右のような構造にできたら、\texttt{SONG_001}と同じディレクトリに存在する\texttt{ELS_SONG.NAM}の拡張子を.NAMから.txtに変更する。警告が出る場合があるが、そのまま拡張子を変更しよう\footnote{ELS\_SONG.NAMの拡張子を.txtに変更しなくとも、任意のテキストエディタでこのファイルを開けば良い。ここでは、パソコンに詳しくない読者でも編集が行えるように、拡張子の変更をすることでwindows標準のテキストエディタを呼び出している。}。

拡張子の変更ができたら、\texttt{ELS_SONG.txt}をダブルクリックで開く。開くと、ソース\ref{nam}のような内容が書かれている。
\begin{lstlisting}[caption=ELS\_SONG.NAM（変更前）, label=nam]
  S00X:SONGNAME = SONG_00X 
  S00X:FOLDER = SONG_00X 
  S00X:SECURITY = OFF 
  S00X:MODEL =  
  S00X:PART_UK = OFF 
  S00X:PART_LK = OFF 
  S00X:PART_PK = OFF 
  S00X:PART_LEAD = OFF 
  S00X:PART_KBP = OFF 
  S00X:PART_CTRL = PLAY 
  S00X:PART_XG = OFF 
  S00X:MIDFILE = MDR_000.MID 
  S00X:BLKFILE_001 = REG_001.B00 
\end{lstlisting}
冒頭の\texttt{S00X}（\texttt{X}には数字が入る）は、ディレクトリ内のソングのユニークナンバーになっている。エレクトーン内ではこの番号でソングの管理を行うようである。コロンの後にパラメータの種類を指定し、その後に変数を指定する構造になっている。各パラメータの内容は以下の通り\cite{elspc}。\\

\begin{tabular}{ll}
\texttt{SONGNAME} & MDRで表示されるソング名。 \\
\texttt{FOLDER} & ソングが入っているフォルダ。　\\
\texttt{SECURITY} & レジストの保護の有無(\texttt{ON}/\texttt{OFF})。\\
\texttt{MODEL} & 演奏を想定されたモデル。\\
\texttt{PART_UK} & 上鍵盤の自動演奏の有無(\texttt{PLAY}/\texttt{OFF})。\\
\texttt{PART_LK} & 下鍵盤の自動演奏の有無(\texttt{PLAY}/\texttt{OFF})。\\
\texttt{PART_PK} & 足鍵盤の自動演奏の有無(\texttt{PLAY}/\texttt{OFF})。\\
\texttt{PART_LEAD} & リードボイス1の自動演奏の有無(\texttt{PLAY}/\texttt{OFF})。\\
\texttt{PART_KBP} & キーボードパーカッションの自動演奏の有無(\texttt{PLAY}/\texttt{OFF})。\\
\texttt{PART_CTRL} & コントロールの自動演奏の有無(\texttt{PLAY}/\texttt{OFF})。\\
\texttt{PART_XG} & XGサポートの有無(\texttt{PLAY}/\texttt{OFF})。\\
\texttt{MIDFILE} & \texttt{FOLDER}で指定したフォルダの中のXGサポートデータ。\\
\texttt{BLKFILE_001} & \texttt{FOLDER}で指定したフォルダの中のバルクファイル。\\
 & ネクストレジストを使う場合は\texttt{002}、\texttt{003}...と増えていく。
\end{tabular}
 \\

したがって、現在編集中の\texttt{ELS_SONG.txt}の中で、\texttt{PART_XG}を\texttt{OFF}から\texttt{PLAY}に、\texttt{MIDFILE}を\texttt{XGS.MID}に書き換えれば良い。参考として、書き換えた後のELS\_SONGの例を以下のソース\ref{namafter}に示す。

\begin{lstlisting}[caption=ELS\_SONG.NAM（変更後）, label=namafter]
  S00X:SONGNAME = SONG_00X 
  S00X:FOLDER = SONG_00X 
  S00X:SECURITY = OFF 
  S00X:MODEL =  
  S00X:PART_UK = OFF 
  S00X:PART_LK = OFF 
  S00X:PART_PK = OFF 
  S00X:PART_LEAD = OFF 
  S00X:PART_KBP = OFF 
  S00X:PART_CTRL = PLAY 
  S00X:PART_XG = PLAY
  S00X:MIDFILE = XGS.MID 
  S00X:BLKFILE_001 = REG_001.B00 
\end{lstlisting}

\texttt{PART_XG}と\texttt{MIDFILE}のみをソース\ref{namafter}のように書き換えたら保存し、拡張子を.txtから.NAMに戻そう。

以上で、XGサポートの製作の全工程は終了である。エレクトーンのMDRで再生して、不具合がないか確認しよう。

\subsection{XG音源特有の仕様}
以上で、XGサポートの基本的な作り方の解説は終了である。より高度なデータを作成したい読者のための情報を以下に記す。
\subsubsection{システムエフェクトとインサーションエフェクト*}
ELボイスと同じように、XGボイスにもさまざまなエフェクトをかけることができる。

ELボイスは、各ボイスにそれぞれ個別のエフェクトをかけることができた。このようなエフェクトのかけ方を\emphj{インサーションエフェクト}という。しかしXGにおいてはELボイスの場合と異なり、ボイスそれぞれに個別のエフェクト設定をするのではなく、全てのチャンネルが1系統のエフェクトブロックを介してエフェクトをかけるという形をとる。このようなエフェクトのかけ方を\emphj{システムエフェクト}という。これらの違いを図\ref{figvariation}に示す。

XGボイスにかけることができるエフェクトは、\emphj{リバーブ}、\emphj{コーラス}、\emphj{バリエーション}の3系統である。sysEXを多用してエフェクトの設定を行うため、sysEXは［System Setup］のトラックに書かなければならないことを強調しておく。
\paragraph{リバーブエフェクト} \

\emphj{XGボイスのリバーブブロックの設定はELボイスのリバーブ設定で行う}\footnote{ELボイスにおけるリバーブを思い出そう。本体パネル左上に存在するリバーブ音量を押すと、ディスプレイにリバーブ全体設定が現れる。これがエレクトーンにおけるリバーブブロックの設定である。各ボイスセクションはこのリバーブブロックへの音の送り量（センド）を指定するという操作をするのであった。このように、ELボイスにおけるリバーブは、もともとシステムエフェクトとして存在することがわかる。XGボイスにおけるリバーブは、ELボイスのリバーブブロックをそのまま使用するため、センド量を設定するだけで良い。}。したがって、リバーブエフェクトはシステムエフェクトである。

各XGボイスはCC\texttt{\#}91 Reverb Send LevelでELボイスのリバーブブロックへのセンド量を指定できる。XG仕様特有の設定は、エレクトーンでは無視されるものと思われる。

\paragraph{コーラスエフェクト} \

コーラスブロックはシステムエフェクトである。CCM\texttt{\#}425からCCM\texttt{\#}444のsysEXを用いてコーラスタイプやコーラスのパラメータ設定をして、各チャンネルでCC\texttt{\#}93 Chorus Send Levelを書いてセンド量を指定する。

\paragraph{バリエーションエフェクト} \

バリエーションブロックは\emphj{システムエフェクトとインサーションエフェクトのどちらでも使用することができる}。図\ref{figvariation}にそれぞれの場合におけるエフェクトブロックの連結の概念図を示す。バリエーションブロックはエレクトーン全体で1基のみ存在し、これをシステムとして使うのか、インサーションとして使うのかを選ぶことができる。

システムエフェクトとして使う場合、エフェクトタイプの指定(CCM\texttt{\#}450)、システムエフェクトの設定(CCM\texttt{\#}465)をこの順番で行い、続いてバリエーションリターンレベルの設定(CCM\texttt{\#}461)、バリエーションパンの設定(CCM\texttt{\#}462)、バリエーションから他のシステムエフェクトへのセンド量の設定(CCM\texttt{\#}463, 464)をする\footnote{なお、エフェクトタイプの指定を行うと、そのエフェクトのデフォルトのパラメータ設定が読み込まれ、前のエフェクト設定は捨てられるという点に注意する。エフェクトのパラメータを設定する場合はCCM\texttt{\#}451からCCM\texttt{\#}460、およびCCM\texttt{\#}474からCCM\texttt{\#}479を用いる。各パラメータが何に対応する操作なのかは、まだ解析が終わっていない。この対応を明らかにするには、例えばパソコンでsysEXをリアルタイムで表示できるようにしておいて、エレクトーンでELボイスのエフェクトパラメータを弄ったときに送信されるメッセージを解析すれば良い。}。この後、エフェクトをかけたいチャンネルのCC\texttt{\#}94 Variation Send Levelを0でない値に設定し、かけたくないチャンネルのCC\texttt{\#}94を0にする。\emphj{システムエフェクトの場合は複数のチャンネルに渡って1種類のバリエーションエフェクトをかけることができる}。

インサーションエフェクトとして使う場合、エフェクトタイプの指定(CCM\texttt{\#}450)、インサーションエフェクトの設定(CCM\texttt{\#}465)、インサートするチャンネルの指定(CCM\texttt{\#}466)を、この順番で行う必要がある。システムとして使う場合に比べて記述する命令がシンプルで簡単である。ただし、\emphj{どれか1つのチャンネルにしかインサーションエフェクトを用いることができない}点に注意する。

\begin{figure}[h]
  \centering
  \includegraphics[width=160mm]{figvariation.pdf}
  \caption{2種類のバリエーションエフェクトのかけ方。バリエーションを(a)システムエフェクトとして使う場合、(b)インサーションエフェクトとして使う場合。インサーションの場合はCC\texttt{\#}94, CCM\texttt{\#}461, 462, 463, 464は無視される。}
  \label{figvariation}
\end{figure}


\subsubsection{メガボイス}

\emphj{メガボイス}はXGボイスの中で、\emphj{人間が演奏することを想定されていない特殊な音色マッピング}がされている高品位ボイスである。打ち込む際のノートナンバーとベロシティの両方で音色が大きく変わり、1種類のボイスで多種多様な音色を出すことができる。図\ref{figmegastart}から図\ref{figmegaend}にELS-02シリーズの全メガボイスのマッピングを示す\cite{megavoice}。縦軸がベロシティ、横軸がノートナンバーに対応している。この図を見ながら実際に自分のエレクトーンでメガボイスを聞いてみると良い\footnote{メガボイスは通常のボイスと異なり、プログラムチェンジのアドレス配置が系統分けされていない（通常のボイスはCC\texttt{\#}00/32でジャンル分けがされているが、メガボイスはそうではない）。そのため、音源定義ファイルにはプログラムチェンジの選択画面に「Mega Voice」というフォルダ（Map）を設け、メガボイスをこのフォルダにまとめて配置した。}。
\begin{figure}[h]
  \centering
  \includegraphics[width=150mm]{mega_abcd.pdf}
  \caption{メガボイス、ギター類のボイスマッピング(1)。ボイス名の「Mega」は省略した。縦軸がベロシティで、横軸がノートナンバー。たとえば、Mega NylonGuitarのC4をベロシティ80で演奏すると、mute奏法が発音する。なお、(c) 12StringGtrの〜B5は2つのエレメントで構成されており、それぞれが異なるベロシティマッピングになっている。}
  \label{figmegastart}
\end{figure}

\clearpage
\vspace*{\stretch{1}}
\begin{figure}[h]
  \centering
  \includegraphics[width=150mm]{mega_efgh.pdf}
  \caption{メガボイス、ギター類のボイスマッピング(2)。}
\end{figure}
\vspace{\stretch{2}}
\clearpage
\vspace*{\stretch{1}}
\begin{figure}[h]
  \centering
  \includegraphics[width=120mm]{megabas.pdf}
  \caption{メガボイス、ベース類のボイスマッピング。}
\end{figure}
\vspace{\stretch{2}}

\vspace*{\stretch{1}}
\begin{figure}[h]
  \centering
  \includegraphics[width=130mm]{megachorus.pdf}
  \caption{メガボイス、ポップボイスのボイスマッピング。\textit{Voice}と斜体になっているところには、それぞれボイス名のスキャットが入る。(c)のベロシティ81以上のマッピングに注意。}
\end{figure}
\vspace{\stretch{2}}
\clearpage
\vspace*{\stretch{1}}
\begin{figure}[h]
  \centering
  \includegraphics[width=120mm]{megahones.pdf}
  \caption{メガボイス、ホーンズセクションのボイスマッピング。}
\end{figure}
\vspace{\stretch{2}}
\clearpage
\vspace*{\stretch{1}}
\begin{figure}[h]
  \centering
  \includegraphics[width=120mm]{megastrings.pdf}
  \caption{メガボイス、クワイアとストリングスのボイスマッピング。}
  \label{figmegaend}
\end{figure}
\vspace{\stretch{2}}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\clearpage
\section{スタイルファイルの作り方（メイン/アドドラムのみ）}
\begin{itembox}{スタイルファイルフォーマットの参考書}
\begin{itemize}
\item スタイル入門講座\cite{スタイル}

エレクトーンに合わせてスタイルの解説を行っており、スタイルに関して日本でトップクラスの情報量を持つサイト。参考にしたページには、【章-ページ番号】でリンクを貼る。

\item Style Files - Description\cite{style}

スタイルファイルに関して一番詳しく解説されていると思う。英語だが、非常にわかりやすい。細かい仕様に関する情報はこちらで勉強できる。

\item YAMAHA Keyboard - Style CASM Section Format\cite{CASMeditor}

CASMセクションを編集することができるフリーソフトであるCASM Editorの作者、Jørgen Sørensen氏によるCASMセクションの解説。端的にまとまっている。

\item ヤマハ PSR-SX600 Refernce Manual\cite{PSR}

スタイルファイルフォーマット準拠の楽器であり、エレクトーンには存在しないスタイルクリエイターを搭載しているポータトーンの取扱説明書。第2章がスタイルの解説になっている。図表が多くわかりやすい。
\end{itemize}
\end{itembox}

\subsection{スタイル}
ヤマハは自動伴奏のことを\emphj{スタイル}と呼んでいる。スタイルはリズムだけを鳴らしたり、ベースやコードバッキングなどの伴奏パートをリズムと一緒に鳴らしたりするのに使う\cite{cvp}。ELS-02シリーズの場合、「スタイル」という名前は表に出てこないが、「リズム」というパネルで操作するものがそれにあたる\href{http://els01stylefile.music.coocan.jp/Stagea_Style/P0101.htm}{【1-1】}。

エレクトーンの場合、本体画面右側中央の「リズムパターンプログラム」ボタンでスタイルを編集するが、メインドラム・アドドラムの2チャンネル分の編集と、「ロワーリズミック」（後述）のみの編集となっており、スタイルの自由な編集は行うことができない。しかし、ヤマハはスタイルを\emphj{SFF（スタイルファイルフォーマット）}という体系で製作しているため、ヤマハの電子楽器どうしはスタイルに互換性があり、エレクトーンにも他楽器のスタイルを読み込むための機能がある。実際にポータトーンやTyrosなどのヤマハ製キーボードにはスタイルクリエイターが内蔵されており、これで製作した（アカンパニメント付きの）スタイルをエレクトーンに読み込むことができる。本稿ではこの仕様を利用し、スタイルクリエイターがない環境において、パソコンで自作したスタイルファイルをエレクトーンに読み込ませる。

スタイルを自作するといっても、エレクトーン本体にリズムパターンプログラムは搭載されているため、パソコンで製作することに何の意味があるのか疑問に思うかもしれない。しかし、エレクトーン本体で弄ることができるスタイルの設定はごくごく限られており、スタイルの仕様をうまく利用することで、非常に強力な表現の手段を得ることができる。以下に例を示す。
\begin{itemize}
\item パソコン上のピアノロールでドラムを編集でき、細かい打ち込みを快適に行える。
\item アカンパニメントの自作ができるようになる。
\item 変拍子を製作できる。
\item メインドラム・アドドラムにXGサポートのような自動演奏を仕込むことができる。
\end{itemize}
アカンパニメントがないユーザーリズムを作ることにおいてもスタイルファイルの活用は大いに役立つ。ぜひ自分の手でスタイルファイルを編集して、スタイルの知識を身につけて欲しい。

なお、スタイルファイルの仕様は公式には未公開であり、紹介する情報は有志の方々の先行研究によるものが多い。本稿の内容を利用するときは、あくまでも自己責任で実行すること。

\subsection{スタイルファイルの構造}
スタイルファイルにはMIDI情報を書き込む\emphj{MIDIセクション}と、自動伴奏の規則のための\emphj{CASMセクション}という2つのセクションがある\cite{style}。なお、セクションという用語はエレクトーンではMain A、Main Bなどの再生箇所を指定するが、本稿では「セクション」が意味する語が多いため、エレクトーンにおけるMain Aなどのセクションを「\emphj{セクションパターン}」と呼び、スタイルファイルの構造であるMIDIセクション、CASMセクションと明確に区別する\footnote{なお、本稿でセクションパターンと呼ぶものは、データ上はCSEGと記述されており\cite{style}、チャンネルセグメントの略であると思われる。}。

スタイルの構成にCASMセクションは必要不可欠である。しかし、CASMセクションは複雑で、初学者には少々ハードルが高い。本来的には、MIDIセクションとCASMセクションの両方を記述してスタイルファイルを作る必要があるのだが、エレクトーンの場合は\emphj{条件付きで}\footnote{CASMセクションが無いスタイルをエレクトーンに読み込んだ場合、エレクトーンのデフォルトのCASMセクションが、読み込まれたスタイルファイルに結合される。従って、このデフォルトCASMセクションに沿って製作していれば、自分でCASMセクションを書く必要がない。次章にてアカンパニメントと併せて詳しく解説する。}CASMセクションの記述の必要がない。そこで\emphj{本章では、スタイルファイルの作り方の流れを理解するために、CASMセクションを編集せずに作ることができるスタイルファイル（メインドラム・アドドラムのみの作成方法）を紹介する}。

MIDIセクションは、1小節目のセットアップ小節と、2小節目以降のMain A, B,\dots などのセクションパターン小節の2つに分かれていて、セクションパターン小節は\emphj{マーカー}\footnote{マーカーは、任意のTick数に任意の文字列を挿入することができるSMFの機能である。Dominoであればメニューバーの「マーク(M)」$\rightarrow$ 「マークの挿入(A)...」を選ぶか、Ctrl + Mでマーカーを挿入できる。}によってさらに各セクションパターンに分割される。図\ref{figmarker}にセクションパターンの分割の一例を示す。
\begin{figure}[h]
  \centering
  \includegraphics[keepaspectratio,width=150mm]{midimarker.pdf}
  \caption{MIDIセクションの構造の例。各セクションパターンはマーカーによって分割される。例えば、Main AをMIDIセクションの2小節目から8小節間作り、その後Main Bに移る場合は、2小節目の頭に「\texttt{Main A}」と書き、10小節目の頭に「\texttt{Main B}」と書く。これにより、2小節目から10小節目がMain Aとして指定される。}
  \label{figmarker}
\end{figure}

各セクションパターンがエレクトーンで呼び出されるたびに、チャンネルセットアップがセットアップ小節の命令で初期化される。セットアップ小節にはそのスタイルファイルで一貫している命令を書くのが良い。

なお、MIDIセクションの時刻1:1:0には\texttt{SFF1}と\texttt{SInt}という2つのマーカーが記述されている\footnote{\texttt{SFF1}はスタイルファイルフォーマット1ということを示すと思われる。Tyrosなどの新しいSFF楽器においてはSFF2が採用されていることがわかっている\cite{style}。}。これらはスタイルファイルの仕様上必要である。

\subsection{アドドラム・メインドラムの作り方}
いよいよ、スタイルファイルの作り方を紹介していく。まずはザッと一読して流れを掴んでから、その後にゆっくりと手を動かしながら実践するのが良い。以降、\href{https://www.kamekyame.com/el/domino-define}{エレクトーン用音源定義ファイル v1.6.0}を導入しているものとして解説する。

\subsubsection{拍子の指定と\texttt{Main A}マーカーの挿入}
MIDIセクションの編集で、最初に行わなくてはならないのは\emphj{拍子の指定}である。［Conductor］トラックを表示し、イベントリストの拍子指定を、作成したいスタイルの拍子に合わせて変更しよう（4/4拍子の場合は変更の必要はない）。

4/4拍子以外の拍子にした場合は、2小節目の開始時刻がデフォルトデータからズレる。そのため、デフォルトで入っていた「\texttt{Main A}」マーカーが使用できなくなるので、このマーカーを削除し、自分で演奏線を2:1:0に合わせてから「Ctrl$+$M」で「\texttt{Main A}」を挿入しよう。拍子の変更をしなかった場合は、この作業は必要なく、デフォルトで入っている「\texttt{Main A}」マーカーをそのまま使用できる。

\subsubsection{システムセットアップ*}
\begin{figure}[h]
  \centering
  \includegraphics[keepaspectratio,scale=1]{systemsetup.png}
  \caption{デフォルトの［System Setup］トラックの中身。}
  \label{figdsystem}
\end{figure}
次に、［System Setup］トラックを選択してシステムセットアップの設定を確認しよう。システムセットアップでは主に、\emphj{バリエーションエフェクトの設定}と\emphj{ドラムセットアップの設定}をすることができる。これらを設定しないのであれば、\emphj{この節をスキップして、音源定義ファイルのデフォルトのままスタイルファイルを製作することができる}。

デフォルトでは図\ref{figdsystem}のように、［205 XG System On］、［1207 Part Mode］、［465 Variation Connection］、［450 Variation Type］を書いておいた。以下でこれらの命令を一つずつ説明する。
\begin{description}
\item[\emphj{［205 XG System On］}]\

エレクトーンをXGモードに変更する命令。

\item[\emphj{［1207 Part Mode］}]\

指定したチャンネルを\emphj{ドラムトラック}として使用するという命令。これを設定することにより、ドラムトラック特有の特殊な設定である\emphj{ドラムセットアップ}が使用できるようになる。音源定義ファイルのデフォルトでは、Ch.10をメインドラム（DrumS1）に、Ch.9をアドドラム（DrumS2）に設定してある。

\item[\emphj{［465 Variation Connection］}]\

バリエーションエフェクトをシステムで使うか、インサーションで使うかを指定する命令。バリエーションエフェクトについては前章を参照してほしい。スタイルは仕様上\emphj{バリエーションエフェクトは必ずシステムエフェクトとして使用することになっている}。そのため、ここでシステムエフェクトとして使うという命令を記述した。

\item[\emphj{［450 Variation Type］}]\

バリエーションエフェクトのエフェクトタイプの指定をする命令。デフォルトではディストーションを指定した。他のエフェクトを使用したい場合はここを変更すると良い。
\end{description}

なお、\emphj{システムセットアップは1小節目でのみ行うことができる}。そのため、例えばMain AとMain Bで異なるドラムセットアップをすることはできない。ドラムセットアップを変更する場合は別のスタイルファイルを作成し、エレクトーンに読み込むときには異なるユーザーリズムとして保存することになる。

\subsubsection{チャンネルセットアップ}
\begin{figure}[h]
  \centering
  \includegraphics[keepaspectratio,scale=1]{dominoch.png}
  \caption{デフォルトのドラムトラックの中身。}
  \label{figtrack}
\end{figure}

次に、メインドラム・アドドラムの楽器指定などを行おう。メインドラムもアドドラムも作業は同じであるため、ここではメインドラムの解説のみ行う。

トラックセレクトペインから［Main Drums］\footnote{［Main Drums］トラックはCh.10であり、基本的には\footnotemark メインドラムとして使用できる。}\footnotetext{CASMセクションを編集する場合は、Ch.10であってもメインドラム以外に指定できる。詳細はCASMセクションのIn/Out Channelで解説する。}を選ぶ。そうすると、図\ref{figtrack}のように、このトラックに書かれているデフォルトのチャンネルセットアップが確認できる。デフォルトではプログラムチェンジがスタンダードキットになっているが、他のドラムキットを選びたい場合は「PC:Standard Kit 1」をダブルクリックすることで変更できる。この時、「ドラムセットリスト」から選べば、通常のエレクトーンのドラムセットを選択できる。さらに、図\ref{figneiro}のように「音色リスト」から選べば\emphj{全てのXGボイス}の中からドラムの音色を選択できる。これにより、メインドラムやアドドラムを\emphj{XGサポートのような完全自動演奏として}活用できる。

\begin{figure}[h]
  \centering
  \includegraphics[keepaspectratio,width=100mm]{neiro.png}
  \caption{プログラムチェンジを変更するウィンドウ。ドラムトラックであっても、全てのXG音源音色リストから音色を選択することができる。}
  \label{figneiro}
\end{figure}

また、他のチャンネルセットアップも変更できる。XGサポートを製作する時と同様に、チャンネルセットアップを書き足したり、値を変更したりできる。なお、1小節目に書いたチャンネルセットアップは、全てのセクションパターンで共通になる。

\subsubsection{ノートの打ち込みとMain A以降}
上記のチャンネルセットアップをアドドラムにも行ったら、セットアップ小節で行うべき設定は終了である。続いて、メインドラムとアドドラムにMain Aのドラムを打ち込もう。コントロールチェンジの多くはセクションパターン小節でも使える\footnote{セクションパターン小節では、sysEX（やNRPN, RPN）による制御はできない。}ため、CCを使っていろいろな効果を試してみるのも面白い。

ノートの打ち込みが完了したら、最後のノートが置かれた場所の、次の小節の頭に演奏線を合わせよう。スタイルファイルにMain Aしか書かないのであれば、ここにEnd of Trackを設定する\footnote{End of Trackについての解説は、XGサポートの作り方にある。}。Main A以降も作る場合は、次に作りたいセクションパターンのマーカー（表\ref{marker}参照）を設置することになる。空白は半角で、大文字・小文字に注意して入力しよう。これらのセクションパターンはスタイルファイルにどのような順番で書いても構わないし、使わないセクションパターンについてはマーカーを設置する必要もない\footnote{マーカーを使わなかったセクションパターンは、ノートが何も置かれていない状態としてエレクトーン内で補完される。}。

\begin{table}[h]
\caption{セクションパターンを指定するマーカー一覧。\texttt{Fill In BA}はBREAK。}
\label{marker}
\centering
\begin{tabular}{|c|c|c|c|c|}
\hline
\texttt{Main A} & \texttt{Fill In AA} & \texttt{Intro A} & \texttt{Ending A} & \texttt{Fill In BA} \\
\texttt{Main B} & \texttt{Fill In BB} & \texttt{Intro B} & \texttt{Ending B} & \\
\texttt{Main C} & \texttt{Fill In CC} & \texttt{Intro C} & \texttt{Ending C} & \\
\texttt{Main D} & \texttt{Fill In DD} & & & \\
\hline
\end{tabular}
\end{table}

なお、エレクトーン上で編集する時と同じように、\texttt{Fill In}は1小節しか扱うことができない\footnote{\texttt{Fill In}に2小節以上書いても、最初の1小節だけ読み込まれて以降の小節は無視される。}。他のセクションパターンについては小節数の制限は無いが、エレクトーンのメモリが一杯になったら読み込めなくなるため\href{http://els01stylefile.music.coocan.jp/Stagea_Style/Stagea_Style_P1003.htm}{【10-3】}、極端に大きなサイズのセクションパターンは作るべきではない。大きくとも64小節程度に収まるように分割しよう。

最後のセクションパターンまで打ち込みが終わったら、最後のノートの次の小節の頭に、End of Trackを忘れずに配置する。これで、メインドラムとアドドラムのみのスタイル（のMIDIセクション）を打ち込むことができた。

\subsubsection{スタイルファイルの保存とエレクトーンでの読み込み}
メイン/アドドラムを打ち込んで、End of Trackも設定し終えたら、このファイルをSMFとして書き出す。XGサポートの時と同様に、メニューバーの「ファイル(F)」$\rightarrow$ 「SMF書き出し(M)...」から書き出そう。このとき、\emphj{「Format 0」としてSMF書き出しする}ことに注意すること。

書き出しが終わったら、書き出されたファイルの拡張子を変更する。SMFの拡張子は「.MID」だが、SFFの拡張子は「.sty」であるため、拡張子を「.sty」としておこう。これで、エレクトーンに読み込ませるファイルの準備ができた。本来であればこの後にCASMセクションの編集を行うのだが、CASMセクションが無くとも自動的にエレクトーンで補完されるため、このままエレクトーンに読み込むことができる。

最後にこのファイルをエレクトーンで読み込もう。準備ができたスタイルファイルをUSBメモリにコピーし、エレクトーンに挿す。あとは取扱説明書\cite{取説}166ページの通りに読み込めば良い。エレクトーンのリズムパターンプログラム画面の「ファイル」タブから、USBメモリに入っているパターンファイルを選択して読み込む。読み込んだだけでは保存されないため、「保存」タブから任意のユーザーリズムに保存しよう。以上でエレクトーンへの読み込みは終了である。作成したスタイルを再生し、意図通りに再生できるかチェックしよう。

\subsection{ドラムセットアップの解説}
ドラムはXGの仕様により\emphj{ドラムセットアップ}と呼ばれる特殊なエディットが可能である。ドラムセットアップを使用することで、ドラム全体の調節のみならず、\emphj{キーに割り当てられている楽器ごとに音色をエディットする}ことができる。ドラムセットアップに関する説明をエレクトーン奏者向けにしている資料が見当たらなかったため紹介するが、エレクトーンで操作できるセットアップはエレクトーンで操作した方が、バランスをとりながら編集できて良いと考えているため、必要ないと思ったら飛ばして構わない。しかし、エレクトーンから触ることができないパラメータも多い。

ドラムセットアップを使うためには、特定のトラックを\emphj{ドラムトラック}として設定する必要がある。［CCM\texttt{\#}1207 Part Mode］で指定トラックをドラムトラックにできる\footnote{なお、2000年のXG仕様書v1.35\cite{XG仕様}ではXG音源最高位モデルではドラムトラックは最大4まで使用できる。エレクトーンで2系統以上のドラムトラックが使用できるかは不明だが、おそらくできないと思われる。}。音源定義ファイルのデフォルトデータではCh.10をメインドラム（DrumS1）、Ch.9をアドドラム（DrumS2）として設定しておいた。

ドラム音源のエディットはNRPNによるものとsysEXによるものとがある\footnote{MIDIの一般的な約束として、sysEXとNRPNのどちらでも同じ効果が得られる場合、できるだけNRPNを使用することになっている。そのため本来は、NRPNで設定しきれない場合のみsysEXを用いるのが良いと思うのだが、エレクトーンで作成したスタイルでは、NRPNで操作できるはずのドラムセットアップパラメータであっても、全てsysEXで記述されている。理由は不明。}。設定できる項目が多いため、節を分けてNRPNとsysEXを別々に解説する。なお、\emphj{どちらのドラムセットアップを使うにせよ、ドラムセットアップの命令は1小節目に書く必要がある（2小節目以降は無視される）}。

エレクトーンでリズムパターンプログラムを使用してスタイルを製作する場合のキーの割り当てと、対応するノートナンバーを図\ref{fignotenumber}に示す。例えば、多くのキットでC1はキックドラムに割り当てられており、これを指定するにはノートナンバーを36とすれば良い。
\begin{figure}[h]
  \centering
  \includegraphics[keepaspectratio,width=150mm]{notenumber.pdf}
  \caption{リズムパターンプログラムで操作する場合に、エレクトーンのキーの音名割り当てと、それにより打ち込まれるノートのノートナンバー。}
  \label{fignotenumber}
\end{figure}

\subsubsection{ドラムセットアップ (NRPN)*}
以下、NRPNで設定できるドラムセットアップパラメータについて解説する。NRPNはCCの一つで、チャンネルメッセージであるため、［System Setup］トラックではなく各ドラムトラックに記述することに注意。ここでは音源定義ファイルを使っている場合に合わせて、CCM\texttt{\#}を付記する。また、その場合はDominoで打ち込むときのGateがノートナンバーに対応する。

例えば、メインドラムのC1 キックのボリュームを調節したい場合には、［Main Drums］（Ch.10）のチャンネルセットアップに［CCM\texttt{\#}174 Drum Level］を追加し、Valueとして音量を、Gateとして36を指定する。

\begin{description}
\item[\emphj{CCM\texttt{\#}168 Drum Filter Cutoff Frequency}] \,\\
ローパスフィルターのカットオフ周波数。下げれば高音成分が減る。

\item[\emphj{CCM\texttt{\#}169 Drum Filter Resonance}]  \,\\
カットオフ周波数周りのレゾナンスをつける。

\item[\emphj{CCM\texttt{\#}170 Drum EG Attack Rate}] \,\\
アタックタイムを増減する。減らすとアタックが遅くなり、増やすと早くなる。

\item[\emphj{CCM\texttt{\#}171 Drum EG Decay Rate}] \,\\
ディケイタイムを増減する。減らすとディケイが遅くなり、増やすと早くなる。

\item[\emphj{CCM\texttt{\#}172 Drum Pitch Coarse}]\,\\
ピッチを半音単位で調節できる。

\item[\emphj{CCM\texttt{\#}173 Drum Pitch Fine}]\,\\
ピッチを100分の1半音単位で調節できる。

\item[\emphj{CCM\texttt{\#}174 Drum Level}] \,\\
音量を調節できる。

\item[\emphj{CCM\texttt{\#}175 Drum Pan}] \,\\
パンを調節できる。Valueを-64にするとパンをランダムに振れる。

\item[\emphj{CCM\texttt{\#}176 Drum Reverb Send Level}]\,\\ 
CC\texttt{\#}91 リバーブを最大値として、そこにどの程度の量をセンドするかを決める。デフォルトはノートによって違う。

\item[\emphj{CCM\texttt{\#}177 Drum Chorus Send Level}] \,\\
CC\texttt{\#}93 コーラスを最大値として、そこにどの程度の量をセンドするかを決める。デフォルトはノートによって違う。

\item[\emphj{CCM\texttt{\#}178 Drum Variation Send Level}] \,\\
CC\texttt{\#}95 バリエーションを最大値として、そこにどの程度の量をセンドするかを決める。デフォルトは基本的に127。

%\item[\emphj{CCM\texttt{\#}179 Drum HPF Cutoff Frequency}] CC\texttt{\#}99$=$36, CC\texttt{\#}06 : 0-64-127

%ハイパスフィルターのカットオフ周波数。上げれば低音成分が減る。

%\item[\emphj{Drum EQ BASS}] CC\texttt{\#}99$=$48, CC\texttt{\#}06 : 0-64-127
%\item[\emphj{Drum EQ TREBLE}] CC\texttt{\#}99$=$49, CC\texttt{\#}06 : 0-64-127
%\item[\emphj{Drum EQ BASS Frequency}] CC\texttt{\#}99$=$52, CC\texttt{\#}06 : 4(32Hz)-40(2kHz)
%\item[\emphj{Drum EQ TREBLE Frequency}] CC\texttt{\#}99$=$53, CC\texttt{\#}06 : 28(500Hz)-58(16kHz)

%イコライザーをかけることができる。EQフリケンシーの挙動についてはXG仕様書\cite{XG仕様}のXG EFFECT PARAMETER TABLE (P38)を見よ。
\end{description}

\subsubsection{ドラムセットアップ (sysEX)*}

ドラムセットアップの命令はsyxEXにも存在する。重複を除けば、NRPNよりも特殊で限定的な命令が多い。

以下にsysEXで指定できるドラムセットアップ命令を列挙する。ただし、NRPNで設定できる項目については省略する。NRPNと同様にCCMが存在するため、音源定義ファイルを使う場合に合わせてCCM\texttt{\#}を付記する。NRPNの場合と同様にDominoで打ち込む場合はGateがノートナンバーに対応する。

例えば、メインドラムのC\#2 クラッシュシンバルでシンバルミュート奏法を再現したい場合は、［System Setup］トラックの1小節目に［CCM\texttt{\#}909 Drum Rcv Note Off］を追加し、Valueとして1を、GateとしてD1-49を指定する。

\begin{description}

\item[\emphj{CCM\texttt{\#}903 ALTERNATE GROUP}]\,\\
ALTERNATE GROUPが同じであるような複数のノートは同時に発音できないようになる。ハイハットのオープンとクローズのように、片方が鳴ったときにもう片方をミュートしたいときなどに使う。デフォルトのALTERNATE GROUPを知りたい場合はXG仕様書\cite{XG仕様}を参考にするしかないが、後発のエレクトーンのドラムキットが載っていないので、もしALTERNATE GROUPを操作するのならば自分で調査するしかない。通常のノートはALTERNATE GROUPはオフになっている。

\item[\emphj{CCM\texttt{\#}908 KEY ASSIGN}]\,\\
\emphj{この命令は、筆者の実験においては、エレクトーンで使うことができなかった}\footnote{XG仕様書\cite{XG仕様}によると、KEY ASSIGNはオプショナルではないはずなので、エレクトーンでも設定変更ができると考えられる。成功した方は連絡をください。}。以下の説明はKEY ASSIGNの一般的な説明である。もしKEY ASSIGNを使いたいのであれば、代わりにRcv NOTE OFFをONにして、打ち込みの段階でゲートタイムを調節して打ち込めば良い。

\textcolor{gray}{ドラムに限らないXG音源の仕様として、前の音が減衰している間に次の音のノートオンが来たとき、前の音をミュートする（シングル）か減衰を続けるか（マルチ）を選ぶことができ、それはXG MULTI PARTの設定のSAME NOTE NUMBER KEY ON ASSIGN(CCM\texttt{\#}606)という命令で制御できるようになっている。XGのデフォルトでは全ての音が減衰を続けるSAME NOTE NUMBER KEY ON ASSIGN$=$MULTIに設定されているが、ドラムパートに関してはノートごとに設定を変更することができるようになっており、その場合はSAME NOTE NUMBER KEY ON ASSIGN$=$INSTとした上で、KEY ASSIGNを使って各ノートの設定をすることになる。}

\item[\emphj{CCM\texttt{\#}909 Rcv NOTE OFF}]\,\\
ノートオフを無視するかどうかの設定。RcvはReceiveのこと。クラッシュシンバルなどの自然な減衰に任せて消音する楽器はノートオフを無視して鳴り続けるが、サンバホイッスルなどは鳴り続ける時間（ゲートタイム）を自分で設定でき、ノートオフで消音する。クラッシュシンバルなどをONにすることで、自分の好きなタイミングで消音させることができる。\emphj{シンバルミュートがないエレクトーンにおいて、非常に実用的な命令。}

\item[\emphj{CCM\texttt{\#}910 Rcv NOTE ON}] \,\\
ノートオンを無視するかどうかの設定。これがONのとき、ノートは鳴らない。デフォルトでは全てOFF。

\item[\emphj{CCM\texttt{\#}914 EG DECAY1}] 
\item[\emphj{CCM\texttt{\#}915 EG DECAY2}] \,\\
XGボイスにはディケイタイムが2種類存在するものがある。NRPNによる設定ではその2つを同時に変化させるが、このsysEXを使うことで別々に設定できる。

%\item[\emphj{VELOCITY PITCH SENSE}] \textcolor{gray}{\texttt{xxH}$=$\texttt{60H}, \texttt{mmH} : \texttt{30H}-\texttt{40H}-\texttt{50H} (48-64-80)}

%\item[\emphj{VELOCITY LPF CUTOFF SENSE}] \textcolor{gray}{\texttt{xxH}$=$\texttt{61H}, \texttt{mmH} : \texttt{30H}-\texttt{40H}-\texttt{50H} (48-64-80)}

%これら2つに関してはエレクトーンで使うことができないと思われる。もしくは使用可能かどうかがキットに依存する。ベロシティに追従してピッチやカットオフ周波数を動かすことができる。

\end{description}

\clearpage
\section{メモ}
以下草稿です。情報の寄せ集めに過ぎません。
\clearpage
\section{アカンパニメントを含めたスタイルファイルの作り方}
\subsection{自動伴奏の種類}
スタイルの自動伴奏はアカンパニメントとオートベースコードという2つの仕組みで構成されている。スタイルファイルフォーマットではないが、エレクトーンにはロワーリズミックという自動伴奏も存在する。
\subsubsection{アカンパニメント}
\emphj{アカンパニメント}はスタイルの自動伴奏のうち、判定されたコードに対し自動で演奏される「コード1/2」、「パッド」、「フレーズ1/2」の5つを指す。

\subsubsection{オートベースコード(A.B.C.)}
\emphj{オートベースコード}はアカンパニメントにおけるコードの判定方法を指定し、加えてベースの自動伴奏の有無も指定する。

エレクトーンのオートベースコードには、以下の4種類のモードがある\href{http://els01stylefile.music.coocan.jp/Stagea_Style/P1695.htm}{【16-95】}。

\begin{description}
  \item[\emphj{シングルフィンガー}]\
  
  下鍵盤を1-3音抑えるだけでコードを判定する。ベースの自動演奏をする。

  \item[\emphj{フィンガードコード}]\
  
  下鍵盤のみでコードの判定を行う。ベースの自動演奏をする。

  \item[\emphj{カスタムA.B.C.}]\
  
  下鍵盤と足鍵盤の両方でコードをの判定する。ベースの自動演奏をする。

  \item[\emphj{A.B.C.なし}]\
  
  下鍵盤のみでコードの判定を行う。ベースの自動演奏をしない。
\end{description}
エレクトーン演奏に慣れているプレイヤーであれば、普通はカスタムA.B.C.を採用する。

\subsubsection{ロワーリズミック}
\emphj{ロワーリズミック}はリズムパターンプログラムで作ることができるアカンパニメントの1つで、下鍵盤で演奏しているノートをオリジナルのリズムで連打させることができる機能である。ロワーリズミックもアカンパニメントではあるのだが、コードの判定をしてフレーズを構成するなどの自動演奏は行われない。コード1/2のチャンネルを利用して発音するが、スタイルファイルフォーマットにはこれを制御する命令は存在せず\footnote{ロワーリズミック用のチャンネルパラメータはCtabではなくCrmcという別の枠組みで処理する\href{http://els01stylefile.music.coocan.jp/Stagea_Style/P1909.htm}{【19-9】}。}、エレクトーン内でのみロワーリズミックの指定が可能である\footnote{DominoなどのMIDIシーケンサーを使ってロワーリズミックパターンを作りたい場合、コードパートにドなどの単音をロワーリズミックの音価で打ち込んでおいて、エレクトーンに読み込ませる。ただしこのとき、打ち込んだ単音はスタイルとしてのコードで打ち込まれているため、エレクトーンでどのように演奏しても単音としてしか鳴らない。これをロワーリズミックにするため、エレクトーンのリズムパターンプログラム上でコードパートを少しだけ編集する。そうしてから保存すれば、ロワーリズミックとして保存される。}\href{http://els01stylefile.music.coocan.jp/Stagea_Style/P1909.htm}{【19-9】}。また、エレクトーンに初めから入っているリズムにロワーリズミックを使ったものは存在しない\href{http://els01stylefile.music.coocan.jp/Stagea_Style/P1902.htm}{【19-2】}。本稿ではロワーリズミックについてこれ以上の解説はせず、他の自動伴奏について解説する。

\subsection{EL Data Analyzerについて}
\emphj{EL Data Analyzer}とは、東北大学エレクトーンサークルMUSICAのOBである岩田駿人氏によって作成された、エレクトーンで作成されたスタイルファイルをパソコン上に取り出すソフトウェアである。\url{https://dummy}からダウンロードできる。以下のようにして使う。
\begin{enumerate}
  \item エレクトーンでユーザーリズムを作成する。
  \item ユーザーリズムが入っているレジストデータ（.B00ファイル）を読み込む（ドラッグアンドドロップで良い）。
  \item 取り出したいユーザーリズムを選択し（もしくは空でないユーザーリズムを全て）、任意のフォルダに取り出す。
\end{enumerate}
自作のスタイルはもちろん、エレクトーン内にもとから入っているスタイルに関しても、一度ユーザーリズムに保存することで取り出すことができ、スタイルがどのような構造を持っているかの勉強に役立つ。以降、スタイルの仕様に関する説明をするので、エレクトーン内のスタイルや、エレクトーン上で自作したスタイルなどをEL Data Analyzerを使ってパソコン上に取り込んで、拡張子を.styから.midに変更してからDominoで開くと良い。ただし、このようにして取り出したスタイルの配布はしてはいけない。

\subsection{MIDIセクション}
MIDIセクションは伴奏のMIDIメッセージを記述するセクションである。基本的にはフォーマット0のSMFであるため、これを編集するには前節で紹介したDominoなどを用いる。

スタイルはコードを判定してMIDIセクションの自動伴奏を適切に読み換えるのだが、それではMIDIセクションの元々のMIDIパターンでは何を書いておけば良いのだろうか？MIDIセクションで置いたノートがどのコードを基準にしているかはCASMセクションで設定するのだが、面倒な設定抜きで、とりあえず矛盾なく演奏できるものを作りたいのなら\emphj{自動伴奏には$\textrm{C}_{\textrm{M7}}$の構成音を書く}ことになる\footnote{$\textrm{C}_{\textrm{M7}}$はコードネームであり、簡単に言えばド・ミ・ソ・シのことである。}\footnote{$\textrm{C}_{\textrm{M7}}$の構成音を書けば良いのであって、ドミソシの順に積まないといけないわけではない。ボイシングを変えても、エレクトーンの側で適宜読み替えをしてくれる。自分が$\textrm{C}_{\textrm{M7}}$を演奏したときに、再生されてほしいフレーズを書こう。ただし、実際のパフォーマンスに使う場合は、必ず実験とリハーサルをすること。}。これに関する詳しい説明はCASMセクションのChord Root / Chord Typeの節で行う。

推奨されるアカンパニメントのパートの使い分け\cite{取説}と、$\textrm{C}_{\textrm{M7}}$を基準にしたときに無理なく使うことのできるノートを表\ref{accの種類}に記す。これ以外のノートを使用した場合、演奏するコードによっては意図しない移調\footnote{音楽用語の「移調」の意味ではなく、本稿では自動伴奏におけるフレーズの読みかえのことを移調(transpose)と呼ぶことにする。}をされる恐れがある\cite{style}。ただし、これらの使用可能ノートはCASMセクション内でNTTにより指定されているため、CASMセクションをこだわって製作する場合は\footnote{こだわって製作する場合は、CASMセクションの説明の図\ref{figChordtype}を参照してほしい。}表\ref{accの種類}の通りに作る必要はない。

\begin{table}[h]
\caption{アカンパニメントのパートと使用可能なノート}
\label{accの種類}
\centering
\setlength{\doublerulesep}{0.6pt}
\begin{tabular}{|c|c|c|}
\hline
パート & 説明 & 使用可能ノート($\textrm{C}_{\textrm{M7}}$基準) \\
\hline\hline
ベース & - & C, D, E, G, A, B \\ \hline
コード1/2 & \begin{tabular}{c}コード伴奏を担当する、ピアノや\\ギターなどの演奏を再生する。\end{tabular}& C, E, G, B\\ \hline
パッド & ストリングスやオルガンなどの演奏を再生する。& C, E, G, B \\ \hline
フレーズ1/2 & \begin{tabular}{c}アルペジオや、パンチの効いた\\ブラスフレーズなどを再生する。\\アカンパニメントの中でひときわ華やかなパート。\end{tabular}& C, D, E, G, A, B\\
\hline
\end{tabular}
\end{table}

\subsubsection{MIDIセクションにおけるMIDIチャンネルの役割}

エレクトーンで見ることができるセクションパートは、メインドラム、アドドラム、ベース、コード1/2、パッド、フレーズ1/2の8つだが、スタイルで使用することのできるMIDIチャンネルは16本あり、スタイルはこの16チャンネル分のMIDIデータを8パートに合流させて自動演奏させることができる。このため、スタイルには「入力チャンネル」と「出力チャンネル」という概念が存在する\href{http://els01stylefile.music.coocan.jp/Stagea_Style/P1706a.htm}{【17-6】}\footnote{例えば、アンプラグド1はコード1に12チャンネル分のデータが送られる\href{http://els01stylefile.music.coocan.jp/Stagea_Style/P1708a.htm}{【17-8】}。}。MIDIセクションに記述するMIDIメッセージが「入力」であり、エレクトーンの8つのセクションパートが「出力」である。表\ref{styleoutch}にスタイルの出力チャンネルとパートの対応を示す。
ただし、1つのパートで同時に鳴らすことができる楽器（プログラムチェンジコマンド）は、当然1種類だけであるため、例えばコード1でピアノとストリングスとブラスを同時に鳴らす、ということはできない\href{http://els01stylefile.music.coocan.jp/Stagea_Style/P1709a.htm}{【17-9】}。

\begin{wraptable}{r}[5mm]{50mm}
\caption{スタイルファイルの出力チャンネル設定。}
\label{styleoutch}
\centering
\begin{tabular}{cc}
チャンネル & パート \\
\hline
Ch.9 & アドドラム \\
Ch.10 & メインドラム \\
Ch.11 & ベース \\
Ch.12 & コード1 \\
Ch.13 & コード2\\
Ch.14 & パッド \\
Ch.15 & フレーズ1 \\
Ch.16 & フレーズ2 \\
\hline
\end{tabular}
\end{wraptable}

CASMセクションがスタイルファイルに存在しない場合、エレクトーンのデフォルトのCASMセクションがスタイルファイルに結合されて読み込まれ、出力チャンネル設定は入力チャンネル設定と同じになる。よって、\emphj{メインドラムとアドドラムしかMIDIセクションを記述しなかった場合、これらをそれぞれCh.10とCh.9で書いていれば、CASMセクションを記述する必要はない。}CASMセクションを記述する場合はどのチャンネルにどのパートの演奏を書いても構わないが、CASMセクションが壊れるような操作は多い\footnote{例えば、.styファイルの拡張子を.midファイルに書き換えてDominoで開いたあと、.midファイルを上書き保存することで、CASMセクションを消すことができる。DominoはCASMセクションを読み込むことができないので、開いた段階でCASMセクションを捨てている。}ため、\emphj{特別な理由がない場合は、MIDIメッセージのチャンネルは表\ref{styleoutch}になるべく合わせるべきであろう。}

この仕様は、CASMセクションを設定することで、特定の押鍵のスタイルだけ違うパターン（違う楽器にもできる\footnote{１つの出力チャンネルで同時に2以上の楽器を鳴らすことはできないが、同時でなければ複数の楽器を1つの出力チャンネルに通すことができる。}）で自動演奏させたり、ピアノの左手相当のノートと右手相当のノートを別々のチャンネルで編集し、再生は1つのパートでしたりするときなどに活用する。具体的な方法は後述のCASMセクションのIn / Out Channelの説明を参照してほしい。



\subsubsection{2小節目以降}


イントロとエンディングは、鍵盤で押さえているコードが再生中に変更されない前提で作る。イントロとエンディングの再生中は、下鍵盤ボイスの発音が禁止される点に注意しなくてはならない。

オートベースコードも基本的にアカンパニメントと同じように編集する。ただし、以下のようにオートベースコード特有の注意点が存在する。
\begin{itemize}
\item エレクトーンはベースパートのプログラムチェンジを使うことができない。書いたフレーズは足鍵盤ボイスで再生される。
\item ベースパートは1オクターブ上で再生されてしまうため、オクターブを下げて保存する\href{http://els01stylefile.music.coocan.jp/Stagea_Style/P1612.htm}{【16-12】}。
\item CASMセクションでNote Limitを設定しないと、意図しないオクターブ移動をされる恐れがあるため、オクターブをまたぐフレーズを書く場合はCASMセクション編集の際にNote Limitを設定するのを忘れないこと。
\end{itemize}
ベースにメロディアスなフレーズをつけることもできるが、カスタムA.B.C.の場合はL.K.とセットでコード判定が行われるため、意図したフレーズを再生できない場合も多い。オートベースコードには同音連打程度の簡単な伴奏を書くことを勧める。

1小節目と2小節目以降とで扱うことのできるMIDIメッセージが異なる\cite{style}。sysEXは2小節目以降に記述できない。また、スタイルは2小節目以降の拍子変更ができない\footnote{拍子変更ができないのはセクションパターンの格納されているデータが小節単位で定義されているためである\href{http://els01stylefile.music.coocan.jp/Stagea_Style/Stagea_Style_P34.htm}{【5-34】}}。しかし、スタイル内のテンポ変更には対応しており、1小節目で指定したテンポに対する倍率で、変更後のテンポを指定できる\footnote{テンポ変更の仕様を確かめるには、次のような実験を行えば良い：MIDIセクションを作る際に、1小節目（セットアップ小節）は4/4拍子でテンポ100としておいて、2小節目からMain Aを書き始める。Main Aの4拍目だけをテンポ200とし、この1小節でMain Aが終わるようにしてからエレクトーンに読み込ませれば、擬似的に7/8拍子を再現できる。ただし、変拍子を普通に作る場合は1小節目の拍子を調節すれば良い。この方法は、スタイルのセクションパターンの一部だけを変拍子にしたい場合などに活用できる。}。これにより、レジストレーションメモリーを消費せずに\textit{accel.}や\textit{rit.}ができる。他のMIDIメッセージについては表\ref{1bar2bar}に示す\footnote{この表については\cite{style}から引用したものであるから、エレクトーンにおいては事情が異なる可能性がある。}。



\begin{table}[h]
\caption{扱うことができるMIDIメッセージ。\cite{style}より引用。}
\label{1bar2bar}
\centering
\begin{tabular}{|l|c|c|}
\hline
MIDIイベント & 1小節目 & 2小節目以降\\
\hline
\hline
ノートオン・オフ & - & OK \\ \hline 
プログラムチェンジ & OK & OK \\ \hline
ピッチベンド & OK & OK \\ \hline
CC\texttt{\#}01(モジュレーション) & OK & OK \\ \hline
CC\texttt{\#}06(データエントリー) & OK & - \\ \hline
CC\texttt{\#}07(ボリューム) & OK & OK \\ \hline
CC\texttt{\#}10(パン) & OK & OK \\ \hline
CC\texttt{\#}11(エクスプレッション) & OK & OK \\ \hline
CC\texttt{\#}64(サスティン) & OK & - \\ \hline
CC\texttt{\#}71(レゾナンス) & OK & OK \\ \hline
CC\texttt{\#}72(リリースタイム) & OK & - \\ \hline
CC\texttt{\#}73(アタックタイム) & OK & - \\ \hline
CC\texttt{\#}74(ブライトネス) & OK & OK \\ \hline
CC\texttt{\#}91(リバーブセンドレベル) & OK & OK \\ \hline
CC\texttt{\#}93(コーラスセンドレベル) & OK & OK \\ \hline
CC\texttt{\#}94(バリエーションセンドレベル) & OK & OK \\ \hline
CC\texttt{\#}98/99(NRPN) & OK & - \\ \hline
CC\texttt{\#}100/101(RPN) & OK & - \\ \hline
\end{tabular}
\end{table}

\subsection{CASMセクション(Ctab)}
CASMセクションは、MIDIセクションの各セクションパターン(CSEG)に対する\emphj{Channel table (Ctab)}設定の集合体である。CtabとはMIDIセクションの各チャンネルをどのように解釈して自動伴奏を構成するかの命令のことである。CASMセクションは自動伴奏の設定であるため、\emphj{自動伴奏を設計しない場合、CASMセクションを編集しないでエレクトーンに読み込んでも問題ない\footnote{DominoでMIDIセクションまでを書き終えたら、「SMFとして書き出し」からフォーマット0を指定して書き出し、拡張子を.midから.styにするだけでエレクトーンで読み込むことができる。}。}この節はアカンパニメントやオートベースコードの編集をする人だけ読めば良い。Ctabの全体像をざっくりと把握するために、\href{http://els01stylefile.music.coocan.jp/Stagea_Style/P1701.htm}{【17-1】}を見ると良い。本稿では、【17-1】の通し番号の順にCtabの命令を説明する。エレクトーン以外のヤマハ電子楽器の取扱説明書にCtabの説明が書いてあるものがあるため、本稿で物足りないと感じた読者は、例えばポータトーンのリファレンスマニュアル\cite{PSR}の44ページ以降などを参照してほしい。

CASMセクションを編集するには、\href{https://www.mnppsaturn.ru/osenenko/Main_eng.htm}{CasmEdit}\footnote{\url{https://www.mnppsaturn.ru/osenenko/Main_eng.htm}}などのソフトを用いる。本稿ではCasmEditの使い方も含めて解説する。

\subsubsection{NTT}
\emphj{NTT}とはNote Transposition Tableのことで、実際に演奏しているときのコードタイプに応じて
、どのようにMIDIセクションのデータを移調するかを指定する\footnote{新しい電子楽器ではCnttというセクションが追加され、Cnttに対応している楽器ではNTTの命令をCnttで上書きするようになった。エレクトーンではCnttセクションを用いている。そのため、CasmEditで編集する際はNTTではなくCnttを編集することになる。なお、Bypass, Melody, Chord, BassとMelodic Minor, Harmonic MinorがNTTに存在する設定であり、その他のNTTはCnttで記述する。後述のOn BassもCnttの内容。詳しくは\cite{style}を見よ。}。以下に各NTTの特徴を説明する\href{http://els01stylefile.music.coocan.jp/Stagea_Style/P1626.htm}{【16-26】}。

\begin{description}
\item[\emphj{Bypass}]\

移調を行わない。メインドラム・アドドラムなどはコードタイプに合わせて移調するわけにはいかないため、NTTをBypassに指定しなくてはならない\footnote{エレクトーンではメインドラム・アドドラムはNTT/NTRの設定に関わらず移調をスルーする\href{http://els01stylefile.music.coocan.jp/Stagea_Style/Stagea_Style_P0701.htm}{【7-1】}。}。ほかに、効果音的に使いたい楽器に対してBypassを指定することがある\footnote{例えば、メガボイスの効果音のレイヤーだけを使いたい場合。効果音のレイヤーは範囲が狭いため、普通の楽器のように安易に移調されると意図した効果を出せない場合がある。}。

\item[\emphj{Melody}]\

メロディライン向けの移調を行う。フレーズ1/2に出力されるようなパートで使う。エレクトーン\footnote{エレクトーンを含む2002年以降の機種。}の場合はベースパートも（NTT$=$Bassを使用しないで）Melodyに指定する。ただしこの時、On Bassというパラメータを有効にする。詳しくは後述。

\item[\emphj{Chord}]\

コードプレイ向けの移調を行う。コード1/2やパッドに出力されるようなパートで使う。

\item[\emphj{Bass}]\

ベース用のNTTであるが、現在は使われない古い仕様。NTT$=$Melodyとほとんど同じだが、オンコード\footnote{オンコードとは、ベースが和音のルートを演奏しないようなコードのことである。}で演奏した場合にも、意図したベースを演奏するようになっている。現在はベースパートにはNTT$=$Bassは使用せずに、NTT$=$Melodyとした上でOn Bassを有効にする。

\item[\emphj{その他}\footnotemark]\footnotetext{Melodic Minor, Melodic Minor 5th, Harmonic Minor, Harmonic Minor 5th, Natural Minor, Natural Minor 5th, Dorian, Dorian 5th。}\

主にメジャーコード・マイナーコードの判定のみ行い、各スケールに合うように移調を行う。メジャーコード・マイナーコードのみ演奏されるセクションパターンであるイントロ・エンディングで主に用いる。詳しくは\cite{PSR}を参照してほしい。

\end{description}

\subsubsection{NTR}
\emphj{NTR}とはNote Transposition Ruleのことで、移調の際に展回形を用いるかを指定する。エレクトーンで使う場合はRoot TransとRoot Fixedから選ぶ。
\begin{description}
\item[\emphj{Root Trans}]\

図\ref{figRTRF}左のように、移調の際に転回しないで、元のパターンの音程を保とうとする。例えば、ハ長調のC3, E3, G3は、ヘ長調のときにF3, A3, C4に移調される。普通、メロディラインがあるパートにRoot Transを設定する。

\item[\emphj{Root Fixed}]\

図\ref{figRTRF}右のように、移調の際にできるだけ元の音域から離れないように、転回形を用いる。例えば、ハ長調のC3, E3, G3は、ヘ長調のときにC3, F3, A3に移調される。普通、コードパートにRoot Fixedを設定する。また、ドラムパートも（NTT$=$Bypassを指定した上でさらに）NTR$=$Root Fixedに指定する。
\end{description}

\begin{figure}[h]
  \centering
  \includegraphics[keepaspectratio,width=100mm]{RTRF.pdf}
  \caption{Root TransとRoot Fixedの違い。\cite{PSR}より引用。}
  \label{figRTRF}
\end{figure}

\subsubsection{Source Root / Source Chord}
MIDIセクションで記述したパターンが、何のコードのときを基準にしているかを指定する。Source Rootでコードのルートを指定し、Source Chordでコードタイプを指定する。デフォルトのCASMセクションの場合は$\textrm{C}_{\textrm{M7}}$になっている。指定できるコードタイプと、推奨ノートを図\ref{figChordtype}に示す\cite{PSR}。

\begin{figure}[h]
  \centering
  \includegraphics[keepaspectratio,width=150mm]{ChordType.eps}
  \caption{Source Root$=$Cのときのコードタイプと推奨ノート一覧。\cite{PSR}より引用。}
  \label{figChordtype}
\end{figure}

スタイルファイルを製作する際に、MIDIセクションには$\textrm{C}_{\textrm{M7}}$の構成音を書くように解説することが多いのは、Source Root / Chordのデフォルトが$\textrm{C}_{\textrm{M7}}$だからである。これを知っていれば、$\textrm{C}_{\textrm{M7}}$準拠でMIDIセクションを記述する必要はない。CasmEditではSource Chord Root(C.R.)とSource Chord Type(C.T.)と呼ばれている。

\subsubsection{High Key}

どのノートを境にパターンをオクターブ下に下げるかを指定する。High Keyで指定されたノートよりも高い音をルートに持つ和音が演奏されたとき、和音全てを1オクターブ下げて再生する（図\ref{fighighkey}）。NTR$=$Root Transのときのみ設定が有効になる。CasmEditではHighest Key(H.K.)と呼ばれている。

\begin{figure}[h]
  \centering
  \includegraphics[keepaspectratio,width=150mm]{highkey.eps}
  \caption{High Keyがどのように効くかの説明の図。\cite{PSR}より引用。}
  \label{fighighkey}
\end{figure}

\subsubsection{Note Low Limit / Note High Limit}

音高変換された後のノートにNote Limitよりも外側の音が存在した場合、Note Limitの内側\footnote{Note Limitのノートを含む内側。つまり、Note Low Limit$=$E0, Note High Limit$=$G8のときにE0を演奏するとそのまま発音されるが、E$\flat$0を演奏するとオクターブが上がる。}にオクターブを変える。High Keyが判定コード単位の変換なのに対し、Note Limitは最終的な発音に対して下限/上限の
制限を設けて発音音域を整える\href{http://els01stylefile.music.coocan.jp/Stagea_Style/P1672.htm}{【16-72】}。CasmEditではLow Limit(L.L.)、High Limit(H.L.)と呼ばれている。エレクトーンのプリセットのスタイルの場合、ベースパートのLow LimitはE0になっていることが多い。これは4弦ベースの通常のチューニングの最低音がE0であるからだと思われる。

\subsubsection{On Bass}

On Bass\footnote{On BassはCnttセクションの一部であるため、Ctab命令ではない。CasmEditで編集する際は、CnttのパラメータのうちOn Bassが有効のものを選択する形になる。}が有効のとき、オンコードを演奏した場合に、ベースルートで再生される\href{http://els01stylefile.music.coocan.jp/Stagea_Style/P1531.htm}{【15-31】}\href{http://els01stylefile.music.coocan.jp/Stagea_Style/P1532.htm}{【15-32】}。例えば判定コードが$\textrm{C}^{\textrm{on E}}$のとき、On Bassが有効になっているパートではEに集中して音高変換をする。通常の場合ベースパートはNTT$=$Melodyにして、On Bassを有効にする。

\subsubsection{RTR}

\emphj{RTR}とはReTrigger Ruleのことで、スタイル再生中に判定コードが変わった場合の処理を指定する\href{http://els01stylefile.music.coocan.jp/Stagea_Style/P1674.htm}{【16-74】}。次の5種類がある。

\begin{description}
\item[\emphj{Stop}]\

発音中の音を止めて、次のノートオンを待つ。
\item[\emphj{Pitch Shift}]\

発音中の音にピッチベンドをかけて、新しいコードに移調する。
\item[\emphj{Pitch Shift To Root}]\

発音中の音にピッチベンドをかけて、新しいコードのルート音に移調する。
\item[\emphj{Retrigger}]\

発音中の音を止めて、新しいコードの音で再発音する。
\item[\emphj{Retrigger To Root}]\

発音中の音を止めて、新しいコードのルート音で再発音する。
\end{description}

エレクトーンの場合、カスタムA.B.C.でベースを弾き直すと、最初の1音は弾いたノートが演奏されるため、ベースがTo Rootか否かは関係ない。しかし、カスタムA.B.C.以外のオートベースコードに対応するために、ベースはRTR$=$Pitch Shift To Rootにすることをお勧めする。

\subsubsection{Auto Start}
Auto Startが有効のパートはリズム再生と同時に自動で再生される。エレクトーンの場合、この設定は無視され、メイン・アドドラムはAuto Startで再生され、それ以外にAuto Startは設定できないと思われる\footnote{もし他のパートもAuto Startにすることができたら、ドラムを3以上編成できることになるが、私が実験した限りでは残念ながらAuto Startは無視される。}。ドラムが強制的にAuto Startになるおかげで、\emphj{メインドラム・アドドラムのパートにドラム以外のプログラムチェンジを設定し、リズム再生に同期して（演奏に合わせて読み替えをしない、ドラム同様に固定の\footnote{ドラムパートが移調をスルーすることを利用している。メインドラム・アドドラムのフレーズは、どんな音色を使っているかに関係なく、そのままAuto Startで再生されるため、メロディなども再生できる。ただし、Auto Startを設定できるのはメイン・アドドラムの2系統までであるため、それ以上にトラックを必要とする場合はXGサポートを書くことになる。}）自動演奏を再生させる}ことができ、簡易的なXGサポートの代わりとして利用できる。

\subsubsection{In Channel / Out Channel}
「MIDIセクションにおけるMIDIチャンネルの役割」の節で述べたように、スタイルファイルは1つのパートに対して複数のチャンネルを設定できる。これを行うのがIn / Out Channelである。MIDIセクションで書いたチャンネルをIn Channelにし、表\ref{styleoutch}で示されるパートでOut Channelを選ぶ。例えば、MIDIセクションで音域別にチャンネルを分けて書いておいて、CASMセクションでチャンネルごとに異なる音高変換をさせたり、次に紹介するChannel Switch Chord Root / Typeで特定コードだけ別のチャンネルを参照するようにして、パターンを弾き分けたりできる。\href{http://els01stylefile.music.coocan.jp/Stagea_Style/Stagea_Style_P1120a.htm}{【11-20】}も参照すると良い。

\subsubsection{Channel Switch Chord Root / Channel Switch Chord Type}
Channel Switch Chord Root / Channel Switch Chord Type\footnote{Channel Switch Chord Root / Channel Switch Chord Typeは、\cite{スタイル}ではこの名称であるが、公式名称が明らかになっていないため、ソフトや記事によって様々な呼ばれ方が存在する。他にNote Mute / Chord Mute\cite{style}、Active Keys / Active Chords\cite{CASMeditor}、Note Mute(NMute) / Chord Mute(CMute)（CasmEdit）などの名称がある。}は特定のコードが判定されたときにチャンネルをミュートしたり、逆に特定のコードのときだけ再生したりする場合に用いる。In / Out Channelと組み合わせて判定コードに合わせて複雑な分岐をするパートを作ることができる。普通は特定のコードタイプで音の濁りが生じるのを防ぐために使うが、特定のコードの時だけアカンパニメントをプログラムチェンジを含めてまるっきり変更するといった積極的な使い方もできる。なお、デフォルトでは全てのコードが演奏されるようになっている\href{http://els01stylefile.music.coocan.jp/Stagea_Style/P1703.htm}{【17-3】}。この仕様の勉強のために、\href{http://els01stylefile.music.coocan.jp/Stagea_Style/P1702.htm}{【17-2】}でセブンスコードのときだけ有効になるチャンネルが存在するスタイルファイルを配布している。エレクトーンで読み込んだり、CasmEditで読み込んだりして勉強に使うと良い。

\subsubsection{Editable Bit}
スタイルクリエーター搭載電子楽器での編集可能フラグ。


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\clearpage

\section{Arduinoを用いたMIDIデバイス製作}
この節ではMIDIデバイスの製作に役立つArduinoの説明と、回路設計に関する簡単な説明を与える。ただし、Arduinoの文法等に関する詳細な解説はしない。
\begin{itembox}{この節の参考書}
\begin{itemize}
\item MIDI1.0規格書\cite{規格}

きちんとしたものを作るなら、まず規格を参照しなくてはいけない。

\item Arduinoのすすめ\cite{Arduinoのすすめ}

Arduinoを解説しているサイトは多いが、その中で私が最もお世話になったサイト。

\item Arduino 日本語リファレンス\cite{Arduinoリファレンス}

Arduino言語についての説明。

\item Arduino MIDI Libraryの使い方\cite{ArduinoMIDILib}

Arduinoを使ってMIDIを処理するなら間違いなく使うライブラリの詳細な解説。もしこの方がMIDI Libraryの紹介を書いていなければ、私は本稿のようなハックはしていなかった。
\end{itemize}
\end{itembox}

\subsection{Arduinoの基礎}
\subsubsection{Arduinoとは}
\emphj{Arduino}はマイコンの一種で、ArduinoボードにArduino言語を書き込んで使う。Arduinoができることは単純で、せいぜい「電圧の値を読む」「電圧を出力する」「計算する」ことしかできない。しかし、それらを組み合わせれば、大いに役立つデバイスを工夫次第で作ることができる。Arduino開発環境であるArduino IDEは、\href{https://www.arduino.cc/en/software}{公式サイト}\footnote{\url{https://www.arduino.cc/en/software}}から無料でダウンロードできる。

\subsubsection{Arduinoボード}
Arduino公式が出しているハードウェアにはいくつか種類があるが、私がおすすめするのは以下である。
\begin{itemize}
\item Arduino UNO

Arduinoの主要モデルである。インターネット上に情報が多いので、分からないことがあったときに解決策にたどり着く可能性が高い。初心者はまずこれを買うのが良い。

\item Arduino Leonardo

ArduinoをqwertyキーボードとしてWindowsに認識させることができる\cite{EMA}。

\item Aruduino MEGA

UNOと比べて約3倍多くピンソケットを装備しており、メモリも大きい。MIDI開発の観点から言うと、ハードウェアシリアルに対応しているソケットを4対持っていることが最大の特徴である。

\item Arduino Pro Mini

私が最もよく使っているArduino。書き込み装置がボード上に存在しないため自分で用意する必要がある。実際の運用において書き込み装置は不要であるから、その分コストとサイズを抑えることができる。出力電圧が3.3Vのものが存在し、それを使う場合は3.3V用の仕様\cite{3.3V}でハードウェアを設計することになる。
\end{itemize}

Arduinoはオープンソースであり、ハードウェアに関しても多くの互換品が出回っている。私は最初の1台だけ公式のArduino UNOを購入し、あとは全て互換品を使っている。初めてArduinoを勉強しようとする人は、AmazonなどでArduino初心者キットを手に入れるのが良いと思う。

\subsubsection{Arduino言語}
Arduino言語はC/C++言語をベースにしている。本稿を読みすすめるのに必要なArduinoに特有の知識を列挙する。Arduino言語についての詳細は、本稿以外で勉強してほしい。
\begin{itemize}
\item Arduinoにおけるソースコードは「スケッチ」と呼ばれる。
\item Arduino言語に\texttt{main( )}関数は無い。その代わり、Arduinoが起動したときに1度だけ呼ばれる\texttt{setup( )}関数と、起動している限り無限ループをする\texttt{loop( )}関数で構成されている。
\item Arduinoボードには入出力用ピンが複数存在し、\texttt{setup( )}の中でそれらのピンを入力で使うのか、出力で使うのかを宣言する。
\end{itemize}

\subsubsection{Arduino始めの一歩　Lチカ}
流石に外部サイトに投げっぱなしでは読者が興味を持たないと思ったので、本稿でも簡単に解説をする。

次はArduino言語におけるHello World的なスケッチであり、Blinkと呼ばれる。日本では「Lチカ」（LEDチカチカの略？）と呼ばれる。Arduino IDEのSample Sketchから見ることができる。
\begin{lstlisting}[caption=Lチカ]
void setup() {
  pinMode(LED_BUILTIN, OUTPUT);
}

void loop() {
  digitalWrite(LED_BUILTIN, HIGH);
  delay(1000);
  digitalWrite(LED_BUILTIN, LOW);
  delay(1000);
}
\end{lstlisting}

1行目から3行目までが\verb|setup( )|関数であり、\verb|LED_BUILTIN|\footnote{Arduinoボードには始めからLEDがインストールされていることが多い。UNOの場合は13番ピンについている。よってUNOにおいて\verb|LED_BUILTIN|は13番ピンのことである。}というピンを\verb|OUTPUT|で使う、と初期化している。これにより、\verb|LED_BUILTIN|に対し電圧（オン、オフ）を出力できるようになった\footnote{なお、初期化しなかった他のピンはデフォルトでINPUTとして扱われる。}。

5行目から最後までが\verb|loop( )|関数であり、\verb|digitalWrite( )|関数と\verb|delay( )|関数が並んでいる。\verb|digitalWrite( )|関数は、出力に設定されているピンに対してHIGHまたはLOWの電圧をかける関数である。HIGHにした6行目でLEDが点灯し、LOWにした8行目でLEDが消灯する。\verb|delay( )|関数は、引数（単位はミリ秒）の間待機するという関数である。今回は1000ミリ秒($=$1秒)待機する。よって、このスケッチを実行すると、LEDが1秒おきに点灯と消灯を繰り返すことになる。

\subsubsection{Arduinoとシリアル通信}
\emphj{シリアル通信}とは、HIGHまたはLOWの電圧レベルを時間的に連続に変化させることで、情報を送受信する通信である。MIDIがシリアル通信による送受信であるため、ここで簡単に説明する。

Arduino UNOはボードにシリアル通信用入出力ピンを装備しており、これを使うことで他の機器と通信することができる。送信用のピンソケットにはTX、受信用のピンソケットにはRXと印刷されている。これらのシリアル通信用ピンを使ってシリアル通信する時、この通信を\emphj{HardwareSerial}と呼ぶ。なお、USBケーブルでパソコンと接続している場合、TX/RXを使わなくてもUSBを介してシリアル通信を行える。

これに対して、シリアル通信用ピンが何らかの理由で使えない時、\emphj{SoftwareSerial}ライブラリをインクルードすることで、他のピンをシリアル通信のために代用することができる（SoftwareSerialは明示的に宣言しないと使用されない）。しかし、SoftwareSerialはコードによって通信するため、通信が終わるまでその先の処理ができない、割り込みされるとバグる、などの不安定要素がある。MIDIの送受信においては使い物にならないため、MIDI IN/OUTを2セット以上搭載したい場合は、Arduino MEGAを検討する必要がある。

次のスケッチは、Arduino IDEのSample SketchのGraphである。

\begin{lstlisting}[caption=Graph]
void setup() {
  Serial.begin(9600);
}

void loop() {
  Serial.println(analogRead(A0));
  delay(2);
}
\end{lstlisting}

Arduino IDEには「シリアルモニタ」「シリアルプロッタ」という、Arduinoから送信されたシリアル通信のデータを表示する機能がある。このスケッチはそれらを用いてA0ピンの電位を表示する、というチュートリアルになっている。

シリアル通信をする時は、2行目のように\verb|setup( )|内で\verb|Serial.begin( )|する必要がある。\verb|Serial.begin( )|の引数は通信速度であり、bpsで指定する。ただし、Arduino MIDI Library（後述）を使ってMIDIとしてシリアル通信する場合は、\verb|Serial.begin( )|してはいけない。

\verb|loop( )|内ではA0ピンの電位を\verb|analogRead( )|関数で読んでいる\footnote{\verb|setup( )|内でA0ピンを\verb|pinMode(A0, INPUT)|しなくても良いのは、pinModeを指定しない場合のデフォルトがINPUTだからである。}。\verb|analogRead( )|関数は、アナログ入力ピンへの入力電圧を、5V$=$1023、GND$=$0として、整数で返す関数である。これを、\verb|Serial.println( )|に渡すことで、シリアル通信でその整数値（改行コードつき）を送信している。\verb|delay(2)|は\verb|analogRead( )|がデジタル値に変換するのにかかる時間を考慮して、安定化のために書いてある。

\subsection{MIDI ソフトウェア設計 (Arduino MIDI Library)}
MIDIの通信は、前述のシリアル通信で行われる。ArduinoでMIDIを簡単に送受信するためのライブラリがArduino MIDI Libraryである。インストールから基本的な使い方まで、Arduino MIDI Library の使い方\cite{ArduinoMIDILib}で丁寧に解説されているため、それを熟読してほしい。

\subsection{MIDI ハードウェア設計}
MIDIデータに関する処理はArduino MIDI Libraryでできるようになった。次にMIDIのハードウェアのことを考える。

Arduino UNOの場合、\href{https://www.switch-science.com/catalog/2492/}{MIDIシールド}\footnote{\url{https://www.switch-science.com/catalog/2492/}}というものがあり、これをUNOの上に重ねるだけでMIDIを送受信できるようになる。ただ、MIDIシールドは値段が高いうえに大きいので、MIDIインターフェースを備えたデバイスを自分で設計できるようになっておくことは有用である。MIDIの規格書\cite{規格}\cite{3.3V}に設計は書いてあるが、本稿でも説明しておく。ただし、簡単にしか説明しないため、実際にハードを作るなら必ず規格を参照すること。

MIDIは送信側MIDI OUTと受信側MIDI INとで回路が電気的に絶縁されている。信号はフォトカプラ（別名オプトアイソレーター）というものでやり取りされており、これはLEDと感光素子がセットになっているものである。送信側の回路は受信側のLEDを駆動し、受信側の回路はLEDの光を信号として得る。

\subsubsection{MIDI OUT}
\begin{figure}[h]
  \centering
  \includegraphics[width=15cm]{MIDIOUT.eps}
  \caption{ボードが5Vの場合のMIDI OUT回路を真上から見た場合の実体配線図。左側が表、右側が裏。なお、ボードが3.3Vのときは、3.3V側の抵抗を$33\Omega$にし、TX側の抵抗を$10\Omega$にする。実体配線図は\href{http://uaubn.g2.xrea.com/pass/}{PasS}で描いた。}
  \label{figMIDIOUT}
\end{figure}
\begin{figure}[h]
  \centering
  \includegraphics[width=8cm]{MIDIOUTreal.jpg}
  \caption{実際のMIDI OUT回路。Arduinoとはジャンパワイヤで接続する。3.3Vボードのため、抵抗は$33\Omega$と$10\Omega$である。}
  \label{figMIDIOUTreal}
\end{figure}
図\ref{figMIDIOUT}はMIDI OUTの回路の（規格のオプションを全て付けない場合の）実体配線図であり、図\ref{figMIDIOUTreal}はそれを実際にはんだ付けしたものである。必要なものは2個の抵抗だけであり、非常に簡単な回路である。

\subsubsection{MIDI IN}
\begin{figure}[h]
  \centering
  \includegraphics[width=15cm]{MIDIIN.eps}
  \caption{MIDI IN回路を真上から見た場合の実体配線図。左側が表、右側が裏。ICは高速フォトカプラで、MIDI規格書\cite{規格}に適合するフォトカプラの例が載っている。フォトカプラは負論理である必要がある。}
  \label{figMIDIIN}
\end{figure}
図\ref{figMIDIIN}はTLP552をフォトカプラとして採用したMIDI INの回路の実体配線図の例である\footnote{ICは熱に弱いものが多く、さらに高価なことが多い。そのため、ICは回路に直接はんだ付けするのではなく、ソケットだけを付けておいて本体を着脱可能にする。実体配線図においてはICがそのまま回路に乗っているが、実際にはんだ付けしたのはソケットである。}\cite{TLP552}。他のフォトカプラの場合、ピンアサインが異なる恐れがあるので、フォトカプラのデータシートを必ず確認すること。なお、この回路においてフォトカプラだけをHCPL-260Lに交換しても動作することを確認している。

MIDI IN端子側のダイオードはフォトカプラの保護用である。Arduino側の0.1{\textmu}Fコンデンサと1k$\Omega$抵抗は、どちらもフォトカプラのための素子であり、MIDIの規格ではない。コンデンサはバイパスコンデンサ（パスコン）であり、1k$\Omega$抵抗はプルアップ抵抗である。プルアップ抵抗の抵抗値はフォトカプラによって異なるため、データシートを確認しなければならない\footnote{プルアップ抵抗値はデータシートを確認しなければならないのだが、実際のところはだいたい1k$\Omega$ぐらいにしておけば問題ない。本当は5Vと3.3Vで使用できるフォトカプラも違っていて、例えばTLP552などは3.3Vで動作することを保証していないが、3.3VボードのMIDI INで使用したことがある。真似をするなら自己責任で。}。

\subsubsection{その他のインターフェース}
\paragraph{フットスイッチ}

\begin{wrapfigure}{r}[5mm]{50mm}
  \centering
  \includegraphics[scale=0.15]{fc5.eps}
  \caption{ヤマハFC5。画像は\href{https://jp.yamaha.com/products/music_production/accessories/fc5/index.html}{ヤマハ公式サイト}から引用。}
  \label{figfc5}
\end{wrapfigure}

足で操作するスイッチである。図\ref{figfc5}はヤマハのフットスイッチFC5である。ピアノのペダルを模したFC4Aもある。2極\footnote{電子楽器に接続するインターフェースは、MIDIによるものとフォン端子によるものとが存在し、フォン端子は絶縁体に区切られているいくつかの領域が存在する。この領域が2つのものを2極、3つのものを3極と呼ぶ。オーディオを接続する場合、（乱暴に言って）モノラルのものは2極、ステレオのものは3極になっている。}のものは回路的にはただのタクトスイッチであるため、通常のタクトスイッチと同様に回路を設計すれば良い。ただし、メーカーによって極性\footnote{踏んでいないときにON（ノーマルクローズ）なのか、OFF（ノーマルオープン）なのか、という違い。物によっては極性切り替えスイッチがついていることもある。}が異なるため、事前に調べておくか、メーカーを固定してしまうのが良い。チャタリング\footnote{チャタリングとは、物理的な衝撃によってオンとオフを高速で行き来してしまう現象のことである。}が起きたときに誤作動しないように、スケッチの側で調整する必要がある。チャタリング防止について、例えば\cite{チャタリング防止}などが参考になる。フットスイッチによっては踏む強さを感知できるものもあり\footnote{ハーフペダル対応、と書いてあるフットスイッチ・フットペダルがそれである。}、その場合は3極になり、ただのスイッチではなく可変抵抗になる。

\paragraph{エクスプレッションペダル}

エレクトーンのものと同じように、足で操作する。普通は音量操作で用いるが、ヤマハのシンセサイザーMONTAGEのスーパーノブのように、激しい音変化をアサインして使うことができるかもしれない。プラグは3極で、回路は可変抵抗。

\paragraph{ブレスコントローラ}

息を吹く圧力を検知する。ウインドシンセサイザー\footnote{吹奏楽器を模したシンセサイザーのこと。しかし、ウインドシンセサイザーをただのブレスコントローラとして使用するのは、ウインドシンセサイザーの本体音源が勿体ないためお勧めしない。}に搭載されているほか、圧力センサを買って自作することもできる。\cite{ブレスコントローラ}などで実際にDIYしている\footnote{ブレスコントローラを自作する際にいくつか注意点がある。まず、ホースは着脱できるものが良い。\cite{ブレスコントローラ}では鍵盤ハーモニカのホース・唄口を取り付けているが、この記事と全く同じセンサを手に入れられるとは限らないため、注文した圧力センサの穴の外径を調べ、それを覆うような太さのシリコンチューブをつけて使うことをお勧めする。その場合、唄口とシリコンチューブはシリコンシーラントなどで接着すると良い。また、タンギングが効くようにするために、唄口かホース（基本的には丈夫な唄口の方が良い。私は鍵盤ハーモニカ本体に直で挿すタイプの唄口を加工した。小径のハンドドリルなどを使用する）に小さな穴を開ける。圧力センサは6kPaまで測れるものが良いとされている\cite{ブレスコントローラ}。}。

\clearpage
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


\begin{thebibliography}{99}
\bibitem{製品情報} ヤマハ ELS-02C 仕様\url{https://jp.yamaha.com/products/musical_instruments/keyboards/electone/els-02c/specs.html#product-tabs}
\bibitem{MIDI入門} MIDI 入門\url{https://jp.yamaha.com/files/download/other_assets/6/315426/midi_basics_ja_v10a.pdf}
\bibitem{規格} MIDI1.0 規格書 \url{http://amei.or.jp/midistandardcommittee/MIDIspcj.html}
\bibitem{MIDIリファレンス} ELS-02/ELS-02C/ELS-02X MIDIリファレンス \url{https://jp.yamaha.com/files/download/other_assets/7/331457/els02_ja_mr_a0.pdf}
\bibitem{全面戦争} 藤本健の ``DTMステーション'' 94年にヤマハが宣戦布告。XG規格とMU80でDTM全面戦争勃発 \url{https://www.dtmstation.com/archives/51957752.html}
\bibitem{戦争収束} ASCII.jp ローランドとヤマハ、MIDIデータの互換性向上で相互協力 \url{https://ascii.jp/elem/000/000/319/319916/}
\bibitem{GMwiki} General MIDI -Wikipedia \url{https://ja.wikipedia.org/wiki/General_MIDI}
\bibitem{GMdtm} 偏ったDTM用語辞典 General MIDIとは\url{https://www.g200kg.com/jp/docs/dic/generalmidi.html}
\bibitem{CC一覧表} コントロールチェンジ一覧表 \url{http://quelque.sakura.ne.jp/midi_cc.html}
\bibitem{wakminblog} わくわくのわくみん \url{https://wakmin.blog.fc2.com/blog-entry-11.html}
\bibitem{XG仕様} XG仕様書 \url{https://jp.yamaha.com/files/download/other_assets/0/321740/xg_v135_j.pdf}
\bibitem{Dr青} Dr.青山のXG解体新書 \url{https://jp.yamaha.com/files/download/other_assets/9/321739/read_aoyama.pdf}
\bibitem{XG指針} XG楽曲データ製作の指針 \url{https://jp.yamaha.com/files/download/other_assets/6/321756/xgsongdata.pdf}
\bibitem{megavoice} CSP-170/CSP-150 データリスト \url{https://jp.yamaha.com/files/download/other_assets/3/1101213/csp170_ja_dl_a0.pdf}
\bibitem{スタイル} スタイル入門講座 \url{http://els01stylefile.music.coocan.jp/}
\bibitem{style} Peter Wierzba Style Files -- Description \url{http://www.wierzba.homepage.t-online.de/stylefiles.htm}
\bibitem{CASMeditor} YAMAHA Keyboard -- style CASM Format \url{http://www.jososoft.dk/yamaha/articles/style2_2.htm}
\bibitem{PSR} ヤマハ PSR-SX600 Refernce Manual \url{https://jp.yamaha.com/files/download/other_assets/0/1346910/psrsx600_ja_rm_a0.pdf}
\bibitem{B00} All that I know about Electone files \url{http://serge45.free.fr/electone/texte.htm#b00evt}
\bibitem{cvp} ヤマハ クラビノーバ CVP-109/107/105 取扱説明書 \url{https://jp.yamaha.com/files/download/other_assets/4/314934/CVP109J1.PDF}
\bibitem{取説} ELECTONE STAGEA ELS-02 ELS-02C ELS-02X 取扱説明書 \url{https://jp.yamaha.com/files/download/other_assets/0/803680/els02_ja_om_f0.pdf}
\bibitem{初心者になるための} 初心者になるための耳コピMIDI講座 \url{http://mimikopi.nomaki.jp/}
\bibitem{elspc} STAGEAとPC編曲の連携 （東大エレクラ資料、まさにこの名前でググれば運が良ければ見つかるかも。一時期、一瞬だけ、東大エレクラのページが公開されていたことがあった。筆者と思われるkodack64氏のgithubから東大エレクラのサーバーへリンクが貼られている。）
\bibitem{Arduinoのすすめ} Arduinoのすすめ \url{https://n.mtng.org/ele/arduino/}
\bibitem{Arduinoリファレンス} Arduino 日本語リファレンス \url{http://www.musashinodenpa.com/arduino/ref/}
\bibitem{ArduinoMIDILib} Arduino MIDI Libraryの使い方 \url{https://qiita.com/yudai220/items/3bde9461f282d56d1ac2}
\bibitem{EMA} Electone $\times$ MIDI $\times$ Arduino \url{https://qiita.com/yudai220/items/b0b3dc6a8293780d5be2}
\bibitem{3.3V} MIDI 1.0 電気的仕様改訂 \url{http://amei.or.jp/midistandardcommittee/Recommended_Practice/ca33-j.pdf}
\bibitem{TLP552} TETRASTYLE-dev-BLOG MIDI 受信回路 \url{http://dev.tetrastyle.net/2011/07/midi_21.html}
\bibitem{チャタリング防止} jumbleat  Arduinoのスケッチだけでスイッチのチャタリングを回避する \url{https://jumbleat.com/2016/08/19/switch_without_chatter/}
\bibitem{ブレスコントローラ} USB MIDI Breath Controller -- Hackaday.io \url{https://hackaday.io/project/161678-usb-midi-breath-controller}

\end{thebibliography}
\end{document}
