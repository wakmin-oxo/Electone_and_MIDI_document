\documentclass[uplatex, 10pt, dvipdfmx]{jsarticle}
\usepackage[dvipdfmx]{hyperref}
\setcounter{secnumdepth}{4}
\usepackage{color}
\usepackage[deluxe]{otf}
\usepackage[noto-otc]{pxchfon}
\usepackage[left=25mm,right=25mm,top=30mm,bottom=30mm]{geometry}
\usepackage{bm}
\usepackage{fancyvrb}
\usepackage{comment}
\usepackage{bigints}
\usepackage{autobreak}
\usepackage{plext}
\usepackage{breqn}
\usepackage{empheq}
\usepackage{here}
\usepackage{wrapfig}
\usepackage{amsmath,amsthm,amssymb}
\usepackage{physics}
\usepackage{cancel}
\usepackage{ascmac}
\usepackage{listings}
\usepackage{tikz}
\usepackage{listings,jlisting}
\usepackage{here}
\usepackage{enumitem}
\usepackage{dirtree} 
\usepackage[subrefformat=parens]{subcaption}
\usepackage{graphicx}
\usepackage{pxjahyper}
\usepackage{floatflt}
%%見出しに関する命令
\usepackage{titlesec}
\titleformat*{\section}{\LARGE\bfseries\gtfamily}
\titleformat*{\subsection}{\Large\bfseries\gtfamily}
\titleformat*{\subsubsection}{\large\bfseries\gtfamily}
\titleformat*{\paragraph}{\normalsize\bfseries\gtfamily}

\lstset{
  backgroundcolor={\color[gray]{0.95}},
  basicstyle={\ttfamily},
  identifierstyle={\small},
  commentstyle={\smallitshape},
  keywordstyle={\small\bfseries},
  ndkeywordstyle={\small},
  stringstyle={\small\ttfamily},
  frame={tb},
  breaklines=true,
  columns=[l]{fullflexible},
  numbers=left,
  xrightmargin=0zw,
  xleftmargin=3zw,
  numberstyle={\scriptsize},
  stepnumber=1,
  numbersep=1zw,
  lineskip=-0.5ex,
  moredelim=[is][\color{red}\underline]{<\#}{\#>},
}

\usetikzlibrary{intersections,calc,positioning,angles,patterns,arrows,decorations.markings,through,quotes}
%\mathtoolsset{showonlyrefs=true}
\numberwithin{equation}{section}
\usepackage{xcolor}
\hypersetup{
    colorlinks=true,
    citecolor=blue,
    linkcolor=blue,
    urlcolor=blue,
}
\newcommand{\emphj}[1]{\textbf{\textrm{\textgt{{#1}}}}}
\newcommand{\red}[1]{\textbf{\textrm{\textgt{\textcolor{red}{{{#1}}}}}}}
\renewcommand{\lstlistingname}{ソース}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{document}
\VerbatimFootnotes
\columnseprule=0.2mm
\title{エレクトーン演奏演技におけるMIDIの活用 \\ \small\url{https://github.com/wakmin-oxo/Electone_and_MIDI_document}}
\author{wakmin (\href{https://twitter.com/wakmin_}{@wakmin\_})}
\date{2023年12月}
\maketitle

%\jot=6pt

\setcounter{tocdepth}{4}
\tableofcontents
\clearpage

\section{はじめに}

エレクトーンは1000を超える音\cite{製品情報}を有し、1台で3($+$2)パート\footnote{鍵盤3本$+$ドラム2本。}まで演奏できるため、本来的には合奏しないと演奏できない曲でも1人で演奏しきることができる。エレクトーン単体の性能の自己完結ぶりは、他のどの電子楽器よりも優っていると言っても過言ではない。

その一方で、エレクトーン単体で完結しないようなエディットは非常に敷居が高い。例えば、自動演奏補助としてXGサポートが存在するが、XGボイスリストは公式で公開されておらず、XGサポートを作るためのGUIを備えた現代的なエディタはもはや存在しない。スタイルは他の電子楽器に搭載されているスタイルクリエーターを使わないとエディットできず、それも隠しパラメータが存在する。そもそもこれらの仕様に関しては知名度が低く、エディットができることすら知られていない上に、製作しようと志すことができたとしても、体系的にまとまっているテキストがほとんど存在しない。そのため、「知る人ぞ知る」エレクトーンの隠し機能として、現在まで埋もれていた。

そこで本稿では、読者が自力でオリジナルの自動演奏補助が作れるようにすることを目的に、これらエレクトーンの「隠し機能」を初学者にも分かりやすく解説する。MIDIに関する低級な話題はあまり紹介せずに、即演奏に応用できるような情報のみをセレクトしたつもりである。ぜひ自分のエレクトーンで試してみて、演奏表現の幅を広げてほしい。ただし、節によっては内容が難しくなってしまったり、実用的でない情報も含まれたりしてしまったため、そのような節には「*」を付けておいた。興味がある読者や、MIDIの取り扱いに慣れた読者でなければ飛ばして構わない。

また本稿の最後には、エレクトーンの演奏演技の幅を広げる手段として、Arduinoを用いたデバイス開発のすすめを書いた。自動演奏補助とは異なるが、sysEXをリアルタイム演奏に活用したり、エレクトーンのインターフェースを拡張したりできる。ぜひチャレンジしてほしい。

なお、本稿は予告なくアップデートされる。最新版は\url{https://github.com/wakmin-oxo/Electone_and_MIDI_document}で配布するため、時々確認してほしい。最新の情報をリリースするために、\emphj{このpdfファイルの再配布はせず}に、上記urlを教える形でこのドキュメントを広めることをお願いする。また、内容の誤りを発見した場合、配布しているgithubでIssueをsubmitするか、twitter(\href{https://twitter.com/wakmin_}{@wakmin\_})などで報告してほしい。

\subsection{免責}
できる限り正確な情報をまとめたつもりであるが、独自研究が多く含まれているため、\emphj{本稿の内容を実行してどのような問題が生じたとしても、私はいかなる責任も取らない。本稿を読んで実行したことに対して、読者は自己責任で実行することを認めたものとする}。


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\clearpage

\section{MIDIデータの基礎知識}
\emphj{MIDI}とは\underline{M}usical \underline{I}nstrument \underline{D}igital \underline{I}nterfaceの頭字語で、異なる機種・異なるメーカー間であっても「演奏情報」をコミュニケーションするために策定された規格である\cite{規格}。実際の音色は各楽器で合成されるが、通信されるのは「何番目の音を」「どれくらいの強さで」「弾き始める」などという情報である。このような演奏情報を、\emphj{MIDIチャンネルメッセージ}と呼ぶ。また、演奏情報以外の情報を、\emphj{MIDIシステムメッセージ}と呼ぶ。これら2つを合わせて、\emphj{MIDIメッセージ}と呼ぶ（図\ref{figMIDImessage}を参照）。

本稿では、MIDIメッセージの具体的な表現（バイナリ表現）には立ち入らず、「どのような情報が流れているか」に焦点を絞って説明する\footnote{本稿ではArduino MIDI LibraryやDominoを用いてMIDIの処理をするため、具体的な表現はほぼほぼ必要にならない（それらに上手くパッケージ化されている）。ただし、MIDIシステムエクスクルーシブメッセージをArduinoで制御しようとしたときは値を直接打ち込む必要がある。}。

\begin{figure}[htbp]
  \centering
  \includegraphics[width=130mm]{figMIDImessage.pdf}
  \caption{MIDIメッセージの種類。}
  \label{figMIDImessage}
\end{figure}

我々がエレクトーンの3段の鍵盤を触ったり、パネルを操作したりすると、それらの操作1つ1つに対応するMIDIメッセージが音源部に送信されて、実際の音に反映される。単に演奏するだけであればこのことを意識する必要はないが、自動伴奏や自動演奏を製作しようとすれば、これら演奏情報を（実際のリアルタイムな演奏無しで）音源部に送信しなければならないため、MIDIメッセージの理解が不可欠となる。そこで\emphj{この章では、この後の内容を読むのに最低限必要な知識を紹介する}。

\begin{itembox}{この章の参考書}
\begin{itemize}
\item MIDI 入門\cite{MIDI入門}

MIDIを知らない人は、\emphj{まずこれから読むと良い}。ヤマハの初心者向けテキストである。

\item MIDI1.0 規格書\cite{規格}

規格書である。量が多いので全部読もうとするのは勧めない。辞書がわりに使うのが良い。

\item ELS-02/ELS-02C/ELS-02X MIDIリファレンス\cite{MIDIリファレンス}

ELS-02シリーズが対応しているMIDIメッセージの一覧。エレクトーンに対してどのような命令をMIDIで行えるのかの参考になる。

\end{itemize}
\end{itembox}

\subsection{General MIDIとXG、ELボイス}
MIDIはもともと演奏情報を取り扱う規格であって、受信側でどのような音を発生させるかはメーカーごとに異なっていた。これをある程度統一するために現れた規格が\emphj{General MIDI (GM)}であり、プログラムチェンジ（後述）やドラムマップ\footnote{ドラムマップとは、鍵盤上にドラムパーカッションを並べるとき、どのキーがどのパーカッションに対応しているかの割り当て。C2にキック、D2にスネアなど、GMによって決まっている。}の統一などがなされた\cite{GMwiki}\cite{GMdtm}。ヤマハはGMを拡張して\emphj{XG}\footnote{XGは、DTMの開祖・ローランドのGS規格に対抗するために打ち立てられた\cite{全面戦争}DTM音源の規格であった。1996年にローランドがSC-88Proという伝説的な機体を出したのもこの頃である。お互いに音源規格の覇権を争っていたが、両社とも2001年にGM Level 2に合流することで戦争は収束に向かい\cite{戦争収束}、「XG音源」を前面に打ち出す必要がなくなった。DTM用音源がその後の時代でプラグイン音源に置き換わったため、XGは2021年現在、表舞台から姿を消した。EL3桁代の頃はDTM用音源との互換性のために、XGの基本機体であるMU50相当の音源を搭載していたが、それより先のELS-01、02シリーズになると、もはやDTM用音源のためのXGとは違った独自の方向へと進化したようである\href{http://els01stylefile.music.coocan.jp/Stagea_Style/Stagea_Style_P78.htm}{【8-78】}（スタイル入門講座へのリンク）}という独自規格を作り、GMで作られたデータを再生できるようにしつつ、表現能力を高めた。

さて、エレクトーンはXG規格楽器である。しかし、エレクトーンの鍵盤で演奏する音色がXGによるものかというと、（大部分が）そうではない。エレクトーンには、自動演奏のためのボイス（XGボイス）と、鍵盤で演奏するためのボイス（ELボイス）とが存在する\footnote{XGボイス、ELボイスという呼び方は本稿の便宜であるため、公式的な呼称でないことに注意してほしい。}。XGボイスはスタイルとXGサポートでしか現れない\footnote{キーボードパーカッションでも扱うが、この場合XGパーカッションを例外的に鍵盤で使っているものと理解できる。}。\emphj{本稿ではXGボイスを主に紹介する}。

\subsection{MIDIチャンネルメッセージ}

MIDIチャンネルメッセージは、演奏に関する情報と、音色の設定の情報である。よく使用されるメッセージは、\emphj{ノートオン・オフ}、\emphj{チャンネルプレッシャー}、\emphj{ピッチベンドチェンジ}、\emphj{プログラムチェンジ}、\emphj{コントロールチェンジ}である。

MIDIチャンネルメッセージは16の独立した\emphj{チャンネル}を持っており、それぞれのチャンネルでバラバラに演奏できるようになっている。MIDIチャンネルメッセージは全て、1から16までの\footnote{余談：チャンネルは内部的には0（\texttt{0H}\footnotemark）から15(\texttt{FH})の値である。sysEXなどでチャンネル指定するとき、Ch.9を指定しようとしてうっかり\texttt{09H}を送信してしまうことがよくある（実際には\texttt{08H}を送信しなくてはならない）。}チャンネルを指定しながら送信する。\footnotetext{数字\texttt{H}という書き方は、書かれた数字が16進数表現であることを示す。16進数とは、1桁に0から15までの16通りの数字を書くことができる数の表現であり、10は\texttt{AH}、11は\texttt{BH}、...、15は\texttt{FH}と書く。16から繰り上がりが生じ、16は\texttt{10H}となる。16進数表現から10進数表現に直すには、(上の位)$\times16+$(下の位)を計算する。例えば、\texttt{4AH}$=4\times16+10=74$のようにする。MIDIメッセージは16進数で2桁の数字を用いて説明されることが多い。}
エレクトーンにおいて、MIDIチャンネルはデフォルト\footnote{受信チャンネルは図\ref{figelch}で固定（ELモードの場合）だが、送信チャンネルはSTAGEAの本体設定で変更できる。変更する場合、UTILITYボタンを押して、画面上部のタブメニューからMIDIを選択すれば良い。}で図\ref{figelch}のように鍵盤ごとに割り当てられている。図\ref{figelch}を見ればわかるように、Ch.5からCh.14までのMIDIチャンネルはエレクトーン側に対応するコントローラが存在していない。

\begin{figure}[htbp]
  \centering
  \includegraphics[width=130mm]{figelch.pdf}
  \caption{エレクトーンのデフォルトMIDIチャンネル設定。図はELモードの場合。XGモードの場合は後述。}
  \label{figelch}
\end{figure}

\subsubsection{ノートオン・オフ}
\emphj{ノートオン}とは、ノート\footnote{\emphj{ノート}とは、音符の演奏情報のことである。鍵盤のキーひとつ分に対応する。}を演奏開始する命令である。キーが押されたときに送信される。押されたキーの位置は\emphj{ノートナンバー}という値で指定され、ノートナンバーは中央C$=$60と定められている。また、演奏の強さは\emphj{ベロシティ}という（0から127を取る）値で指定される。ベロシティは、エレクトーンではイニシャルタッチの強さに関係がある。

\emphj{ノートオフ}とは、ノートの演奏を終了する命令である。キーが離されたときに送信される。なお、ノートオンのベロシティ0はノートオフと同じとして解釈される\footnote{MIDIの通信はデータの最初に命令の種類を書くのだが、命令の種類を省いた場合は前の命令と同じ命令であると解釈される（ランニングステータス）。発音を止めたいときは、ノートオンとして出力した方がランニングステータスのおかげでデータが圧縮できるため、通常はノートオフを出力せずに、ノートオンのベロシティ0を出力する。なお、一応ノートオフにもベロシティが存在し、離す強さを表せるが、私は対応しているハードウェアを見たことがない。}。

ノートオンからノートオフまでの時間のことを、\emphj{ゲートタイム}（またはデュレーション）と呼ぶ。

\subsubsection{チャンネルプレッシャー}
チャンネルプレッシャーは、そのチャンネルのアフタータッチの強さを指定する命令である\footnote{ELS-02Cにおいて、アフタータッチは各鍵盤に1つずつ、計3つの感圧センサーで鍵盤への力を測定して処理している。このような、チャンネルごとのアフタータッチをチャンネルプレッシャーと呼ぶ。なお、キーごとにアフタータッチを認識する場合、ポリフォニックキープレッシャーという別の命令で処理されるが、ELS-02シリーズには未搭載である。シンセサイザーMONTAGE M8x(2023)などにはポリフォニックアフタータッチという名前で搭載されている。}。0から127の値をとる。ELボイスのみ音色変化が起こり、XGボイスでは無視される。

\subsubsection{ピッチベンドチェンジ}
ピッチベンドチェンジは、そのチャンネルのサウンドのピッチを変化させる命令である。エレクトーンの場合、\emphj{ホリゾンタルタッチ}の強さが送信される。16384段階に量子化されており\footnote{128通りを表現できるデータバイトを2個組み合わせて使っているため、$128\times128=16384$通りを表現できる。}、デフォルトで0で、-8192から8191の値をとると表されることが多い。

\subsubsection{プログラムチェンジ (PC)}
プログラムチェンジは\emphj{PC}とも書かれ\footnote{PCとだけ書くとPersonal Computerと混同するため、本稿ではなるべくプログラムチェンジと書く。}、そのチャンネルの音色を変更する命令である。ほとんどの場合、後述のCC\texttt{\#}00/32と組み合わせて使う。ただし、\emphj{エレクトーンの場合、Ch.16のPC$=$1からPC$=$16はそれぞれレジストレーションメモリーに対応しており}\footnote{レジストレーションメモリーはsysEX（後述）でも操作できる。}、メモリーしたレジストを呼び出すことに使える。XGボイスの変更に使用し、ELボイスでは使用しない。プログラムチェンジ自体は1から128までの値\footnote{プログラムチェンジの番号は、内部的には0(\texttt{0H})から127(\texttt{7FH})の値。}をとるが、CC\texttt{\#}00/32と組み合わせて使うため、膨大な種類がある。単に「プログラムチェンジ」と言った場合、CC\texttt{\#}00/32と組み合わされて表現される1つのボイスの番地を表すことが多い。

\subsubsection{コントロールチェンジ (CC)}
コントロールチェンジは\emphj{CC}とも書かれ、音量や音の性質を変化させる命令である。2つの値がセットになっており、1つ目の値を\emphj{コントロールチェンジ番号(CC\texttt{\#})}と呼ぶ。2つ目の値がデータ値(0から127をとる)である。CC\texttt{\#}は0から127まで存在するが、よく使われるのは十数種類程度しかない。CCについての詳細な説明は\href{http://quelque.sakura.ne.jp/midi_cc.html}{コントロールチェンジ一覧表}\footnote{\url{http://quelque.sakura.ne.jp/midi_cc.html}}などを参照してほしい。多くのCCがXGボイス（Ch.5-Ch.14）にしか対応していないが、CC\texttt{\#}04 フットコントローラーとCC\texttt{\#}11 エクスプレッションはエレクトーン本体にコントローラーがついており、ELボイスの操作で使うことができる\cite{MIDIリファレンス}。それ以外は基本的にXGボイスの調節で使うと考えて構わない。以下、エレクトーン奏者が使うと思われる代表的なCCを列挙する。

\begin{description}
\item[\emphj{CC\texttt{\#}00/32 バンクセレクト}]\

プログラムチェンジで大まかな音色を指定し、CC\texttt{\#}00でそのサブカテゴリを指定、CC\texttt{\#}32でさらにそのサブカテゴリを指定する。XGボイスの音色指定で使う。CC\texttt{\#}00→CC\texttt{\#}32→プログラムチェンジの順に送信する。エレクトーンのXGボイスリストは、公式には発表されておらず、\href{http://www.comcom2.com/lib/els_ext_xg_voice_list.html}{株式会社コムコムのデータライブラリ}\footnote{\url{http://www.comcom2.com/lib/els_ext_xg_voice_list.html}}などで入手する。
\item[\emphj{CC\texttt{\#}01 モジュレーション}]\

多くの場合、ビブラートの強さを指定する。

\item[\emphj{CC\texttt{\#}04 フットコントローラー}]\

\emphj{ELボイスで使う。}セカンドエクスプレッションペダルの値。エレクトーンの場合、Ch.4(リード分離の場合)またはCh.16の命令のみボイスに作用する。

\item[\emphj{CC\texttt{\#}06 データエントリー}]\

CC\texttt{\#}98/99/100/101と一緒に使う。説明はそちらを参照してほしい。

\item[\emphj{CC\texttt{\#}07 ボリューム}]\

チャンネルのボリュームを指定する。CC\texttt{\#}11 エクスプレッションと挙動はほとんど同じだが、CC\texttt{\#}07はパート間の音量バランス調整で使い、ミキサー的な役割を担う。通常はセットアップ小節でのみ設定し、曲中では動かさない。デフォルトはCC\texttt{\#}07=100。

\item[\emphj{CC\texttt{\#}10 パン}]\

チャンネルのパンを指定する。CC\texttt{\#}10$=$0でパンを左に全振りした状態になる。中央はCC\texttt{\#}10$=$64。

\item[\emphj{CC\texttt{\#}11 エクスプレッション}]\

\emphj{ELボイス、XGボイス両方で使う。}エクスプレッションペダルの値。音量の抑揚表現やアクセントのために用いる。CC\texttt{\#}07と異なり、曲中で連続的に動かす用途を想定されている。デフォルトはCC\texttt{\#}11=127。XGボイス(Ch.5からCh.14)およびELボイス(Ch.16)で使う。

\item[\emphj{CC\texttt{\#}64 サスティン}]\

サスティンペダル。64以上でオン、未満でオフ。通常は0または127の値のみ使う。

\item[\emphj{CC\texttt{\#}65 ポルタメント}]\

ポルタメントとは、2つの異なるノートを演奏したときに、その間の音程を滑らかにつなぐ奏法。64以上でオン、未満でオフ。通常は0または127の値のみ使う。

\item[\emphj{CC\texttt{\#}71 レゾナンス}]\

CC\texttt{\#}74 ブライトネスで指定した周波数の周りの周波数特性を変えて、特徴的な音色を出す。64で効果なし。

\item[\emphj{CC\texttt{\#}74 ブライトネス}]\

ローパスフィルターをかけて高音を削ることで音の明るさを調整する。64で効果なし。それより上げるとカット周波数が高くなり高音が多くなり、下げるとカット周波数が低くなり高音が少なくなる。

\item[\emphj{CC\texttt{\#}72 リリースタイム}]
\item[\emphj{CC\texttt{\#}73 アタックタイム}]
\item[\emphj{CC\texttt{\#}75 ディケイタイム}]\

エンベロープの調整をする。64で効果なし。上げるとタイムが長くなり、下げるとタイムが短くなる。エンベロープについての解説は\href{https://ja.wikipedia.org/wiki/ADSR}{Wikipedia}\footnote{\url{https://ja.wikipedia.org/wiki/ADSR}}などにある。古典的なシンセサイザーはアタックタイム・ディケイタイム・サスティンレベル・リリースタイムの4つのパラメータを使って、波形の時間的な包絡線（エンベロープ）を設計する。このそれぞれのパラメータの頭文字を取って、エンベロープをADSRと呼ぶことがある。これらADSRはシンセサイザーの基本であるため、電子楽器使いなら知っておくべきである。また、\href{https://wakmin.blog.fc2.com/blog-entry-11.html}{ドラムキットにかけることで面白い効果}を得られる\cite{wakminblog}。

\item[\emphj{CC\texttt{\#}91-95 エフェクトセンドレベル}]\

エフェクトをどれくらいかけるかを設定する。エレクトーンで使うのは、CC\texttt{\#}91 リバーブ、CC\texttt{\#}93 コーラス、CC\texttt{\#}94 バリエーションである。これらはsysEX（後述）でリバーブ・コーラス・バリエーションの種類を決めておいて、CC\texttt{\#}91-95でかかり具合を調節する形で使う。リバーブの種類はレジスト全体設定になるため、XGボイスそれぞれで別々のリバーブタイプを設定することはできない\href{http://els01stylefile.music.coocan.jp/Stagea_Style/P0605.htm}{【6-5】}（スタイル入門講座へのリンク）。リバーブのデフォルトは40で、他は0。

\item[\emphj{CC\texttt{\#}98/99 NRPN（ノンレジスタードパラメータナンバー）}]\

NRPNは、GM規格によって動作が定義されていない、機器固有の命令を送信するために使われる。CC\texttt{\#}98とCC\texttt{\#}99の組み合わせで命令の種類を決定し、CC\texttt{\#}06でその値を送信する。命令の種類を指定した後は、CC\texttt{\#}06だけでその値を弄ることができる。値の調整が終わった後は、後述のRPNヌルを送信して、誤作動を防止する。エレクトーンにおいてNRPNはXGボイスのみ使われ、その動作の定義はXG仕様書に書いてある\cite{XG仕様}。

\item[\emphj{CC\texttt{\#}100/101 RPN（レジスタードパラメータナンバー）}]\

RPNはNRPNとは違い、GM規格で動作が定義されているようなチャンネル設定を行う。CC\texttt{\#}100とCC\texttt{\#}101の組み合わせで命令の種類を決定し、CC\texttt{\#}06でその値を送信する。命令の種類を指定した後は、CC\texttt{\#}06だけでその値を弄ることができる。値の調整が終わった後は、RPNヌルを送信して、誤作動を防止する。RPNの動作定義は表\ref{tableRPN}の通り。
\begin{table}[h]
\caption{RPNの定義}
\label{tableRPN}
\centering
\begin{tabular}{cccc}
CC\texttt{\#}101 & CC\texttt{\#}100 & 動作 & 説明 \\
\hline
00 & 00 & ピッチベンド感度 & ピッチベンドの効きの強さを指定する。\\
00 & 01 & チャンネルファインチューン & ピッチを微量調節する。\\
00 & 02 & チャンネルコースチューン & ピッチを調節する。\\
00 & 05 & モジュレーションデプスレンジ & モジュレーションのビブラートの幅を調節する。\\
127 & 127 & RPNヌル & RPNのターゲットを指定していない状態にする。\\
\hline
\end{tabular}
\end{table}

\end{description}

\subsection{MIDIシステムメッセージ}

MIDIシステムメッセージは、演奏情報以外の楽器全体に関わるMIDIメッセージである。（チャンネルメッセージではないため、当然ながら）チャンネルの概念はない。\emphj{システムコモンメッセージ}と\emphj{システムリアルタイムメッセージ}、\emphj{システムエクスクルーシブメッセージ}に分けられる。

\subsubsection{システムコモンメッセージ}
sysEX（後述）の開始コードと終了コード、および複数のMIDI機器を同期させて演奏するためのメッセージ群である。少なくとも私はそこまで重要ではないと思うため、割愛する。興味のある読者はMIDI規格書を参照してほしい。

\subsubsection{システムリアルタイムメッセージ}
短いバイト数で、優先度も高く設定されており、リアルタイム性を保証するメッセージ群である。このメッセージが来ると、受信機器は現在の処理に割り込んで処理しなければならないとされている。こちらについても全ては解説せず、重要だと思う3つについて説明する。

\begin{description}
\item[\emphj{スタート}]\

エレクトーンではリズムスタートとして扱われる。

\item[\emphj{ストップ}]\

同様に、リズムストップとして扱われる。

\item[\emphj{アクティブセンシング}]\

接続ができているかの確認用の信号。演奏の途中でMIDIケーブルが抜けてしまった場合、ノートオフ命令が届かずに音が鳴り続けてしまうなどの問題が起こりうる。これを防止するために、まともなMIDI機器は接続中に常に一定の間隔でアクティブセンシングを送り続けており、受信側はアクティブセンシングが消えた段階でノートをオフしたり、リズムをストップしたりする\footnote{外部MIDI鍵盤とELS-02Cとを繋いで演奏していて、外部鍵盤を接続したELのリズムが勝手に止まるのはアクティブセンシング(と、勝手に抜けるMIDI端子)のせいである。}。
\end{description}

\subsubsection{システムエクスクルーシブメッセージ (sysEX)}
システムエクスクルーシブメッセージは\emphj{sysEX}とも書かれ、メーカーや機器ごとに特有の命令を書くためのメッセージである。GMでは\texttt{F0H}から始まり\texttt{F7H}で終わることしか定義されていない。

ELS-02シリーズのMIDIリファレンス\cite{MIDIリファレンス}を参照すれば、\emphj{エレクトーンのほぼ\footnote{ほぼ全て、の「ほぼ」について、例えばライトフットスイッチの命令がMIDIリファレンスに見当たらない。他にも操作できない操作子が存在するかもしれない。}全ての命令をsysEXで制御できる}ことがわかる。しかもエレクトーンが対応しているsysEXはこれだけではなく、\emphj{XG規格のsysEXはここに載っていないし、公表されているXG規格に載っていないXGパラメータも存在する}\footnote{ヤマハ公式サイトから入手できるXG規格書\cite{XG仕様}は1999年のもので、ELS-01（2004年）よりも昔である。当然、01シリーズで追加されたXGのsysEXはXG規格に載っていない。しかも、ELS-01シリーズの取扱説明書にも載っていない。このため、ELSシリーズのXG規格周りは完全にブラックボックス化している。本稿を書くモチベーションは、このブラックボックスと化したXGやスタイルの周りの仕様をまとめ、分かりやすく伝えることにある。}\footnote{機器専用命令で、取扱説明書\cite{取説}やMIDIリファレンス\cite{MIDIリファレンス}に掲載されていないsysEXが存在する。たとえば、sysEXを送信することでエレクトーン本体パネルのスクリーンショットが可能である。}。この膨大な種類の命令が存在するおかげで、MIDIを駆使することによってしかできないパフォーマンスが可能になる。例えば、レジストレーションメモリーを消費せずに、8つのボイス全てのエフェクトパラメータを同時に操作できたり、セカンドエクスプレッションペダルでELボイスのローパスフィルターのカット周波数を操作できたりする。

このように、sysEXをうまく活用することで表現の幅がグッと広がる。MIDIリファレンスを眺めながら、どのような工夫ができそうか考えてみてほしい。

\subsection{スタンダードMIDIファイル (SMF)}
これまでのMIDIメッセージの説明は、全てリアルタイムな演奏情報のやり取りのための約束である。これとは対照的に、\emphj{スタンダードMIDIファイル(SMF)}は、あらかじめMIDIメッセージを保存しておいて、順次送信や再生をするための規格である。

エレクトーンでMDR録音をしたファイルをパソコンで覗くと、（バルクファイル「.B00」の他に）MIDIファイル「.MID」が確認できる。この「.MID」ファイルが、SMFである。世の中に出す「きちんとした」SMFには様々な取り決めがあるが、XGサポートやスタイルファイルの製作に用いる程度にしか使わないのであれば、次の点を理解しておけば良い。
\begin{itemize}
\item SMFにはフォーマット0、1、2の3種類があり\footnote{フォーマット0は1トラックで16チャンネル分のデータを格納する。フォーマット1はトラック毎に情報を独立して持っており、マルチトラックとして編集ができるほか、1つのチャンネルに複数のトラックを対応させられる。フォーマット2は複数の曲を1つのデータに格納できるらしいが、普及しておらず、私も全くわからない。}、XGサポートやスタイルファイルは\emphj{フォーマット0}で製作する。
\item SMFが処理できる最小の時間単位を\emphj{分解能}と呼び、この分解能の最小単位のことを\emphj{Tick}と呼ぶ。Dominoを初めとする多くのMIDIシーケンサーにおいて、一般的に分解能は1/480四分音符がよく用いられる。エレクトーンの場合、MDR録音したデータの分解能は1/480四分音符であり、リズムパターンプログラムやスタイルの分解能は1/1920四分音符である（ただし、エレクトーンがリズムパターンプログラムで表示する見掛け上の分解能は1/480四分音符である）\footnotemark 。
\item できるだけMIDIメッセージが同じタイミングに重複しないように、メッセージ間は最低1 Tickずつインターバルを空けるのが望ましい。
\end{itemize}
\footnotetext{スタイルにおけるエレクトーンの分解能が1/1920四分音符であることについて、スタイル入門講座が解説をしている\href{http://els01stylefile.music.coocan.jp/Stagea_Style/Stagea_Style_P116.htm}{【10-116】}。また、後述のEL Data Analyzerで切り出したスタイルを開いても、分解能が1/1920四分音符であることが確認できる。たとえ480でスタイルを自作しても、エレクトーン側で1920に自動的に再計算して読み込まれるため、この仕様の差について注意する必要はない。}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\clearpage

\section{XGサポートの作り方}
既に図\ref{figelch}で示したように、エレクトーンのMDR録音機能を使って記録できるMIDIチャンネルメッセージは、上鍵盤(Ch.1)、下鍵盤(Ch.2)、足鍵盤(Ch.3)、上鍵盤リードボイス(Ch.4)、キーボードパーカッション(Ch.15)、コントロール(Ch.16)である。これら以外のチャンネル(Ch.5-14)は、エレクトーン単体では演奏に使うことはできないが、エレクトーンのMDR機能を使って、XGサポートデータが記録されているSMFを再生することで使うことができる。このようにして、Ch.5-14も使って自動演奏や演奏補助をすることを、本稿では\emphj{XGサポート}と呼ぶ。

\emphj{この章では、エレクトーンの自動演奏・演奏支援であるXGサポートを作る方法について説明する}。加えて、WindowsでMIDIを扱う上で非常に頼りになるフリーソフトであるDominoの使い方も、XGサポートを作りながら解説する。

\begin{itembox}{Dominoの参考書}
\begin{itemize}

\item Domino マニュアル

Dominoに付属しているマニュアルである。最も信頼できる参考書である。

\item XG楽曲データ製作の指針\cite{XG指針}

XGデータを作成する際に気をつけるべきことがまとまっているYAMAHA製のテキスト。XGサポートを作るなら一度は目を通しておくべきであろう。

\item Dr.青山のXG解体新書\cite{Dr青}

YAMAHAの読み物。主にDTM用XG音源のフラグシップモデルであったMUシリーズの仕様について解説してある。ELS-02はMU50相当のXG音源再生能力・拡張XG音源を搭載しており、XGの基本的な使用は共通していると思われる。これを読むことができれば、XGについてさらに深い知識を得られる。


\end{itemize}
\end{itembox}

\subsection{Dominoの導入}
\emphj{Domino}はたかぼー氏によって製作されたWindows用MIDIシーケンサである。\href{https://takabosoft.com/domino}{公式サイト}\footnote{\url{https://takabosoft.com/domino}}から入手できる。本稿執筆時点での最新バージョンは1.44であるため、このバージョンのDominoを用いて解説を進める。他のMIDIシーケンサーでも同様のことはできるが、エレクトーン用に製作された音源定義ファイル（後述）があるため、Dominoを使うことを勧める。
\subsubsection{音源定義ファイル}

\emphj{音源定義ファイル}とは、楽器固有のプログラムチェンジやsysEXなどを手軽に扱えるようにするための、Domino専用のモジュールである。MIDIの低級な部分\footnote{ここでの「低級」は「機械語に近い」という意味である。MIDIリファレンス\cite{MIDIリファレンス}を見ればわかるように、本来的にはMIDIの制御は数字の羅列を取り扱う必要があるが、音源定義ファイルを使うことで、そのような面倒な部分を意識せずとも良くなる。}を意識することなくMIDI編集を行うことができるようになる。すずとも氏（\href{https://twitter.com/SuzuTomo2001}{@SuzuTomo2001}）と私が製作した。\href{https://www.kamekyame.com/el/domino-define}{公式サイト}\footnote{\url{https://www.kamekyame.com/el/domino-define}}からダウンロードできる。本稿ではこの音源定義ファイルを導入する。

\subsubsection{Dominoの初期設定}
\paragraph{エレクトーンとパソコンの接続}\

まず、パソコンとエレクトーンをUSBケーブルで接続する。ELS-02/02C/02X, ELC-02, ELB-02の場合\footnote{その他のエレクトーンの場合は、ヤマハ公式からUSB-MIDI Driverをインストールする必要がある。詳しくは、\href{https://yamaha.custhelp.com/app/answers/detail/a_id/10045/}{ヤマハ公式のQ\&A}\footnote{\url{https://yamaha.custhelp.com/app/answers/detail/a_id/10045/}}を参照せよ。}は、USB Type A-Bケーブル（俗にプリンタケーブルと呼ばれる）でエレクトーンの「TO HOST」端子に接続し、パソコンにエレクトーンを認識させる（図\ref{figELUSB}）。

\begin{figure}[h]
  \centering
  \includegraphics[width=8cm]{usbtypeab.png}
  \caption{エレクトーンのTO HOST端子とパソコンを接続する。エレクトーンとはUSBでMIDIをやりとりできる。画像は\href{https://yamaha.custhelp.com/app/answers/detail/a_id/1316/related/1}{ヤマハQ\&Aサイト}より引用。}
  \label{figELUSB}
\end{figure}

\paragraph{音源定義ファイルの導入}\

エレクトーンの接続が終わったら、以下の通りに音源定義ファイルを導入する。\href{https://www.kamekyame.com/el/domino-define}{音源定義ファイルの公式サイト}からダウンロードしたelectone.xmlをDominoのModuleフォルダの中に移動させ、Domino.exeをダブルクリックして起動する。Dominoのメニューから「ファイル(F)」$\rightarrow$「環境設定(E)...」を開く（もしくはF12キーを押す）。現れた環境設定ウィンドウの左側のカテゴリから「MIDI-OUT」を選択し、ポートAの音源定義ファイルを「YAMAHA」フォルダの中の「Electone」に設定すれば、導入が完了する（図\ref{figDominoSetup}）。

\begin{figure}[h]
  \centering
  \includegraphics[scale=0.5]{dominosetup_gray.png}
  \caption{DominoのMIDI-OUT環境設定の例。初期設定が終われば以降は設定する必要はない。}
  \label{figDominoSetup}
\end{figure}

\paragraph{MIDI-OUTの設定}\

同じ画面でMIDI-OUTの設定を行う。MIDI-OUTデバイスとして「ELS-02C」のようなエレクトーンが選択できるようになっているから、ポートAのMIDI-OUTデバイスをエレクトーンにしよう（図\ref{figDominoSetup}）。これにより、Dominoで入力した（ポートAの）MIDIデータはエレクトーンに送信されるようになった。もしもエレクトーンが表示されていなければ、Dominoを一旦終了して、エレクトーンとパソコンをUSBで接続してからDominoを再起動する。エレクトーンをパソコンから操作しようとするときは、\emphj{エレクトーンとパソコンをUSBで接続してからDominoを起動}しなければならないことを覚えておこう。

\paragraph{MIDI-INの設定}\

必要であればMIDI-INの設定を行う\footnote{私はノートの打ち込みは全てCubaseで行っているため、MIDI-INの設定はしていない。Cubaseで打ち込みをするには次のようにすれば良い：Cubaseで打ち込んだデータをSMFとして書き出す。Dominoを2台立ち上げ、片方はスタイルファイルやXGサポートのフォーマットを整え、もう片方でCubaseのMIDIを開く。Dominoはウィンドウ間でのコピーアンドペーストができるため、CubaseのMIDIを全選択してコピーし、もう片方のDominoに貼り付ける。}。MIDI-INの設定を行うと、エレクトーンを含むMIDIキーボードによる演奏をDominoで認識できるようになり、打ち込みの速度が飛躍的に向上する。ただし、エレクトーンはオクターブシフトができず、特にドラムの打ち込みに難があるため、エレクトーン以外のMIDIキーボードを新しく準備することを勧める。

\paragraph{その他の設定}\

以上の他に、（必須ではないが）設定しておくと作業が捗る設定が複数存在する。本稿では\emphj{以下に示す設定を設定済みとして解説を進める}。設定しておくことを強く勧める。
\begin{itemize}
  \item メニューバーの「表示(V)」$\rightarrow$ 「トラックセレクトペイン(A)」を押し、「トラックセレクトペイン」を表示する。これを表示することにより複数のトラックの行き来がGUIで簡単に行えるようになる。
  \item 全般(1)で「時間の表し方」を「Measure:Beat:Tick」にする。イベントリストで拍が表示されるようになる。
  \item 同じく全般(1)で「オクターブ」を「Note\texttt{\#}60=C3」にする。Note\texttt{\#}60は国際式とヤマハ式でキーが違っており、このように設定するとヤマハ式にできる。
  \item 全般(2)で「マクロ番号の表示」を「表示する」に設定する。\emphj{コントロールチェンジマクロ(CCM)}\footnote{コントロールチェンジマクロ(CCM)とは、RPN/NRPNやsysEXなどの複雑な命令をコントロールチェンジ(CC)のように簡単に取り扱えるように設計されたDominoの機能である。CCは1番から127番までしか存在しないが、CCMは1300番まで使用できるようになっている。本稿ではCCM\texttt{\#}としてCCMの番号を指定する。なお、CCMは音源定義ファイルによって定義されているため、音源定義ファイルが異なれば挙動が全く違うものになる。したがって、\emphj{本稿で紹介したすずとも氏の音源定義ファイル以外を使う場合は、本稿のCCM\texttt{\#}の記述は全く役に立たない}ことに注意してほしい。}の番号が表示されるようになる。
  \item イベントリスト(1)で「コントロールチェンジイベントの番号」を「表示する」に設定する。
  \item 同じくイベントリスト(1)で「リズムノートイベントのノート番号」を「表示する」に設定する。ドラムトラックは打ち込んだノートが楽器名で表示されるが、ここにノートナンバーを付記できる。
\end{itemize}

\subsection{XGサポートを作る}
いよいよXGサポートデータを作っていく。この節では詳細な仕様の解説はせずに、XGサポートを作るための最小の手順を解説する。

なお、前提として\emphj{USBメモリの中にプロテクトソングは無い方が良い}\footnote{プロテクトソングは鍵付きのアイコンで表される。ヤマハ公式が配布しているソングや有料で購入したソングなどがこれに含まれる。なお、\emphj{プロテクトソングをパソコンから適当に触ってはいけない}。移動するには「ヤマハミュージックソフトダウンローダー」というソフトが必要である。今からソングをエクスプローラで細工するため、事故防止のために、プロテクトソングが1つも入っていないUSBメモリを準備した方が良い。}。また、\emphj{Windowsの設定で拡張子を表示するように変更しておかなければならない}。また、本稿の内容を実行する場合は、\emphj{本稿の内容を実行して生じる結果について、私が一切の責任を負わない}ことを認めたものとする。

\subsubsection{ファイルの作成}
XGサポートデータはSMFであるため、Dominoなどで白紙から作ることもできるのだが、エレクトーンのMDR機能を用いることで自動で生成されるSMFから作り始めた方が簡単である。そこで本稿では、XGサポートデータの元となるファイルをエレクトーンにてMDR録音することで作成する\footnote{MDR録音によって得られるデータのうち、XGサポートデータ作成において欲しいデータは、\emphj{リセット系}、\emphj{拍子}、\emphj{テンポ}、\emphj{シーケンスON}、\emphj{リズムスタート}、\emphj{リズムストップ}、\emphj{End of Track}である。}。

曲の始めから終わりまでのソングデータ（シーケンスを含む）を完成させた後、このソングだけが入っているようなフォルダをエレクトーン上で用意する。以下ではこのフォルダを「\texttt{XGSupportFolder}」と名付けたことにする。

図\ref{figMDRrec}のように、このソングに演奏を付け足すMDR録音をする。録音待機の画面で録音するチャンネルを選択できるので、「コントロール」だけを録音するように設定し\footnote{コントロール以外の録音をONにした場合、Ch.1には上鍵盤、Ch.2には下鍵盤、Ch.3にはペダル鍵盤、Ch.4にはリード1、Ch.15にはキーボードパーカッションが録音される。}、録音を開始する。録音中にシーケンスをONにしてリズムスタートさせ、楽曲が終わるまで（演奏せずに）待つ。シーケンスが終わったら録音を停止する。こうすることにより、曲の開始時刻（リズムスタート）と終了時刻、および拍子の情報がSMFに書き込まれる。なお、シーケンス関連で書き込まれるのは、シーケンスのON/OFFおよびリズムのStart/Stopのみであり、リズムパターンのノートやレジストチェンジが書き込まれることはない\footnote{シーケンスの情報はエレクトーン内部やバルクファイルで持っており、SMFには書き込まれない。SMFには、シーケンスの開始・終了のみが書き込まれる。そのため、作成したSMFのCh.9や10（通常アドドラム・メインドラムとして使用される）にリズムパターンは打ち込まれることはない。エレクトーンでこのSMFを再生した時のみ、紐づけられたレジストデータに入っているシーケンスが再生されることになり、リズムパターンやレジストチェンジが再生される。}。

\begin{figure}[h]
  \centering
  \includegraphics[keepaspectratio,width=150mm]{figMDR.pdf}
  \caption{XGサポートの付け方。①1つのソングだけが入ったフォルダを用意し、②そのソングに録音を付け足す。③コントロールだけを録音するよう設定し（他についてはOFFまたはPLAYにする）、シーケンスを曲の終わりまで流す。}
  \label{figMDRrec}
\end{figure}

\newpage

\begin{wrapfigure}[8]{r}[3mm]{45mm}
  \centering
  \includegraphics[keepaspectratio,width=35mm]{figdirectory.pdf}
  \caption{ソング内の構造。}
  \label{figDirectory}
\end{wrapfigure}

次に先ほどの録音データが入っているUSBメモリをパソコンで開き、ソングデータを確認してみよう。図\ref{figDirectory}のように、ソングが1つだけ入っているフォルダ（\texttt{XGSupportFolder}）の中に「\texttt{ELS_SONG.NAM}」と「\texttt{SONG_001}」という名前のフォルダがある。\texttt{SONG_001}の中にある「\texttt{MDR_000.MID}」が、演奏情報が入っているSMFである。なお、「\texttt{REG_00X.B00}」(\texttt{X}は数字が入る)は\emphj{バルクファイル}といって、エレクトーンのレジストデータ\footnote{.B00ファイルにはレジストデータ、レジストシフトの順番、ユーザーボイス、オルガンフルート、シーケンス、ユーザーリズムが連結して入っている\cite{B00}。余談だが、ユーザーリズムの手前までは固定長データで、ユーザーリズムからは可変長になるため、01シリーズのユーザーリズムデータ（スタイルという）の切り出しは容易であった（スタイルは基本的にはSMFであり、SMFデータは\texttt{4DH 54H 68H 64H}から始まるため、これを探せば良い）。02シリーズになると、拡張フォーマットとしてユーザーリズムデータの後ろに固定長のデータが付く。}が入っている。ネクストレジストを使う場合は2つ以上存在する。

\subsubsection{XGサポートファイル製作の下準備}
\texttt{MDR_000.MID}にXGサポートの情報を書き加えていく前に、Dominoの基本的な使い方を確認しつつ、不必要なデータを削除していこう\footnote{基本的に、不必要なMIDIメッセージは書くべきではない。受信楽器に負担を強いることになるし、編集上邪魔になる。}。

まず、先ほどエレクトーンで作成した演奏データ「\texttt{MDR_000.MID}」をパソコンにコピーした後、Dominoにドラッグアンドドロップすることで開く。開くときに、「MIDIデータを解析してコントロールチェンジマクロを復元しますか？」と聞かれるので、「はい」を選択する。これにより、SMF(.midファイル)からDominoのプロジェクトファイル(.dmsファイル)に変換される。Dominoで編集している途中のファイルや、プロジェクトのバックアップは.dmsファイルで保存する。

読み込みが完了したら、まずメニューバーの「ファイル(F)」$\rightarrow$ 「名前をつけて保存(A)...」（または「Ctrl$+$Shift$+$S」）から、プロジェクトファイルの保存をしよう。保存された.dmsファイルを用いて、以降は編集や保存を行う。

\paragraph{バルクダンプの削除} \ 

\begin{figure}[h]
  \centering
  \includegraphics[keepaspectratio,width=150mm]{domino_gamen.png}
  \caption{Dominoの画面名称。図はDominoマニュアルから引用。}
  \label{figdominogamen}
\end{figure}


最初に［System Setup］の内容を見ていく。図\ref{figdominogamen}画面一番左にある\footnote{トラックセレクトペインが表示されていない人は、「Dominoの初期設定」の節を読み直してほしい。}「トラックセレクトペイン」から、［System Setup］をクリックしよう。すると、表示・編集するトラック（カレントトラックという）が［System Setup］になる。この［System Setup］トラックは、MIDIシステムメッセージの記述に使う。主にsysEXの記述に用いる\footnote{sysEXは動作に時間がかかるため、同一Tickに複数存在してはいけない。そのため、sysEX専用のトラックを用意して各チャンネルトラックにsysEXがばらけないようになっている。}。

［System Setup］のイベントリストを見ると、2つめのイベントとして「Ex:f0h 43h 70h 78h ...」が入っているだろう。このイベントをダブルクリックすると、1画面に表示しきれないほどの大量のメッセージで構成されていることが確認できる。これは\emphj{バルクダンプ}といって、この演奏データ「\texttt{MDR_000.MID}」がエレクトーンで呼び出された際に設定される一番最初のレジストの情報が入っている。しかし、脚注\footnote{バルクダンプデータは非常に大きいメッセージで、MIDI受信ソフトウェアによってはバッファ容量を超過するようである。実際、私がテストデータとしてエレクトーンで作ったSMFをDominoで開いたところ、バルクダンプデータが\texttt{F7H}で終わっていないように見えた。sysEXは必ず\texttt{F7H}で終わる必要があるので、Domino側で処理できていないと思われる。よって、このバルクダンプを放置するとエレクトーン側で誤作動する恐れがあるため、必ず削除しよう。参考：\url{https://wikiwiki.jp/tkbsoft/domino/%E8%A6%81%E6%9C%9B003/207}}で示すように、このデータを残すとエレクトーンが誤作動を起こす恐れがある。イベントリストでクリックして黒く選択した上で、キーボードのdeleteキーを押して\emphj{必ず削除}しよう。

その他、［1206 Bar Signal\footnote{バーシグナルは、エレクトーン本体左手のテンポ液晶の上にあるBAR/BEAT表示の赤いLEDが点灯すると送信される。}］や、［509 Rhythm Stop\footnote{［509 Rhythm Stop］はリズムが止まったときに送信される。シーケンスを組まないなら実用的（手でリズムを止めるのと同等のメッセージ）だが、シーケンスを組んでいればシーケンスの終わりで自動的にリズムが止まるため、この場合は無くても構わない。}］なども削除できる。必要に応じて削除しよう。

\paragraph{Ch.16のメッセージの削除} \ 

必要であればCh.16のメッセージを削除する。画面左のトラックセレクトペインから、［Ch.16］を選択すると、［011 Expression］や［004 2nd Expression］が表示されているだろう。これらはエクスプレッションペダルやセカンドエクスプレッションペダルの入力の記録である。録音中にエレクトーンを操作していれば、それ以外にも様々なコントロールが記録される。XGサポートにおいて再生して欲しくないコントロールがあれば、ここを削除すると良いだろう\footnote{なお、XGサポート再生中はエレクトーンのデフォルト設定ではエクスプレッションペダルが操作できない（Ch.16に追従する）。これを操作可能にするには、エレクトーン本体液晶右側のUTILITYボタンを押し、画面上部のタブメニューよりMIDIを選択し、エクスプレッションペダルを「インターナル」に設定すれば良い。}。

\subsubsection{XGサポートデータの記述}
ここまでで下準備が終わったので、サポートデータを打ち込んでいくことができる。

\paragraph{XGモードへの変更} \ 

起動した時点ではエレクトーンは\emphj{ELモード}である。これに対し、取扱説明書には載っていないが、\emphj{XGモード}というモードもエレクトーンにはある。XGモードはDTM用音源と互換性のあるモードで、エレクトーンをXG音源装置として用いることができるようになる。外部からのXG命令を受け付けるようにするために、エレクトーンをXGモードに変更する。なお、現在のモードがどちらなのかをエレクトーン上で確認することはできない。

［System Setup］トラックを開いて、一番最初のメッセージである［1205 EL ON］をダブルクリックする。これを［205 XG System ON］に変更して、ウィンドウ左下の「テスト送信」を押してからOKを押す。これにより、エレクトーンがXGモードになった。XGモードにしておかないと、外部からXG拡張音源のプログラムチェンジを送信したときにXGボイスに変更されない。\emphj{XG音源の選択の際にはXGモードにしておく必要がある}。

XGサポートの打ち込みが終わった後は、冒頭のリセット命令を［1205 EL ON］に戻すことができる。戻した場合は、ELモードの状態で\footnote{ELモードであっても、MDR機能を使って再生している場合は、XGモードと同様にXG拡張音源が再生される。}XGサポートが再生される。ただし、
エレクトーンがELモードのとき、受信したチャンネルメッセージは表\ref{EL受信チャンネル}のように、ELボイスとXGボイスに分かれて作用する。一方、XGモードのとき、受信したチャンネルメッセージは全てXGボイスに作用する\footnote{XGモードのときも、上鍵盤の演奏は上鍵盤ボイスで再生される。2つのモードは、あくまでも外部から受信したチャンネルメッセージをどのボイスで再生するかという違いであって、たとえXGモードだとしてもXGボイスをエレクトーンの鍵盤で演奏できるようにはならない。}。XGサポートでXGボイスだけを打ち込むならばXGモードで十分だが、たとえば「Ch.1から4もMIDIを打ち込んでおいて、ELボイスを同時に鳴らしたい」という場合にELモードが有効である。

\begin{table}[htbp]
  \caption{モードによって受信したチャンネルメッセージが作用するボイスが異なる。}
  \label{EL受信チャンネル}
  \centering
  \begin{tabular}{c|cc}
  受信チャンネル & ELモードの場合 & XGモードの場合 \\
  \hline
  Ch.1 & 上鍵盤ボイス & XGボイス\\
  Ch.2 & 下鍵盤ボイス & XGボイス\\
  Ch.3 & 足鍵盤ボイス & XGボイス\\
  Ch.4 & リードボイス\footnotemark & XGボイス\\
  Ch.5, \dots , 14 & XGボイス & XGボイス\\
  Ch.15 & キーボードパーカッション & XGボイス\\
  Ch.16 & コントロール & XGボイス\\
  \hline
  \end{tabular}
  \end{table}
\footnotetext{エレクトーン本体の設定画面でリードボイス発音設定をエクスターナルにしたときに限り、受信したCh.4がリードボイスで再生される。}

ところで、［205 XG System ON］や、［1205 EL ON］を送信するとエレクトーンのモードが変わり、\emphj{XGボイスの設定がリセット}される。これらのモード指定がないSMFを再生すると、チャンネル設定などがその前に再生したソングのままになってしまい、意図した効果が出せない恐れがある。事故を防ぐために、\emphj{SMFの最初には必ず、モードを指定する命令を書いて、機器の初期化をしなければならない}\footnote{この初期化には時間がかかるため、本来は30 Tickほど（XG規格では50 msほどの実行時間であると説明されている\cite{XG仕様}）空白を設けて次のメッセージを書くのが良いとされる。ところがエレクトーンで生成したSMFはノータイムで次の命令が書いてあり、あるべき空白が存在しない。エレクトーンは処理能力が高いのか、もしくはセットアップ小節の内容は順次実行されるようになっており、インターバルが必要ないのかもしれない。}。

また、演奏会などでXGモードにしたまま他の人が演奏すると、例えば外部MIDIキーボードをエレクトーンに接続してELボイスを鳴らそうとしても、XGボイスが再生されてしまう。エレクトーンは基本的にELモードで使うべきであるから、XGサポートデータが終わったら［1205 EL ON］をしてELモードに戻しておこう。ELモードでXGサポートデータを再生する場合は［1205 EL ON］は必要ないが、そのような場合分けは事故の原因となりうるため、再生するモードにかかわらず、\red{XGサポートデータの一番最後には［1205 EL ON］を入れることを強く要請する。}
\clearpage

\paragraph{楽器指定（プログラムチェンジ）} \ 

次はXGサポートに用いる楽器を指定しよう。

トラックを［Ch.5］に合わせ\footnote{XGサポートをCh.5から打ち込むのは、Ch.1-4がエレクトーンの鍵盤に対応しており、ELモードの場合にELボイスが鳴るためである。XGモードで再生することが確定していれば、Ch.1から打ち込み始めても構わない。}、ピアノロール上で1小節目の3拍目をクリックし、演奏線を1:3:0\footnote{本稿ではSMFにおける時刻を「Measure:Beat:Tick」と表記することにする。1:3:0であれば、1小節目3拍目0Tickである。}に合わせる。そうしたら、メニューバーから「挿入(I)」$\rightarrow$ 「プログラムチェンジ(P)」を選択する。イベントリストに［Program Change］が挿入されるので、その文字列をダブルクリックしよう。するとプログラムチェンジを指定するウィンドウが表示される。（エレクトーンを繋いでいれば）このウィンドウで音色を選択するとエレクトーンからXGボイスが鳴るはずなので、それを聞きながら好きな音色を選択しよう。

\paragraph{その他のチャンネルセットアップ} \ 

プログラムチェンジの次はXGボイス用のチャンネルセットアップを行おう。

まず、ピアノロールを適当にクリックしよう。このときペンツールになっていた場合は、ノートが打ち込まれてしまうが、そのノートはダブルクリックで消そう。ピアノロールをクリックしたことにより、ピアノロールの演奏線上でコントロールチェンジの挿入が行われるようになった。次に画面上部の「MEAS」をクリックして演奏位置を1:3:10に指定する\footnote{今回はプログラムチェンジを1:3:0で行ったので、それより後でチャンネルセットアップを行う必要がある。そのため、今回は1:3:10でチャンネルセットアップを開始するように解説した。プログラムチェンジよりも後にチャンネルセットアップを行っていればどこで入力しても良いが、最初の発音（ノートオン）はセットアップの終わりから余裕を持ってインターバルを取るのが良い。}。そうしたらメニューバーから「挿入(I)」$\rightarrow$ 「コントロールチェンジ（複数）(G)」を選ぶ。挿入するコントロールチェンジを選択できるので、CC\texttt{\#}7, 11, 91, 93のチェックボックスにチェックを付けよう\footnote{コントロールチェンジ（複数）のウィンドウ左下にあるStepはイベント間のTick数を指定できる。デフォルトでは10 Stepとなっており、これで問題ないが、1小節目（セットアップ小節）の中に収まりきらないようであれば、間隔を詰めるために1 Stepなどに設定できる。}。OKを押すとイベントリストに先ほど選択したCCが追加されるので、1:3:10から順番にCCが追加されていることを確認したら、追加されたCCをダブルクリックして、表\ref{tabXGchannelsetup}に示されるデフォルトの値を打ち込んでいく。

\begin{table}[htbp]
  \caption{記述が義務付けられているチャンネルセットアップのコントロールチェンジ\cite{XG指針}。}
  \label{tabXGchannelsetup}
  \centering
  \begin{tabular}{ccc}
  CC\texttt{\#} & 説明 & デフォルトの値\cite{XG仕様}\\
  \hline
  \texttt{\#}7 & Volume & 100 \\
  \texttt{\#}11 & Expression & 127 \\
  \texttt{\#}91 & Reverb Send & 40 \\
  \texttt{\#}93 & Chorus Send & 0\\
  \texttt{\#}94 & Variation Send\footnotemark & 0\\
  \hline
  \end{tabular}
\end{table}
\footnotetext{チャンネルセットアップでCC\texttt{\#}94 Variationを入力する必要があるのはバリエーションエフェクトがシステムエフェクトの場合のみである。システムエフェクトに関する解説は次の節で行う。}

指定しなかったデータはデフォルトの値で補完されるため、MIDIデータが重くならないように必要のないデータは記述しない方が良い。ただし、表\ref{tabXGchannelsetup}に示すデータは、デフォルトであっても記述することになっている\footnote{XGデータ製作指針\cite{XG指針}で示されているから説明しているが、CC\texttt{\#}7, 11, 91, 93のイベントの入力をサボった場合はデフォルトの値で補完されるようなので、自分で使うだけならこの段取りは必要ないかもしれない。}。記述することが指示されているMIDIメッセージ（表\ref{tabXGchannelsetup}）以外にも、CC\texttt{\#}10 Pan(デフォルト64)、CC\texttt{\#}74 Brightness(デフォルト64)などを入力できる。これらのCCを使って音作りをしたい場合は、同様にセットアップで入力すると良い。デフォルト値はXGの仕様\cite{XG仕様}などで確認する。

このように、SMFにおいて1小節目は\emphj{セットアップ小節}として用いられる。原則としてノートは打ち込まず、システムセットアップやチャンネルセットアップを入力する。今回は［Ch.5］トラックだけ解説しているが、複数のチャンネルを使って打ち込みをするなら、全てのチャンネルでチャンネルセットアップを行わなくてはならない。

\paragraph{ステップ録音} \ 

いよいよノートを打ち込んでいこう。ピアノロール上でマウスでカチカチと打ち込んでもいいが、ここではMIDIキーボードを用いて行う\emphj{ステップ録音}を解説する。ステップ録音とは、一音（一和音）ずつ時間を止めながら演奏を録音できる機能である。ゆっくりと自分のペースで演奏できるため、無駄なく正確にノートを打ち込むことができる。MIDI-INの設定をしていればエレクトーンを初めとしたMIDIキーボードを使うことができるし、そうでなくともパソコンのqwertyキーボード\footnote{ここでqwertyキーボードと呼んでいるものは、パソコンで文字などを入力するための装置である。単に「キーボード」と書くと演奏用の装置と区別がつかないため、「qwerty」を語頭に付けた。}を用いて打ち込むこともできる。

ステップ録音ウィンドウを表示するには、メニューバーの「編集(E)」$\rightarrow$ 「ステップ録音(S)」を選択するか、もしくは画面上部「MEAS」の右横にある「$\vert\vert$●」アイコンを押す。現れたステップ録音ウィンドウがアクティブなときにMIDIキーボード（もしくは、「PCキーボード」を押すと出てくる鍵盤に対応するキー）を演奏すると、ピアノロールの演奏線の位置に、ステップ録音ウィンドウで選択されている音価（Step）でノートが打ち込まれる。「PCキーボード」で打ち込んでいる場合は「Velocity」を変更することで打ち込まれるノートのベロシティを変更できるほか、「オクターブ」を変更することでオクターブシフトができる。「Gate(G)」を変更すると、指定した音価に対するゲートタイムの割合を指定できる。PCキーボードで「Ctrl + Z」を入力することでUndoできるほか（Redoは「Ctrl + Y」）、矢印キーでStepを移動させることもできる。

［System Setup］トラックを見て、［508 Rhythm Start］のイベントの時刻（おそらく2:1:0であろう\footnote{MDR録音のときの操作のタイミングによっては、Rhythm Startが2:1:0ではないことがある。MDR録音によって記録されるRhythm Startは（時刻のBeat, Tickが0になるように）かなり強力なクオンタイズがかかっているだけで、2:1:0に必ず配置されるわけではない。Rhythm Startが2:1:0になかったとしても（本文の方法と同様に）フレーズを打ち込む時刻をRhythm Startの時刻を基準に計算することで、特に問題はなくXGサポートを打ち込むことができる。}）を確認しよう。そこから計算することで自分がXGサポートを打ち込みたい時刻がわかるだろう。その時刻に演奏線を移動させて、［Ch.5］にステップ録音でフレーズを打ち込もう。

なお、音価の変更にキーボードショートカットを設定しておくことを強く推奨する\footnote{私は楽譜製作ソフトウェアMusescoreのステップ入力と一貫性を保つように、全音符を数字「7」キーに、2分音符を数字「6」キーに、$\cdots$、32分音符を数字「2」キーに設定している。}。ステップ録音ウィンドウの「設定(C)...」からキーボードショートカットを設定できる。慣れてくればマウスを使わずに、リアルタイムで演奏するよりも早く打ち込みできるようになる。

\paragraph{ピアノロール} \

\emphj{ピアノロール}は縦軸にキー、横軸に拍をとった楽譜の表現の一つである。Dominoで打ち込むノートは、基本的にピアノロールかイベントリスト（後述）で編集することになる。

Domino画面左上部のペンのアイコンをクリックするか、またはメニューバーの「ツール(T)」$\rightarrow$ 「ペン(P)」からピアノロール上のマウスポインタを\emphj{ペンツール}として使用できる。この状態でピアノロール上の空白をクリックするとノートを配置できる。配置されたノートの左端か右端をドラッグアンドドロップすることでノートを伸ばすことができる。ダブルクリックでノートを消すこともできる。ノートの配置が\emphj{クオンタイズ}\footnote{クオンタイズとは、MIDIイベントのタイミングを拍のキリのいい場所に揃える機能のことである。}されているときは、Domino画面左上のドロップダウンメニューからクオンタイズの拍を選ぶことができるほか、そのすぐ右のアイコンでクオンタイズをしないようにすることもできる。

ペンアイコンの右は\emphj{選択ツール}である。ピアノロール上でドラッグアンドドロップすると、複数のノートを範囲選択できる。選択した状態でドラッグアンドドロップすれば、移動・縮小・拡大などの操作ができる。また範囲内を右クリックすれば様々な操作が行える。

選択アイコンの右は\emphj{消しゴムツール}である。ピアノロール上で範囲選択し、その中のノートを消すことができる。

\paragraph{イベントグラフ} \ 

\begin{wrapfigure}{r}[5mm]{60mm}
  \centering
  \includegraphics[keepaspectratio,width=50mm]{figEventG.png}
  \caption{イベントグラフの使い方。ベロシティを編集するモードで直線を描くと、配置されているノートのベロシティが描いた直線に沿って指定される。}
  \label{figEventG}
\end{wrapfigure}
ステップ録音やペンツールを使ってノートの情報を打ち込んだら、次はベロシティの調節やエクスプレッションの書き込みなど、ノートではない情報の仕上げをしよう。このときに便利なのが\emphj{イベントグラフ}である。図\ref{figEventG}にベロシティの変更の例を示す。イベントグラフ上で曲線を描くと、その曲線に沿って様々なデータが指定される。

イベントグラフペイン左上で曲線の種類を選択できる。図\ref{figEventG}の例では直線を選択した。他に、フリーハンドやプリセットの曲線を選択できる。また、関数を自分で作り、オリジナルの曲線を設定することもできる。

イベントグラフペイン中央上のプルダウンメニューからは、音源定義ファイルで設定されているCCMとベロシティの中から、イベントグラフで編集するパラメータを指定できる。また、イベントグラフペインの右上には使用頻度の高いパラメータ\footnote{Domino Ver.1.44時点で、アイコンからVelocity, Pitch Bend, Modulation, Expression, Volume, Panpot, Hold, Brightness, Resonance, Master Volumeが指定できる。}がアイコンで指定できるようになっている。

なお、イベントグラフペインは最大2つまで同時に表示できる。メニューバーの「表示(V)」$\rightarrow$ 「イベントグラフペイン1/2」から表示切替が行える。

\subsubsection{XGサポートデータの保存とソング情報の書き換え}
\paragraph{EL ONの配置とEnd of Trackの調節}\

全ての編集が終わったら、\emphj{最後のイベントの後に［System Setup］トラックで［1205 EL ON］を配置する}。［1205 EL ON］は全てのXG設定がリセットされるため、曲の途中で［1205 EL ON］を配置してはならない。必ず曲の最後に［1205 EL ON］を配置する。

［1205 EL ON］を配置したら、キーボードのTabキーを押すか、またはメニューバーの「表示(V)」$\rightarrow$ 「トラックリスト(L)」から\emphj{トラックリスト}を表示する。先程配置した［1205 EL ON］の次の小節に演奏線を合わせ、メニューバーの「イベント(N)」$\rightarrow$ 「End of Trackの調節(D)」を選択して、\emphj{End of Track}\footnote{End of Track とはMIDIデータにおけるトラックの最終時刻である。End of Trackの時刻で、エレクトーンはXGサポートの再生を終了する。}を設定する。これでXGサポートデータは完成である。なお、トラックリストビューから戻るには、もう一度Tabキーを押せば良い。

\paragraph{XGサポートデータの保存}\

プロジェクトファイル（.dmsファイル）はエレクトーンで読み込みできないため、SMFを書き出す必要がある。メニューバーの「ファイル(F)」$\rightarrow$ 「SMF書き出し(M)...」を選び、現れたウィンドウで保存場所と名前を指定する。このとき、\emphj{フォーマットを「format 0」にする}ことを忘れないこと。また、名前は半角アルファベットのみにすることが望ましい。ここでは、例として「\texttt{XGS.MID}」と設定したとする。

\paragraph{USBメモリへの転送とELS\_SONG.NAMの編集}\

\begin{wrapfigure}[9]{r}[3mm]{80mm}
  \centering
  \includegraphics[keepaspectratio,width=75mm]{figXGS.pdf}
  \caption{もともと存在した\texttt{MDR_000.MID}を消去し、作成したXGサポートデータを入れる。}
  \label{figXGS}
\end{wrapfigure}

作成したSMF(\texttt{XGS.MID})を、エレクトーンで録音データを作成した場所に戻す。この際、もともと存在した\texttt{MDR_000.MID}は消去する。

図\ref{figXGS}右のような構造にできたら、\texttt{SONG_001}と同じディレクトリに存在する\texttt{ELS_SONG.NAM}の拡張子を.NAMから.txtに変更する。警告が出る場合があるが、そのまま拡張子を変更しよう\footnote{ELS\_SONG.NAMの拡張子を.txtに変更しなくとも、任意のテキストエディタでこのファイルを開けば良い。ここでは、パソコンに詳しくない読者でも編集が行えるように、拡張子の変更をすることでwindows標準のテキストエディタを呼び出している。}。

拡張子の変更ができたら、\texttt{ELS_SONG.txt}をダブルクリックで開く。開くと、ソース\ref{nam}のような内容が書かれている。
\begin{lstlisting}[caption=ELS\_SONG.NAM（変更前）, label=nam]
  S00X:SONGNAME = SONG_00X 
  S00X:FOLDER = SONG_00X 
  S00X:SECURITY = OFF 
  S00X:MODEL =  
  S00X:PART_UK = OFF 
  S00X:PART_LK = OFF 
  S00X:PART_PK = OFF 
  S00X:PART_LEAD = OFF 
  S00X:PART_KBP = OFF 
  S00X:PART_CTRL = PLAY 
  S00X:PART_XG = OFF 
  S00X:MIDFILE = MDR_000.MID 
  S00X:BLKFILE_001 = REG_001.B00 
\end{lstlisting}
冒頭の\texttt{S00X}（\texttt{X}には数字が入る）は、ディレクトリ内のソングのユニークナンバーになっている。エレクトーン内ではこの番号でソングの管理を行うようである。コロンの後にパラメータの種類を指定し、その後に変数を指定する構造になっている。各パラメータの内容は以下の通り\cite{elspc}。\\

\begin{tabular}{ll}
\texttt{SONGNAME} & MDRで表示されるソング名。 \\
\texttt{FOLDER} & ソングが入っているフォルダ。　\\
\texttt{SECURITY} & レジストの保護の有無(\texttt{ON}/\texttt{OFF})。\\
\texttt{MODEL} & 演奏を想定されたモデル。\\
\texttt{PART_UK} & 上鍵盤の自動演奏の有無(\texttt{PLAY}/\texttt{OFF})。\\
\texttt{PART_LK} & 下鍵盤の自動演奏の有無(\texttt{PLAY}/\texttt{OFF})。\\
\texttt{PART_PK} & 足鍵盤の自動演奏の有無(\texttt{PLAY}/\texttt{OFF})。\\
\texttt{PART_LEAD} & リードボイス1の自動演奏の有無(\texttt{PLAY}/\texttt{OFF})。\\
\texttt{PART_KBP} & キーボードパーカッションの自動演奏の有無(\texttt{PLAY}/\texttt{OFF})。\\
\texttt{PART_CTRL} & コントロールの自動演奏の有無(\texttt{PLAY}/\texttt{OFF})。\\
\texttt{PART_XG} & XGサポートの有無(\texttt{PLAY}/\texttt{OFF})。\\
\texttt{MIDFILE} & \texttt{FOLDER}で指定したフォルダの中のXGサポートデータ。\\
\texttt{BLKFILE_001} & \texttt{FOLDER}で指定したフォルダの中のバルクファイル。\\
 & ネクストレジストを使う場合は\texttt{002}、\texttt{003}...と増えていく。
\end{tabular}
 \\

したがって、現在編集中の\texttt{ELS_SONG.txt}の中で、\texttt{PART_XG}を\texttt{OFF}から\texttt{PLAY}に、\texttt{MIDFILE}を\texttt{XGS.MID}に書き換えれば良い。参考として、書き換えた後のELS\_SONGの例を以下のソース\ref{namafter}に示す。

\begin{lstlisting}[caption=ELS\_SONG.NAM（変更後）,label=namafter]
  S00X:SONGNAME = SONG_00X 
  S00X:FOLDER = SONG_00X 
  S00X:SECURITY = OFF 
  S00X:MODEL =  
  S00X:PART_UK = OFF 
  S00X:PART_LK = OFF 
  S00X:PART_PK = OFF 
  S00X:PART_LEAD = OFF 
  S00X:PART_KBP = OFF 
  S00X:PART_CTRL = PLAY 
  S00X:PART_XG = <#PLAY#>
  S00X:MIDFILE = <#XGS.MID#>
  S00X:BLKFILE_001 = REG_001.B00 
\end{lstlisting}

\texttt{PART_XG}と\texttt{MIDFILE}のみをソース\ref{namafter}のように書き換えたら保存し、拡張子を.txtから.NAMに戻そう。

もちろん、XGサポートをELモードで保存していた場合は、Ch.1から4はELボイスで再生できる。それを実際に再生させたいときは、同様に、\texttt{PART_UK}などを\texttt{PLAY}にすることで再生できる。

以上で、XGサポートの製作の全工程は終了である。エレクトーンのMDRで再生して、不具合がないか確認しよう。

\clearpage
\paragraph{EL-Explorerを使ったXGサポートファイルの転送}\

\begin{wrapfigure}{r}[5mm]{70mm}
  \centering
  \includegraphics[keepaspectratio,width=60mm]{ELExplorer.png}
  \caption{EL-Explorerの画面。EL-Explorer公式サイトから引用。}
  \label{figELexplorer}
\end{wrapfigure}
上記のように、format 0のSMFをUSBメモリに保存した後、.NAMファイルの書き換えによってエレクトーンで再生できるようにするのが、XGサポートファイルの基本的な利用方法である。さて、このようなUSBメモリにおけるソング構造の編集を簡易に行うことができるアプリケーションとして、すずとも氏が「EL-Explorer」を開発している。\href{https://www.kamekyame.com/el/explorer}{EL-Explorerの公式サイト}\footnote{\url{https://www.kamekyame.com/el/explorer}}からダウンロードできる。エレクトーンのパネルのように、Windows上で直感的にXGサポートファイルの書き込みや、.NAMファイルの編集などを行うことができる。上述の方法のうち、format 0のSMFを生成した後、USBメモリに保存しに行くところからはEL-Explorerに任せることができる。ぜひ一度お試しいただきたい。

\subsection{XG音源特有の仕様}
以上で、XGサポートの基本的な作り方の解説は終了である。より高度なデータを作成したい読者のための情報を以下に記す。スタイルもXG音源を使用するため、スタイルファイル編集においても以下の知識は有用である。
\subsubsection{システムエフェクトとインサーションエフェクト*}
ELボイスと同じように、XGボイスにもさまざまなエフェクトをかけることができる。

ELボイスは、各ボイスにそれぞれ個別のエフェクトをかけることができた。このようなエフェクトのかけ方を\emphj{インサーションエフェクト}という。しかしXGにおいてはELボイスの場合と異なり、ボイスそれぞれに個別のエフェクト設定をするのではなく、全てのチャンネルが1系統のエフェクトブロックを介してエフェクトをかけるという形をとる。このようなエフェクトのかけ方を\emphj{システムエフェクト}という。これらの違いを図\ref{figvariation}に示す。

XGボイスにかけることができるエフェクトは、\emphj{リバーブ}、\emphj{コーラス}、\emphj{バリエーション}の3系統である。sysEXを多用してエフェクトの設定を行うため、sysEXは［System Setup］のトラックに書かなければならないことを強調しておく。

\begin{figure}[h]
  \centering
  \includegraphics[width=160mm]{figvariation.pdf}
  \caption{2種類のバリエーションエフェクトのかけ方。バリエーションを(a)システムエフェクトとして使う場合、(b)インサーションエフェクトとして使う場合。インサーションの場合はCC\texttt{\#}94, CCM\texttt{\#}461, 462, 463, 464は無視される。}
  \label{figvariation}
\end{figure}

\paragraph{リバーブエフェクト} \

\emphj{XGボイスのリバーブブロックの設定はELボイスのリバーブ設定で行う}\footnote{ELボイスにおけるリバーブを思い出そう。本体パネル左上に存在するリバーブ音量を押すと、ディスプレイにリバーブ全体設定が現れる。これがエレクトーンにおけるリバーブブロックの設定である。各ボイスセクションはこのリバーブブロックへの音の送り量（センド）を指定するという操作をするのであった。このように、ELボイスにおけるリバーブは、もともとシステムエフェクトとして存在することがわかる。XGボイスにおけるリバーブは、ELボイスのリバーブブロックをそのまま使用するため、センド量を設定するだけで良い。}。したがって、リバーブエフェクトはシステムエフェクトである。

各XGボイスはCC\texttt{\#}91 Reverb Send LevelでELボイスのリバーブブロックへのセンド量を指定できる。XG仕様特有の設定は、エレクトーンでは無視されるものと思われる。
\newpage
\paragraph{コーラスエフェクト} \

コーラスブロックはシステムエフェクトである。CCM\texttt{\#}425からCCM\texttt{\#}444のsysEXを用いてコーラスタイプやコーラスのパラメータ設定をして、各チャンネルでCC\texttt{\#}93 Chorus Send Levelを書いてセンド量を指定する。

\paragraph{バリエーションエフェクト} \

バリエーションブロックは\emphj{システムエフェクトとインサーションエフェクトのどちらでも使用できる}。図\ref{figvariation}にそれぞれの場合におけるエフェクトブロックの連結の概念図を示す。バリエーションブロックはエレクトーン全体で1基のみ存在し、これをシステムとして使うのか、インサーションとして使うのかを選ぶことができる。

システムエフェクトとして使う場合、エフェクトタイプの指定(CCM\texttt{\#}450)、システムエフェクトの設定(CCM\texttt{\#}465)をこの順番で行い、続いてバリエーションリターンレベルの設定(CCM\texttt{\#}461)、バリエーションパンの設定(CCM\texttt{\#}462)、バリエーションから他のシステムエフェクトへのセンド量の設定(CCM\texttt{\#}463, 464)をする\footnote{なお、エフェクトタイプの指定を行うと、そのエフェクトのデフォルトのパラメータ設定が読み込まれ、前のエフェクト設定は捨てられるという点に注意する。エフェクトのパラメータを設定する場合はCCM\texttt{\#}451からCCM\texttt{\#}460、およびCCM\texttt{\#}474からCCM\texttt{\#}479を用いる。各パラメータが何に対応する操作なのかは、まだ解析が終わっていない。この対応を明らかにするには、例えばパソコンでsysEXをリアルタイムで表示できるようにしておいて、エレクトーンでELボイスのエフェクトパラメータを弄ったときに送信されるメッセージを解析すれば良い。なお、一部のエフェクトに関しては海外向けエレクトーンELA-1やポータブルキーボードPSR-SX900などのデータリストにパラメータの番地が書いてある\cite{ELA1}\cite{PSR}。}。この後、エフェクトをかけたいチャンネルのCC\texttt{\#}94 Variation Send Levelを0でない値に設定し、かけたくないチャンネルのCC\texttt{\#}94を0にする。\emphj{システムエフェクトの場合は複数のチャンネルに渡って1種類のバリエーションエフェクトをかけることができる}。

インサーションエフェクトとして使う場合、エフェクトタイプの指定(CCM\texttt{\#}450)、インサーションエフェクトの設定(CCM\texttt{\#}465)、インサートするチャンネルの指定(CCM\texttt{\#}466)を、この順番で行う必要がある。システムとして使う場合に比べて記述する命令がシンプルで簡単である。ただし、\emphj{どれか1つのチャンネルにしかインサーションエフェクトを用いることができない}点に注意する。


\subsubsection{メガボイス}

\emphj{メガボイス}はXGボイスの中で、\emphj{人間が演奏することを想定されていない特殊な音色マッピング}がされている高品位ボイスである。打ち込む際のノートナンバーとベロシティの両方で音色が大きく変わり、1種類のボイスで多種多様な音色を出すことができる。図\ref{figmegastart}から図\ref{figmegaend}にELS-02シリーズの全メガボイスのマッピングを示す\cite{megavoice}。縦軸がベロシティ、横軸がノートナンバーに対応している。この図を見ながら実際に自分のエレクトーンでメガボイスを聞いてみると良い\footnote{メガボイスは通常のボイスと異なり、プログラムチェンジのアドレス配置が系統分けされていない（通常のボイスはCC\texttt{\#}00/32でジャンル分けがされているが、メガボイスはそうではない）。そのため、音源定義ファイルにはプログラムチェンジの選択画面に「Mega Voice」というフォルダ（Map）を設け、メガボイスをこのフォルダにまとめて配置した。}。
\begin{figure}[h]
  \centering
  \includegraphics[width=150mm]{mega_abcd.pdf}
  \caption{メガボイス、ギター類のボイスマッピング(1)。ボイス名の「Mega」は省略した。縦軸がベロシティで、横軸がノートナンバー。たとえば、Mega NylonGuitarのC4をベロシティ80で演奏すると、mute奏法が発音する。なお、(c) 12StringGtrの〜B5は2つのエレメントで構成されており、それぞれが異なるベロシティマッピングになっている。}
  \label{figmegastart}
\end{figure}

\clearpage
\vspace*{\stretch{1}}
\begin{figure}[h]
  \centering
  \includegraphics[width=150mm]{mega_efgh.pdf}
  \caption{メガボイス、ギター類のボイスマッピング(2)。}
\end{figure}
\vspace{\stretch{2}}
\clearpage
\vspace*{\stretch{1}}
\begin{figure}[h]
  \centering
  \includegraphics[width=120mm]{megabas.pdf}
  \caption{メガボイス、ベース類のボイスマッピング。}
\end{figure}
\vspace{\stretch{2}}

\vspace*{\stretch{1}}
\begin{figure}[h]
  \centering
  \includegraphics[width=130mm]{megachorus.pdf}
  \caption{メガボイス、ポップボイスのボイスマッピング。\textit{Voice}と斜体になっているところには、それぞれボイス名のスキャットが入る。(c)のベロシティ81以上のマッピングに注意。}
\end{figure}
\vspace{\stretch{2}}
\clearpage
\vspace*{\stretch{1}}
\begin{figure}[h]
  \centering
  \includegraphics[width=120mm]{megahones.pdf}
  \caption{メガボイス、ホーンズセクションのボイスマッピング。}
\end{figure}
\vspace{\stretch{2}}
\clearpage
\vspace*{\stretch{1}}
\begin{figure}[h]
  \centering
  \includegraphics[width=120mm]{megastrings.pdf}
  \caption{メガボイス、クワイアとストリングスのボイスマッピング。}
  \label{figmegaend}
\end{figure}
\vspace{\stretch{2}}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\clearpage
\section{スタイルファイルの作り方（ドラム）}
ヤマハは自動伴奏のことを\emphj{スタイル}と呼んでいる。スタイルはリズムだけを鳴らしたり、ベースやコードバッキングなどの伴奏パートをリズムと一緒に鳴らしたりするのに使う\cite{cvp}。ELS-02シリーズの場合、「スタイル」という名前は表に出てこないが、「リズム」というパネルで操作するものがそれにあたり\href{http://els01stylefile.music.coocan.jp/Stagea_Style/P0101.htm}{【1-1】}、本体画面右側中央の「リズムパターンプログラム」ボタンでスタイルを編集できる。

このように、エレクトーン本体で編集できるスタイルではあるが、\emphj{エレクトーン本体での編集の不便さの改善}と、\emphj{本体での編集不可能なスタイルのパラメータの制御}を目的に、本稿では\emphj{スタイルをパソコンで編集する方法を解説する}。

実は、ヤマハはスタイルを\emphj{SFF（スタイルファイルフォーマット）}という体系で製作しているため、ヤマハの電子楽器どうしはスタイルに互換性があり、エレクトーンにも他楽器のスタイルを読み込むための機能がある\cite{取説}。実際にポータトーンやTyrosなどのヤマハ製キーボードにはスタイルクリエイターが内蔵されており、これで製作したスタイルをエレクトーンに読み込むことができる。そのため、パソコンで自作したスタイルファイルであっても、SFFに則っていれば、エレクトーンに読み込むことができるのである。

なお、SFFの仕様は公式では非公開であり、紹介する情報は有志の方々の先行研究によるものが多い。本稿の内容を利用するときは、あくまでも自己責任で実行すること。
\begin{itembox}{スタイルファイルフォーマットの参考書}
\begin{itemize}
\item スタイル入門講座\cite{スタイル}

エレクトーンに合わせてスタイルの解説を行っており、スタイルに関して日本でトップクラスの情報量を持つサイト。参考にしたページには、【章-ページ番号】でリンクを貼る。

\item Style Files - Description\cite{style}

スタイルファイルに関して一番詳しく解説されていると思う。英語だが、非常にわかりやすい。細かい仕様に関する情報はこちらで勉強できる。

\item YAMAHA Keyboard - Style CASM Section Format\cite{CASMeditor}

CASMセクションを編集できるフリーソフトであるCASM Editorの作者、Jørgen Sørensen氏によるCASMセクションの解説。端的にまとまっている。しかし、肝心のCASM Editorの方は、おそらくELSシリーズのデータに対応しておらず、残念ながらCASMセクションの編集に使うことができないものと思われる。

\item ヤマハ PSR-SX600 Refernce Manual\cite{PSR}

スタイルファイルフォーマット準拠の楽器であり、エレクトーンには存在しないスタイルクリエイターを搭載しているポータトーンの取扱説明書。第2章がスタイルの解説になっている。図表が多くわかりやすい。
\end{itemize}
\end{itembox}

\subsection{EL Data Analyzer}

以下、スタイルファイルの構造や、具体的な作成方法を2つの章に渡って解説するが、初めてスタイルファイルに触れる読者には、スタイルファイルの具体例があったほうが見通しが良いと思う。そこで、エレクトーンのデータからスタイルを切り出すソフトウェアである、\emphj{EL Data Analyzer}を紹介する（図\ref{figeldatasc}）。\href{https://github.com/wakmin-oxo/ELDataAnalyzer}{wakminのgithub}\footnote{\url{https://github.com/wakmin-oxo/ELDataAnalyzer}}からダウンロードできる。以下のようにして使う。

\begin{enumerate}
  \item エレクトーンでユーザーリズムを作成する。
  \item ユーザーリズムが入っているレジストデータ（.B00ファイル）を読み込む（ドラッグアンドドロップで良い）。
  \item 取り出したいユーザーリズムを選択し（もしくは空でないユーザーリズムを全て）、任意のフォルダに取り出す。
  \item Dominoで開くのであれば、拡張子を.styから.midに変更する\footnote{拡張子を.styから.midに変更することで、スタイルファイルのうち、MIDIセクションの部分だけをDominoで開くことができる。スタイルファイルはMIDIセクションとCASMセクションが合わさって構成されているが、DominoはCASMセクションを取り扱うことができないため、Dominoでそのスタイルファイルを保存すると、CASMセクションが無くなる点に注意しなくてはならない。切り出したスタイルファイルのうち、MIDIセクションだけを変更し、CASMセクションは元のまま使いたい場合、変更後のMIDIセクションに変更前のスタイルファイルのCASMセクションをコピーするという作業が必要になる。そのようなCASMセクションの作業には、次の章で説明するCasmEditを使用するのが良い。}。
\end{enumerate}
\begin{wrapfigure}{r}[5mm]{70mm}
  \centering
  \includegraphics[keepaspectratio,width=60mm]{eldatasc.png}
  \caption{EL Data Analyzerの画面。}
  \label{figeldatasc}
\end{wrapfigure}

自作のスタイルはもちろん、エレクトーン内にもとから入っているスタイルに関しても、一度ユーザーリズムに保存することで取り出すことができ、スタイルがどのような構造を持っているかの勉強に役立つ。以降、スタイルの仕様に関する説明をするので、エレクトーン内のスタイルや、エレクトーン上で自作したスタイルなどをEL Data Analyzerを使ってパソコン上に取り込んで、拡張子を.styから.midに変更してからDominoで開くと良い。ただし、このようにして取り出したスタイルの配布はしてはいけない。

\subsection{スタイルファイルの構造}
\begin{figure}[h]
  \centering
  \includegraphics[keepaspectratio,width=140mm]{midi_marker2.pdf}
  \caption{スタイルファイルの構造と、MIDIセクションの構造の例。各セクションパターンはマーカーによって分割される。例えば、Main AをMIDIセクションの2小節目から8小節間作り、その後Main Bに移る場合は、2小節目の頭に「\texttt{Main A}」と書き、10小節目の頭に「\texttt{Main B}」と書く。これにより、2小節目から10小節目がMain Aとして指定される。}
  \label{figmarker}
\end{figure}
スタイルファイルにはMIDI情報を書き込む\emphj{MIDIセクション}と、自動伴奏の規則のための\emphj{CASMセクション}という2つのセクションがある\cite{style}。なお、セクションという用語はエレクトーンではMain A、Main Bなどの再生箇所を指定するが、本稿では「セクション」が意味する語が多いため、エレクトーンにおけるMain Aなどのセクションを「\emphj{セクションパターン}」と呼び、スタイルファイルの構造であるMIDIセクション、CASMセクションと明確に区別する\footnote{なお、本稿でセクションパターンと呼ぶものは、データ上はCSEGと記述されており\cite{style}、チャンネルセグメントの略であると思われる。}。

スタイルの構成にCASMセクションは必要不可欠である。しかし、CASMセクションは複雑で、初学者には少々ハードルが高い。本来的には、MIDIセクションとCASMセクションの両方を記述してスタイルファイルを作る必要があるのだが、エレクトーンの場合は\emphj{条件付きで}\footnote{CASMセクションが無いスタイルをエレクトーンに読み込んだ場合、エレクトーンのデフォルトのCASMセクションが、読み込まれたスタイルファイルに結合される。従って、このデフォルトCASMセクションに沿って製作していれば、自分でCASMセクションを書く必要がない。次章にてアカンパニメントと併せて詳しく解説する。}CASMセクションの記述の必要がない。そこで\emphj{本章では、CASMセクションを編集せずに作ることができるスタイルファイル（メインドラム・アドドラムのみ）を紹介し}、MIDIセクション・CASMセクションという2つのセクションをあまり意識せずとも簡単なスタイルファイルが作成できるように解説する。アカンパニメントなどの自動伴奏を含めたスタイルファイルを作成するにはこれらの理解が必要があるため、次章で自動伴奏を作成する方法を解説するときに、改めて詳細に解説する。

MIDIセクションは、1小節目のセットアップ小節と、2小節目以降のMain A, B,\dots などのセクションパターン小節の2つに分かれていて、セクションパターン小節は\emphj{マーカー}\footnote{マーカーは、任意のTick数に任意の文字列を挿入できるSMFの機能である。Dominoであればメニューバーの「マーク(M)」$\rightarrow$ 「マークの挿入(A)...」を選ぶか、Ctrl + Mでマーカーを挿入できる。}によってさらに各セクションパターンに分割される。図\ref{figmarker}にセクションパターンの分割の一例を示す。

MIDIセクションの時刻1:1:0には\texttt{SFF1}と\texttt{SInt}という2つのマーカーを記述する\footnote{\texttt{SFF1}はスタイルファイルフォーマット1ということを示すと思われる。Tyrosなどの新しいSFF楽器においてはSFF2が採用されていることがわかっている\cite{style}。}。これらはスタイルファイルの仕様上必要である。

\subsection{メイン・アドドラムの打ち込み：MIDIセクションを作る}
いよいよ、スタイルファイルのMIDIセクションの作り方を、ドラムの編集を通して解説していく。以降、\href{https://www.kamekyame.com/el/domino-define}{エレクトーン用音源定義ファイル}を導入しているものとして解説する。\emphj{この音源定義ファイルを導入した状態でDominoプロジェクトを新規作成すると、スタイルファイルを作成するための基本的なデータが初めから打ち込まれている}。まずはプロジェクトを新規作成しよう。

\subsubsection{拍子の指定と\texttt{Main A}マーカーの挿入}
まずは1小節目、セットアップ小節の編集である。MIDIセクションの編集で、最初に行わなくてはならないのは\emphj{拍子の指定}である。［Conductor］トラックを表示し、イベントリストの拍子指定を、作成したいスタイルの拍子に合わせて変更しよう（4/4拍子の場合は変更の必要はない）。

4/4拍子以外の拍子にした場合は、2小節目の開始時刻がデフォルトデータからズレる。そのため、デフォルトで入っていた「\texttt{Main A}」マーカーが使用できなくなるので、このマーカーを削除し、自分で演奏線を2:1:0に合わせてから「Ctrl$+$M」で「\texttt{Main A}」を挿入しよう。拍子の変更をしなかった場合は、この作業は必要なく、デフォルトで入っている「\texttt{Main A}」マーカーをそのまま使用できる。

\subsubsection{システムセットアップ*}
\begin{figure}[h]
  \centering
  \includegraphics[keepaspectratio,scale=0.8]{systemsetup.png}
  \caption{デフォルトの［System Setup］トラックの中身。}
  \label{figdsystem}
\end{figure}
次に、［System Setup］トラックを選択してシステムセットアップの設定を確認しよう。システムセットアップでは主に、\emphj{バリエーションエフェクトの設定}と\emphj{ドラムセットアップの設定}とができる。これらを設定しないのであれば、\emphj{この節をスキップして、音源定義ファイルのデフォルトのままスタイルファイルを製作できる}。

デフォルトでは図\ref{figdsystem}のように、［205 XG System On］、［1207 Part Mode］、［465 Variation Connection］、［450 Variation Type］を書いておいた。以下でこれらの命令を一つずつ説明する。
\begin{description}
\item[\emphj{［205 XG System On］}]\

エレクトーンをXGモードに変更する命令。

\item[\emphj{［1207 Part Mode］}]\

指定したチャンネルを\emphj{ドラムトラック}として使用するという命令。これを設定することにより、ドラムトラック特有の特殊な設定である\emphj{ドラムセットアップ}が使用できるようになる。音源定義ファイルのデフォルトでは、Ch.10をメインドラム（DrumS1）に、Ch.9をアドドラム（DrumS2）に設定してある。

\item[\emphj{［465 Variation Connection］}]\

バリエーションエフェクトをシステムで使うか、インサーションで使うかを指定する命令。バリエーションエフェクトについては前章を参照してほしい。スタイルは仕様上\emphj{バリエーションエフェクトは必ずシステムエフェクトとして使用することになっている}。そのため、ここでシステムエフェクトとして使うという命令を記述した。

\item[\emphj{［450 Variation Type］}]\

バリエーションエフェクトのエフェクトタイプの指定をする命令。デフォルトではディストーションを指定した。他のエフェクトを使用したい場合はここを変更すると良い。
\end{description}

なお、システムセットアップは1小節目でしか行うことができない。そのため、例えばMain AとMain Bで異なるドラムセットアップをすることはできない。ドラムセットアップを変更する場合は別のスタイルファイルを作成し、エレクトーンに読み込むときには異なるユーザーリズムとして保存することになる。

\subsubsection{チャンネルセットアップ}
\begin{figure}[h]
  \centering
  \includegraphics[keepaspectratio,scale=0.8]{dominoch.png}
  \caption{デフォルトのドラムトラックの中身。}
  \label{figtrack}
\end{figure}

次に、メインドラム・アドドラムのチャンネルセットアップを行う。メインドラムもアドドラムも作業は同じであるため、ここではメインドラムの解説のみ行う。

トラックセレクトペインから［Main Drums］\footnote{デフォルトデータでは［Main Drums］トラックをCh.10にしており、基本的にメインドラムとして使用する。Ctabの設定をすれば、他のトラックでも構わない。}を選ぶ。そうすると、図\ref{figtrack}のように、このトラックに書かれているデフォルトのチャンネルセットアップが確認できる。

デフォルトではプログラムチェンジがスタンダードキットになっているが、他のドラムキットを選びたい場合は「PC:Standard Kit 1」をダブルクリックすることで変更できる。なお、キットを変更するとピアノロールに表示されているドラムマップが更新される。

また、XGサポートを製作する時と同様に、他のチャンネルセットアップも変更できる。1小節目に書いたチャンネルセットアップは、セクションパターンが呼ばれるたびに読み込まれる設定になるため、セクションパターン全てに共通する設定を書くのが良い。

ちなみに、プログラムチェンジを選ぶ際、「音色リスト」から選べば、\emphj{エレクトーンに内蔵されている全てのXGボイスの中からドラムの音色を選択できる}。これにより、\emphj{ドラムをXGサポートのような完全自動演奏として活用できる}。簡単かつ非常に強力なので、一度試してみると良い。
\subsubsection{セクションパターン小節の打ち込み}
上記のチャンネルセットアップをアドドラムにも行ったら、セットアップ小節で行うべき設定は終了である。続いて、2小節目からメインドラムとアドドラムにMain Aのドラムノートを打ち込もう。コントロールチェンジの多くはセクションパターン小節でも使える\footnote{セクションパターン小節で使うことができないMIDIメッセージについては、後ほど説明する。}ため、CCを使っていろいろな効果を試してみるのも面白い。

ノートの打ち込みが完了したら、最後のノートが置かれた場所の、次の小節の頭に演奏線を合わせよう。スタイルファイルにMain Aしか書かないのであれば、ここにEnd of Trackを設定する\footnote{End of Trackについての解説は、XGサポートの作り方にある。}。

Main A以降も作る場合は、次に作りたいセクションパターンのマーカー（表\ref{marker}参照）を設置することになる。空白は半角で、大文字・小文字に注意して入力しよう。これらのセクションパターンはスタイルファイルにどのような順番で書いても構わないし、使わないセクションパターンについてはマーカーを設置する必要もない\footnote{マーカーを使わなかったセクションパターンは、ノートが何も置かれていない状態としてエレクトーン内で補完される。}。

\begin{table}[h]
\caption{セクションパターンを指定するマーカー一覧\cite{style}。\texttt{Fill In BA}はBREAK。}
\label{marker}
\centering
\begin{tabular}{|c|c|c|c|c|}
\hline
\texttt{Main A} & \texttt{Fill In AA} & \texttt{Intro A} & \texttt{Ending A} & \texttt{Fill In BA} \\
\texttt{Main B} & \texttt{Fill In BB} & \texttt{Intro B} & \texttt{Ending B} & \\
\texttt{Main C} & \texttt{Fill In CC} & \texttt{Intro C} & \texttt{Ending C} & \\
\texttt{Main D} & \texttt{Fill In DD} & & & \\
\hline
\end{tabular}
\end{table}

なお、エレクトーン上で編集する時と同じように、\texttt{Fill In}は1小節しか扱うことができない\footnote{\texttt{Fill In}に2小節以上書いても、最初の1小節だけ読み込まれて以降の小節は無視される。}。他のセクションパターンについては小節数の制限は無いが、エレクトーンのメモリが一杯になったら読み込めなくなるため\href{http://els01stylefile.music.coocan.jp/Stagea_Style/Stagea_Style_P1003.htm}{【10-3】}、極端に大きなサイズのセクションパターンは作るべきではない。大きくとも64小節程度に収まるように分割しよう\footnote{90小節程度の大きなサイズのセクションパターンで作ったスタイルでシーケンスを組んで再生したところ、再生中にリズムの再生が異常停止した。}。

最後のセクションパターンまで打ち込みが終わったら、最後のノートの次の小節の頭に、End of Trackを忘れずに配置する。これで、メインドラムとアドドラムのみのスタイル（のMIDIセクション）を打ち込むことができた。

\subsubsection{1小節目と2小節目以降の違い}

何度も述べているように、SMFの1小節目はセットアップ小節である。スタイルにおける1小節目は、各セクションパターンが呼び出されるたびに必ず呼び出される共通設定であり、この小節の設定は非常に重要である。また、表\ref{1bar2bar}のように、1小節目でしか設定できないMIDIメッセージが存在する\cite{style}\footnote{スタイルの途中の拍子変更ができないのはセクションパターンの格納されているデータが小節単位で定義されているためである\href{http://els01stylefile.music.coocan.jp/Stagea_Style/Stagea_Style_P34.htm}{【5-34】}。しかしながら、2小節目以降でもテンポ変更には対応しており、1小節目で指定したテンポに対する倍率で、変更後のテンポを指定できる。これにより、レジストレーションメモリーを消費せずに\textit{accel.}や\textit{rit.}ができるほか、擬似的・一時的に変拍子を実装できる。なお、テンポ変更の仕様を確かめるには、次のような実験を行えば良い：MIDIセクションを作る際に、1小節目（セットアップ小節）は4/4拍子でテンポ100としておいて、2小節目からMain Aを書き始める。Main Aの4拍目だけをテンポ200とし、この1小節でMain Aが終わるようにしてからエレクトーンに読み込ませれば、擬似的に7/8拍子を再現できる。この方法は、スタイルのセクションパターンの一部だけの拍子を変えたい場合などに活用できる。}。

注意すべきなのは、\emphj{NRPN/RPNやsysEXは2小節目以降で指定することができない点である}。これにより、セクションパターンの中で特定のドラムのピッチを変更する（つまり、ドラムセットアップを変更する）ことはできない\footnote{メインドラム・アドドラムのどちらか一方を潰せば、ピッチを変更できる。すなわち、セットアップ小節でRPNを使用し、ピッチベンド感度を上げておいて、2小節目以降の任意のタイミングで\emphj{ピッチベンドを書けば良い}。ただし、ピッチベンドはチャンネルメッセージであるため、それが書いてあるメインドラム・アドドラムの全てのノートのピッチが同時に上がる。特定の楽器のピッチだけを上げることはできない。}。また、\emphj{サスティンも無視される}ため、注意してノートを打ち込む必要がある。

\begin{table}[h]
\caption{扱うことができるMIDIメッセージ\cite{style}。}
\label{1bar2bar}
\centering
\begin{tabular}{|l|c|c|}
\hline
MIDIイベント & 1小節目 & 2小節目以降\\
\hline
\hline
拍子設定 & OK & - \\ \hline
システムメッセージ & OK & - \\ \hline
ノートオン・オフ & - & OK \\ \hline 
プログラムチェンジ & OK & OK \\ \hline
ピッチベンド & OK & OK \\ \hline
CC\texttt{\#}01(モジュレーション) & OK & OK \\ \hline
CC\texttt{\#}06(データエントリー) & OK & - \\ \hline
CC\texttt{\#}07(ボリューム) & OK & OK \\ \hline
CC\texttt{\#}10(パン) & OK & OK \\ \hline
CC\texttt{\#}11(エクスプレッション) & OK & OK \\ \hline
CC\texttt{\#}64(サスティン) & OK & - \\ \hline
CC\texttt{\#}71(レゾナンス) & OK & OK \\ \hline
CC\texttt{\#}72(リリースタイム) & OK & - \\ \hline
CC\texttt{\#}73(アタックタイム) & OK & - \\ \hline
CC\texttt{\#}74(ブライトネス) & OK & OK \\ \hline
CC\texttt{\#}91(リバーブセンドレベル) & OK & OK \\ \hline
CC\texttt{\#}93(コーラスセンドレベル) & OK & OK \\ \hline
CC\texttt{\#}94(バリエーションセンドレベル) & OK & OK \\ \hline
CC\texttt{\#}98/99(NRPN) & OK & - \\ \hline
CC\texttt{\#}100/101(RPN) & OK & - \\ \hline
\end{tabular}
\end{table}


\subsubsection{スタイルファイルの保存とエレクトーンでの読み込み}
メイン・アドドラムを打ち込んで、End of Trackも設定し終えたら、このファイルをSMFとして書き出す。XGサポートの時と同様に、メニューバーの「ファイル(F)」$\rightarrow$ 「SMF書き出し(M)...」から書き出そう。このとき、\emphj{「Format 0」としてSMF書き出しする}ことに注意すること。

書き出しが終わったら、書き出されたファイルの拡張子を変更する。SMFの拡張子は「.MID」だが、SFFの拡張子は「.sty」であるため、拡張子を「.sty」としておこう。これで、エレクトーンに読み込ませるファイルの準備ができた。本来であればこの後にCASMセクションの編集を行うのだが、CASMセクションが無くとも自動的にエレクトーンで補完されるため、このままエレクトーンに読み込むことができる。

最後にこのファイルをエレクトーンで読み込もう。準備ができたスタイルファイルをUSBメモリにコピーし、エレクトーンに挿す。あとは取扱説明書\cite{取説}166ページの通りに読み込めば良い。エレクトーンのリズムパターンプログラム画面の「ファイル」タブから、USBメモリに入っているパターンファイルを選択して読み込む。読み込んだだけでは保存されないため、「保存」タブから任意のユーザーリズムに保存しよう。以上でエレクトーンへの読み込みは終了である。作成したスタイルを再生し、意図通りに再生できるかチェックしたら、完成である。

\subsection{ドラムセットアップの解説*}
ドラムはXGの仕様により\emphj{ドラムセットアップ}と呼ばれる特殊なエディットが可能である\footnote{ドラムセットアップの解説は、MIDIセクションの解説というよりはXG仕様の解説となるため、本稿のどこで解説するか悩んだ。しかし、エレクトーンではXGサポートでドラムセットアップをするのは稀だと考え、メイン・アドドラムの解説に多くを割いたこの章で解説することとした。}。ドラムセットアップを使用することで、ドラム全体の調節のみならず、\emphj{キーに割り当てられている楽器ごとに音色をエディットする}ことができる。エレクトーン本体でも設定できるため、馴染み深いと思う読者も多いと思うが、エレクトーンからは触ることができないパラメータも多い。

ドラムセットアップを使うためには、特定のトラックを\emphj{ドラムトラック}として設定する必要がある。［CCM\texttt{\#}1207 Part Mode］で指定トラックをドラムトラックにできる\footnote{なお、2000年のXG仕様書v1.35\cite{XG仕様}ではXG音源最高位モデルではドラムトラックは最大4まで使用できる。エレクトーンで2系統以上のドラムトラックが使用できるかは不明だが、おそらくできないと思われる。}。音源定義ファイルのデフォルトデータではCh.10をメインドラム（DrumS1）、Ch.9をアドドラム（DrumS2）として設定しておいた。

ドラム音源のエディットはNRPNによるものとsysEXによるものとがある\footnote{MIDIの一般的な約束として、sysEXとNRPNのどちらでも同じ効果が得られる場合、できるだけNRPNを使用することになっている。そのため本来は、NRPNで設定しきれない場合のみsysEXを用いるのが良いと思うのだが、エレクトーンで作成したスタイルでは、NRPNで操作できるはずのドラムセットアップパラメータであっても、全てsysEXで記述されている。理由は不明。}。設定できる項目が多いため、節を分けてNRPNとsysEXを別々に解説する。なお、前述の通り、\emphj{どちらのドラムセットアップを使うにせよ、ドラムセットアップの命令は1小節目に書く必要がある（2小節目以降は無視される）}。

エレクトーンでリズムパターンプログラムを使用してスタイルを製作する場合のキーの割り当てと、対応するノートナンバーを図\ref{fignotenumber}に示す。例えば、多くのキットでC1はキックドラムに割り当てられており、これを指定するにはノートナンバーを36とすれば良い。
\begin{figure}[h]
  \centering
  \includegraphics[keepaspectratio,width=150mm]{notenumber2.pdf}
  \caption{リズムパターンプログラムでの操作で使用するエレクトーンのキーの音名と、実際にスタイルに打ち込まれるノートのノートナンバー。}
  \label{fignotenumber}
\end{figure}

\subsubsection{ドラムセットアップ (NRPN)*}
以下、NRPNで設定できるドラムセットアップパラメータについて解説する。NRPNはCCの一つで、チャンネルメッセージであるため、［System Setup］トラックではなく各ドラムトラックに記述することに注意。ここでは音源定義ファイルを使っている場合に合わせて、CCM\texttt{\#}を付記する。また、その場合はDominoで打ち込むときのGateがノートナンバーに対応する。

例えば、メインドラムのC1 キックのボリュームを調節したい場合には、［Main Drums］（Ch.10）のチャンネルセットアップに［CCM\texttt{\#}174 Drum Level］を追加し、Valueとして音量を、Gateとして36を指定する。

\begin{description}
\item[\emphj{CCM\texttt{\#}168 Drum Filter Cutoff Frequency}] \,\\
ローパスフィルターのカットオフ周波数。下げれば高音成分が減る。

\item[\emphj{CCM\texttt{\#}169 Drum Filter Resonance}]  \,\\
カットオフ周波数周りのレゾナンスをつける。

\item[\emphj{CCM\texttt{\#}170 Drum EG Attack Rate}] \,\\
アタックタイムを増減する。減らすとアタックが遅くなり、増やすと早くなる。

\item[\emphj{CCM\texttt{\#}171 Drum EG Decay Rate}] \,\\
ディケイタイムを増減する。減らすとディケイが遅くなり、増やすと早くなる。

\item[\emphj{CCM\texttt{\#}172 Drum Pitch Coarse}]\,\\
ピッチを半音単位で調節できる。

\item[\emphj{CCM\texttt{\#}173 Drum Pitch Fine}]\,\\
ピッチを100分の1半音単位で調節できる。

\item[\emphj{CCM\texttt{\#}174 Drum Level}] \,\\
音量を調節できる。

\item[\emphj{CCM\texttt{\#}175 Drum Pan}] \,\\
パンを調節できる。XG仕様書\cite{XG仕様}の12ページによると、最低値に設定するとパンがRandomになるはずだが、エレクトーンでは再現できない。

\item[\emphj{CCM\texttt{\#}176 Drum Reverb Send Level}]\,\\ 
CC\texttt{\#}91 リバーブを最大値として、そこにどの程度の量をセンドするかを決める。デフォルトはノートによって違う。

\item[\emphj{CCM\texttt{\#}177 Drum Chorus Send Level}] \,\\
CC\texttt{\#}93 コーラスを最大値として、そこにどの程度の量をセンドするかを決める。デフォルトはノートによって違う。

\item[\emphj{CCM\texttt{\#}178 Drum Variation Send Level}] \,\\
CC\texttt{\#}95 バリエーションを最大値として、そこにどの程度の量をセンドするかを決める。デフォルトは基本的に127。

%\item[\emphj{CCM\texttt{\#}179 Drum HPF Cutoff Frequency}] CC\texttt{\#}99$=$36, CC\texttt{\#}06 : 0-64-127

%ハイパスフィルターのカットオフ周波数。上げれば低音成分が減る。

%\item[\emphj{Drum EQ BASS}] CC\texttt{\#}99$=$48, CC\texttt{\#}06 : 0-64-127
%\item[\emphj{Drum EQ TREBLE}] CC\texttt{\#}99$=$49, CC\texttt{\#}06 : 0-64-127
%\item[\emphj{Drum EQ BASS Frequency}] CC\texttt{\#}99$=$52, CC\texttt{\#}06 : 4(32Hz)-40(2kHz)
%\item[\emphj{Drum EQ TREBLE Frequency}] CC\texttt{\#}99$=$53, CC\texttt{\#}06 : 28(500Hz)-58(16kHz)

%イコライザーをかけることができる。EQフリケンシーの挙動についてはXG仕様書\cite{XG仕様}のXG EFFECT PARAMETER TABLE (P38)を見よ。
\end{description}

\subsubsection{ドラムセットアップ (sysEX)*}
ドラムセットアップの命令はsyxEXにも存在する。重複を除けば、NRPNよりも特殊で限定的な命令が多い。

以下にsysEXで指定できるドラムセットアップ命令を列挙する。ただし、NRPNで設定できる項目については省略する。NRPNと同様にCCMが存在するため、音源定義ファイルを使う場合に合わせてCCM\texttt{\#}を付記する。NRPNの場合と同様にDominoで打ち込む場合はGateがノートナンバーに対応する。

例えば、メインドラムのC\#2 クラッシュシンバルでシンバルミュート奏法を再現したい場合は、［System Setup］トラックの1小節目に［CCM\texttt{\#}909 Drum Rcv Note Off］を追加し、Valueとして1を、GateとしてD1-49を指定する。

\begin{description}

\item[\emphj{CCM\texttt{\#}903 ALTERNATE GROUP}]\,\\
ALTERNATE GROUPが同じであるような複数のノートは同時に発音できないようになる。ハイハットのオープンとクローズのように、片方が鳴ったときにもう片方をミュートしたいときなどに使う。デフォルトのALTERNATE GROUPを知りたい場合はXG仕様書\cite{XG仕様}を参考にするしかないが、後発のエレクトーンのドラムキットが載っていないので、もしALTERNATE GROUPを操作するのならば自分で調査するしかない\footnote{海外向けエレクトーンELA-1やポータブルキーボードPSR-SX900などのデータリストに、一部のELS-02シリーズのキットのALTERNATE GROUPが掲載されている。完全に互換するかは不明だが、参考になるかもしれない\cite{ELA1}\cite{PSR}。}。通常のノートはALTERNATE GROUPはオフになっている。

\item[\emphj{CCM\texttt{\#}908 KEY ASSIGN}]\,\\
\emphj{この命令は、筆者の実験においては、エレクトーンで使うことができなかった}\footnote{XG仕様書\cite{XG仕様}によると、KEY ASSIGNはオプショナルではないはずなので、エレクトーンでも設定変更ができると考えられる。成功した方は連絡をください。}。以下の説明はKEY ASSIGNの一般的な説明である。もしKEY ASSIGNを使いたいのであれば、代わりにRcv NOTE OFFをONにして、打ち込みの段階でゲートタイムを調節して打ち込めば良い。

\textcolor{gray}{ドラムに限らないXG音源の仕様として、前の音が減衰している間に次の音のノートオンが来たとき、前の音をミュートする（シングル）か減衰を続けるか（マルチ）を選ぶことができ、それはXG MULTI PARTの設定のSAME NOTE NUMBER KEY ON ASSIGN(CCM\texttt{\#}606)という命令で制御できるようになっている。XGのデフォルトでは全ての音が減衰を続けるSAME NOTE NUMBER KEY ON ASSIGN$=$MULTIに設定されているが、ドラムパートに関してはノートごとに設定を変更できるようになっており、その場合はSAME NOTE NUMBER KEY ON ASSIGN$=$INSTとした上で、KEY ASSIGNを使って各ノートの設定をすることになる。}

\item[\emphj{CCM\texttt{\#}909 Rcv NOTE OFF}]\,\\
ノートオフを無視するかどうかの設定。RcvはReceiveのこと。クラッシュシンバルなどの自然な減衰に任せて消音する楽器はノートオフを無視して鳴り続けるが、サンバホイッスルなどは鳴り続ける時間（ゲートタイム）を自分で設定でき、ノートオフで消音する。クラッシュシンバルなどをONにすることで、自分の好きなタイミングで消音させることができる。\emphj{シンバルミュートがないエレクトーンにおいて、非常に実用的な命令。}

\item[\emphj{CCM\texttt{\#}910 Rcv NOTE ON}] \,\\
ノートオンを無視するかどうかの設定。これがONのとき、ノートは鳴らない。デフォルトでは全てOFF。

\item[\emphj{CCM\texttt{\#}914 EG DECAY1}] 
\item[\emphj{CCM\texttt{\#}915 EG DECAY2}] \,\\
XGボイスにはディケイタイムが2種類存在するものがある。NRPNによる設定ではその2つを同時に変化させるが、このsysEXを使うことで別々に設定できる。

%\item[\emphj{VELOCITY PITCH SENSE}] \textcolor{gray}{\texttt{xxH}$=$\texttt{60H}, \texttt{mmH} : \texttt{30H}-\texttt{40H}-\texttt{50H} (48-64-80)}

%\item[\emphj{VELOCITY LPF CUTOFF SENSE}] \textcolor{gray}{\texttt{xxH}$=$\texttt{61H}, \texttt{mmH} : \texttt{30H}-\texttt{40H}-\texttt{50H} (48-64-80)}

%これら2つに関してはエレクトーンで使うことができないと思われる。もしくは使用可能かどうかがキットに依存する。ベロシティに追従してピッチやカットオフ周波数を動かすことができる。

\end{description}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\clearpage
\section{スタイルファイルの作り方（アカンパニメント）*}
前の章では、メイン・アドドラムをDominoで打ち込む方法を解説した。多くのアレンジでは前の章の内容で十分であると考えているが、更に「強い」アレンジを志す人は、アカンパニメントを自分で編集したいと考えたことがあるだろう。そこでこの章では「プレイヤーが演奏しているコードを検出して、伴奏パターンを変更する」機能であるアカンパニメント\footnote{「アカンパニメント」という用語は混乱しており、本来的には、「コード1/2」、「パッド」、「フレーズ1/2」の5つを指す用語である\cite{取説}。しかし、プレイヤーの中ではベースの自動伴奏（オートベース）もいわゆる「アカンパニメント」として理解されていることが多い。そのため、本稿では\emphj{ベースの自動演奏も、アカンパニメントと呼ぶことにする}。}\footnote{なお、オートベースコード（A.B.C.）はアカンパニメントにおけるコードの判定方式とオートベースの有無を指定するモードの名前であり、
\emphj{シングルフィンガー}（下鍵盤を1-3音抑えるだけでコードを判定する。ベースの自動演奏をする）、
\emphj{フィンガードコード}（下鍵盤のみでコードの判定を行う。ベースの自動演奏をする）、
\emphj{カスタムA.B.C.}（下鍵盤と足鍵盤の両方でコードをの判定する。ベースの自動演奏をする）、
\emphj{A.B.C.なし}（下鍵盤のみでコードの判定を行う。ベースの自動演奏をしない）
の4種類がある。}\footnote{取扱説明書\cite{取説}によると、\emphj{ロワーリズミック}もアカンパニメントの一種である。しかし、ロワーリズミックは\emphj{スタイルファイルフォーマットではない}ため、Ctabによる指定ができない上に、コードの判定もしない。そのため、本稿では踏み入った解説を行わない。ちなみに、DominoなどのMIDIシーケンサーを使ってロワーリズミックパターンを作りたい場合、コードパートにドなどの単音をロワーリズミックの音価で打ち込んでおいて、エレクトーンに読み込んでしまえば良い。ただしこのとき、打ち込んだ単音はスタイルとしてのコードで打ち込まれているため、エレクトーンでどのように演奏しても単音としてしか鳴らない。これをロワーリズミックにするため、エレクトーンのリズムパターンプログラム上でコードパートを少しだけ編集する（たとえば、あるノートの音価を1 Tickだけ縮める）。そうしてから保存すれば、ロワーリズミックとして保存される\href{http://els01stylefile.music.coocan.jp/Stagea_Style/P1909.htm}{【19-9】}。}をスタイルファイルに入れる方法について解説する。

アカンパニメントでは、演奏されているコードに対応して、打ち込んでおいたMIDIの発音内容が変わる。この「MIDIのリアルタイム読み替え」をするためのルールが記述されているのが\emphj{Channel Table(Ctab)}である。また、Ctabが書かれているスタイルファイルの部分を\emphj{CASMセクション}と呼ぶ。図\ref{figcasmoverall}は、MIDIセクションとCASMセクションがどのように関わっているかを示した概念図である。スタイルにおいて、打ち込んだMIDIはそのまま再生されるわけではなく、必ずCASMセクションのCtabを通り、Ctabの命令と演奏内容に従って、音の読み替えが行われて再生される。
\begin{figure}[h]
  \centering
  \includegraphics[keepaspectratio,width=150mm]{CASM_overall.pdf}
  \caption{CtabとCASMセクションの理解のための概念図。この図のCtabに書かれている様々なルールは一例である。}
  \label{figcasmoverall}
\end{figure}

実は、前の章で解説したメイン・アドドラムも例外ではない。MIDIセクションのCh.9とCh.10に打ち込まれたドラムは、エレクトーンで自動で補完されたデフォルトのCASMセクション（すなわち、「Ch.9, 10は音高の読み替えをしない」というCtabが書かれたCASM）によって、メイン・アドドラムとして読み込まれて再生されている。スタイルのMIDIセクションは、CASMセクションなしに再生することはできない。

さて、メイン・アドドラムは打ち込んだ内容がそのまま再生されればよかったため、デフォルトのCASMで十分であった。しかし、それ以外の音高の読み替えを必要とするパートをスタイルに入れようとするなら、自分でCASMセクションを書かなくてはならない。そこで\emphj{この章では、読者がアカンパニメントによる自動伴奏を実現するために、Ctabを理解し、CASMセクションを自分で記述できるようになることを目標に解説する}\footnote{\cite{PSR}を読めばわかることだが、実はこの章で説明することのほとんどは公式の資料に解説がある。スタイルファイルの作り方の解説をしている章ではあるが、実際のところは「スタイル」の解説をしているに過ぎない。}。なお、メイン・アドドラムの編集方法については前の章まででほとんど解説し終えているため、この章ではアカンパニメントを主に取り扱う。

\subsection{CasmEditの導入}
CASMセクションを編集するソフトウェアも複数存在するようであるが、本稿ではエレクトーンのスタイルファイルを取り扱うことができる\emphj{CasmEdit}を使用する。\href{https://www.mnppsaturn.ru/osenenko/Main_eng.htm}{CasmEditの公式サイト}\footnote{\url{https://www.mnppsaturn.ru/osenenko/Main_eng.htm}}からダウンロードできる\footnote{CasmEditのホームページは以前はもっと内容があったと記憶しているのだが、2023年現在はソフトウェアが置かれているだけである。無くなってしまわないか不安である。}。具体的な使い方は、後に解説する。
\subsection{Ctabで設定できるパラメータ}
Ctabの音高変換の仕組みを理解せずに、正しく再生できるアカンパニメントを作るのは難しい。そのため、アカンパニメントのMIDIセクションを打ち込む前に、まずはCtabの命令を説明する。この節の解説を終えた後、具体的なスタイルファイルの作成方法の解説を行う。\emphj{初めてアカンパニメントの自作に挑戦する人には難しいかもしれないので、その場合はこの節を一旦飛ばして、次の「作り方」から読むと良い。必要になったら適宜、この節に戻ってくれば良い}。なお、スタイルクリエーター搭載楽器の取扱説明書には、公式のCtabの解説が存在するため、そちらも合わせて参照すると良い\cite{PSR}。Ctabの各パラメータには様々な呼び方があるが、基本的に本稿では見出し語としてCasmEditの呼称を採用する。

\subsubsection{入力チャンネル・出力チャンネル}

\begin{wraptable}[12]{r}[5mm]{50mm}
\caption{出力チャンネル一覧。}
\label{styleoutch}
\centering
\begin{tabular}{cc}
チャンネル & パート \\
\hline
Ch.9 & アドドラム \\
Ch.10 & メインドラム \\
Ch.11 & ベース \\
Ch.12 & コード1 \\
Ch.13 & コード2\\
Ch.14 & パッド \\
Ch.15 & フレーズ1 \\
Ch.16 & フレーズ2 \\
\hline
\end{tabular}
\end{wraptable}
%
エレクトーンのスタイルで使用できるセクションパートは、メインドラム、アドドラム、ベース、コード1/2、パッド、フレーズ1/2の8つである。しかし、MIDIセクションで取り扱えるチャンネルは8つではなく、最大16まで使用できる\href{http://els01stylefile.music.coocan.jp/Stagea_Style/P1706a.htm}{【17-6】}。スタイルは、\emphj{最大16チャンネル分のMIDIデータを8パートに合流させて再生している}。MIDIセクションで記述する最大16のチャンネルを\emphj{入力チャンネル}と呼び、スタイルとして最終的に再生するのに使用する8つのチャンネルを\emphj{出力チャンネル}と呼ぶ。出力チャンネルとして使用される8つのチャンネルと、それらを使用した際に再生されるセクションパートを表\ref{styleoutch}に示す。

この仕様により、特定のコードの時に違うパターン（違う楽器にもできる\footnote{1つのパートで同時に鳴らすことができる楽器（プログラムチェンジコマンド）は、当然1種類だけであるため、例えばコード1でピアノとストリングスとブラスを同時に鳴らす、ということはできない\href{http://els01stylefile.music.coocan.jp/Stagea_Style/P1709a.htm}{【17-9】}。１つの出力チャンネルで同時に2以上の楽器を鳴らすことはできないが、同時でなければ複数の楽器を1つの出力チャンネルに通すことができる。}）を再生したり、ピアノの左手相当のノートと右手相当のノートを別々のチャンネルで編集し、再生を1パートでするといったことが可能になる。入力チャンネルが複雑な具体例として、エレクトーンの内蔵スタイルである「アンプラグド1」などがある。コード1の1出力に13チャンネル分のデータが入力されている\href{http://els01stylefile.music.coocan.jp/Stagea_Style/P1708a.htm}{【17-8】}。

ちなみに、コード1/2、パッド、フレーズ1/2のそれぞれは、名前は違うものの、機能としては同じであると思われる\footnote{公式\cite{取説}では、それぞれのパートは次のように説明されている。コード1/2：「コード伴奏を担当する、ピアノやギターなどの演奏を再生する」、パッド：「ストリングスやオルガンなどの演奏を再生する」、フレーズ1/2：「アルペジオや、パンチの効いたブラスフレーズなどを再生する。アカンパニメントの中でひときわ華やかなパート」}。この5つのパートにおいては、どれを使っても同じ効果が得られるため、自分のアレンジに最も適した名前のパートを使っても良いし、雑にコード1から順番にアカンパニメントを埋めて行っても良い。ただし、「ベース」のCh.11は、ELボイスである足鍵盤ボイスで発音されるため、注意する。

CasmEditにおいては、入力チャンネルは「Tr」、出力チャンネルは「Ch」とか「MIDI Chan」とかと書かれている。

\subsubsection{Source Chord Root / Type (C.R. / C.T.)}
MIDIセクションで記述したパターンの基準となるコードを指定する\href{http://els01stylefile.music.coocan.jp/Stagea_Style/P1623.htm}{【16-23】}。Chord Root(C.R.)でコードのルートを指定し、Chord Type(C.T.)でタイプを指定する。デフォルトのCASMセクションの場合は［C.R.$=$C］、［C.T.$=$Maj7］となっている。すなわち、デフォルトでは基準のコードが$\textrm{C}_{\textrm{M7}}$と指定されている。

ほとんどの場合で、C.R. / C.T.はデフォルトの$\textrm{C}_{\textrm{M7}}$で事足りると思うので、\emphj{C.R. / C.T.は変更せずに、MIDIセクションに打ち込むフレーズは$\textrm{C}_{\textrm{M7}}$のときに正しく鳴るようなフレーズとする}と良いだろう。もちろん、C.R. / C.T.を変更して、MIDIセクションのフレーズをそのコード基準に書いても構わない。

指定できるコードタイプと、推奨ノートの一覧を図\ref{figChordtype}に示す\cite{PSR}。

\begin{figure}[h]
  \centering
  \includegraphics[keepaspectratio,width=130mm]{ChordType.eps}
  \caption{C.R.$=$Cのときのコードタイプと推奨ノート一覧\cite{PSR}。}
  \label{figChordtype}
\end{figure}

\subsubsection{NTR}
\emphj{NTR}とは\underline{N}ote \underline{T}ransposition \underline{R}uleのことで、音高変換の際に展回形を用いるかを指定する。Root TransとRoot Fixedから選ぶ。
\begin{description}
\item[\emphj{Root Trans}]\

図\ref{figRTRF}左のように、音高変換の際に転回しないで、元のパターンの音程を保とうとする。普通、メロディラインがあるパートにRoot Transを設定する。

\item[\emphj{Root Fixed}]\

図\ref{figRTRF}右のように、音高変換の際にできるだけ元の音域から離れないように、転回形を用いる。普通、コードパートにRoot Fixedを設定する。また、ドラムパートもRoot Fixedを設定する。
\end{description}

\begin{figure}[h]
  \centering
  \includegraphics[keepaspectratio,width=100mm]{RTRF.pdf}
  \caption{Root TransとRoot Fixedの違い。\cite{PSR}より引用。}
  \label{figRTRF}
\end{figure}

\subsubsection{NTT}
\emphj{NTT}とは\underline{N}ote \underline{T}ransposition \underline{T}ableのことで、演奏を検出したコードタイプに応じて
、どのようにMIDIセクションのデータを音高変換するかを指定する\href{http://els01stylefile.music.coocan.jp/Stagea_Style/P1626.htm}{【16-26】}。\emphj{CasmEditの「NTT」または「Cntt」という欄で指定する}\footnote{エレクトーンを含む新しい電子楽器ではCASMセクション内のCtab以外にCnttというセクションが追加され、Ctab内のNTTよりも多彩なオプションを選ぶことができるように拡張された。なお、Cnttに対応している楽器ではNTTの命令をCnttで上書きする\cite{style}。}\footnote{なお、エレクトーン内蔵のスタイルでは「NTT$=$未指定」かつ「Cntt$=$指定」または「NTT$=$指定」かつ「Cntt$=$未指定」のいずれかであるらしい。}。通常のパートであれば「NTT」欄で指定できるが、特殊なスケールに沿って音高変換を行いたい場合と、ベースオンコード的な音高変換を行いたい場合は「Cntt」欄で指定する\footnote{ベースパートには、Bass On付きのものを選ぶ。Bass On付きの物を選ぶと、オンコード（ベースが和音のルートを演奏しないようなコード）で演奏した場合にも、意図したベースを演奏するようになっている。例えば判定コードが$\textrm{C}^{\textrm{on E}}$のとき、On Bassが有効になっているパートではEに集中して音高変換をする。}\href{http://els01stylefile.music.coocan.jp/Stagea_Style/P1531.htm}{【15-31】}。以下にNTTとCnttのオプションを解説する。

\begin{description}
\item[\emphj{BYPASS}]\

［NTR$=$Root Fixed］ならば、一切の音高変換を行わない。メインドラム・アドドラムなどに適している\footnote{エレクトーンではメインドラム・アドドラムはNTR/NTTの設定に関わらず音高変換をスルーする\href{http://els01stylefile.music.coocan.jp/Stagea_Style/Stagea_Style_P0701.htm}{【7-1】}。}。効果音的に使いたい楽器に対してもBypassを指定することがある\footnote{例えば、メガボイスの効果音のレイヤーだけを使いたい場合。効果音のレイヤーは範囲が狭いため、普通の楽器のように安易に音高変換されると意図した効果を出せない場合がある。}。［NTR$=$Root Trans］ならば、ルート音だけ音高変換を行う。

\item[\emphj{MELODY}]\

メロディライン向けの音高変換を行う。和音には適さないことが多い。メロディ的なフレーズや、ベースに適している。

\item[\emphj{CHORD}]\

和音向けの音高変換を行う。

\item[\emphj{BASS}]\

ベース向けの音高変換を行う。CnttでのBass On付きの「MELODY + Bass」と同じ\href{http://els01stylefile.music.coocan.jp/Stagea_Style/P1626.htm}{【16-26】}。公式では［NTT$=$BASS］を使わずに、［NTT$=$未指定］かつ［Cntt$=$Bass OnのMELODY + Bass］とする。
\item[\emphj{その他のスケール}\footnotemark]\footnotetext{MELODIC MINOR, MELODIC MINOR 5th VAR, HARMONIC MINOR, HARMONIC MINOR 5th VAR, NATURAL MINOR, NATURAL MINOR 5th VAR, DORIAN, DORIAN 5th VAR。}\

主にメジャーコード・マイナーコードの判定のみ行い、各スケールに合うように音高変換を行う。メジャーコード・マイナーコードのみ演奏されるセクションパターンであるイントロ・エンディングで主に用いる。詳しくは\cite{PSR}を参照してほしい。

\end{description}

\subsubsection{Highest Key (H.K.)}

H.K.で指定されたノートよりも高い音をルートに持つ和音が演奏されたとき、和音全てを1オクターブ下げて再生する（図\ref{fighighkey}）。\emphj{H.K.は［NTR$=$Root Trans］のときのみ有効になる}。

\begin{figure}[h]
  \centering
  \includegraphics[keepaspectratio,width=120mm]{highkey.eps}
  \caption{Highest Keyの機能説明\cite{PSR}。}
  \label{fighighkey}
\end{figure}

\subsubsection{Low Limit / High Limit (L.L. / H.L.)}

最終的な発音に対する音高の限界を指定する。NTT、NTR、H.K.で音高変換された後のノートにLimitよりも外側の音が存在した場合、Limit以内に入るようオクターブを変える\href{http://els01stylefile.music.coocan.jp/Stagea_Style/P1672.htm}{【16-72】}。

\subsubsection{RTR}

\emphj{RTR}とは\underline{R}e\underline{T}rigger \underline{R}uleのことで、再生中に判定コードが変わった場合の処理を指定する\href{http://els01stylefile.music.coocan.jp/Stagea_Style/P1674.htm}{【16-74】}。演奏感に直結する重要なパラメータである。次の5種類がある。

\begin{description}
\item[\emphj{Stop}]\

発音中の音を止めて、次のノートオンを待つ。
\item[\emphj{Pitch Shift}]\

発音中の音にピッチベンドをかけて、新しいコードにする。
\item[\emphj{Pitch Shift To Root}]\

発音中の音にピッチベンドをかけて、新しいコードのルート音にする。
\item[\emphj{Retrigger}]\

発音中の音を止めて、新しいコードの音で再発音する。
\item[\emphj{Retrigger To Root}]\

発音中の音を止めて、新しいコードのルート音で再発音する。
\end{description}

エレクトーンの場合、カスタムA.B.C.でベースを弾き直すと、最初の1音は弾いたノートが演奏されるため、ベースがTo Rootか否かは関係ない。しかし、カスタムA.B.C.以外のオートベースコードに対応するために、ベースはRTR$=$Pitch Shift To Rootにするのが良い。

\subsubsection{Auto Start}
Auto Startが有効のパートはリズム再生と同時に自動で再生される。エレクトーンの場合、どのように設定してもメイン・アドドラムはAuto Startで再生され、それ以外にAuto Startは設定できない\footnote{もし他のパートもAuto Startにすることができたら、ドラムを3以上編成できることになるが、私が実験した限りでは残念ながらAuto Startは無視される。}ため、設定の必要はない。

\subsubsection{Note Mute (NMute) / Chord Mute (CMute)}
Muteは特定のコードが判定されたときにチャンネルをミュートしたり、逆に特定のコードのときだけ再生したりする場合に用いる。特定のコードタイプで音の濁りが生じるのを防ぐために使う。多くの場合は設定の必要はないだろうが、脚注\footnote{複数の入力チャンネルで1つの出力チャンネルを指定し、それぞれの入力チャンネルで異なるミュート設定にすれば、判定コードに合わせて複雑な分岐をするパートを作ることができる\href{http://els01stylefile.music.coocan.jp/Stagea_Style/Stagea_Style_P1120a.htm}{【11-20】}。特定のコードの時だけアカンパニメントをプログラムチェンジを含めてまるっきり変更するといった積極的な使い方もできる\href{http://els01stylefile.music.coocan.jp/Stagea_Style/P1703.htm}{【17-3】}。}で示すように、ミュートを駆使して面白いスタイルを作ることもできる。

\subsubsection{Editable Bit}
本体で編集可能かを決めるフラグ。設定の必要はない。

\subsection{アカンパニメントを含むスタイルファイルの作り方}
いよいよ、アカンパニメントを含むスタイルファイルを作っていこう。まずは、前の章と同様にMIDIセクションの記述から始める。メイン・アドドラムは前の章で解説した方法で準備し、それ以外のセクションパートについて解説をする。

\subsubsection{アカンパニメントパートのMIDIセクションの打ち込み}
アカンパニメントパートの作り方は、基本的にドラムパートと同じである。前の章と同じように、Dominoで新規プロジェクトを作成し、拍子の設定を行った後、1小節目をセットアップ小節として使い、\texttt{Main A}マーカーをつけた2小節目からノートを打ち込んでいく。\texttt{Main A}の後は、次のマーカーを挿入するか、MIDIセクションの終わりであればEnd of Trackを挿入する。終わった後は、format 0のSMFを書き出して、拡張子を「.mid」から「.sty」に変更する。

ドラムパートと異なるのは、\emphj{音高変換される前提でノートを打ち込む}という点である。復習であるが、CtabのC.R.とC.T.でMIDIセクションのキーが決まり、具体的な音高変換のルールはNTR、NTT、H.K.、Limitで決まる。C.R.とC.T.では$\textrm{C}_{\textrm{M7}}$を指定することが多いので、MIDIセクションは$\textrm{C}_{\textrm{M7}}$の構成音で書くと良いだろう。

\paragraph{アカンパニメントパートのMIDIセクションの注意点} \
\begin{itemize}
\item ベースパートのアカンパニメントを書く際は、様々な点に注意する必要がある。まず、\emphj{エレクトーンで再生するベースパートは、足鍵盤ボイスで再生する。そのため、プログラムチェンジを使うことができない}。XGボイスのベースを使いたい場合は、その他のセクションパートに入れるか、XGサポートに入れることになる。また、\emphj{アカンパニメントのベースパートは1オクターブ上で再生されてしまうため、オクターブを下げて保存する必要がある}\href{http://els01stylefile.music.coocan.jp/Stagea_Style/P1612.htm}{【16-12】}。ベースのフレーズを制御するのも簡単なことではなく、特にカスタムA.B.C.はL.K.とセットでコードを判定するため、意図したフレーズにならないことが多い。そのため、ベースパートのノートはルートと5度ぐらいにとどめておいて、アカンパニメントでは発音と休符の補助をさせ、フレーズは自分の足で演奏することをおすすめする。

\item XGボイスにバリエーションエフェクトを指定したい場合、\emphj{スタイルのバリエーションエフェクトはシステムエフェクトで固定されているため、図\ref{figvariation}の(a)のようにかける}。リズムでエフェクトを使用しているなら、それと同じエフェクトしかアカンパニメントにかけられない。

\item セクションパターンのイントロとエンディングの再生中は、下鍵盤ボイスの発音が禁止される。また、鍵盤で押さえているコードは、イントロ・エンディングの再生中は変更されない前提で作る。イントロ・エンディングを作ろうと思っている方は、覚えておくと良いだろう。
\end{itemize}

\subsubsection{CASMセクションの作成と編集}
\begin{figure}[h]
  \centering
  \includegraphics[keepaspectratio,width=120mm]{CasmCreate.pdf}
  \caption{CasmEditの最初のウィンドウ。スタイルファイルを開いた後の画面。メニューバーの「Create CASM Section」でCASMセクションを作ることができる。CASMセクションがある場合は、右上の「CASM」ボタンで次のウィンドウに遷移できる。}
  \label{figCasmCreate}
\end{figure}
いよいよCASMセクションの具体的な編集方法の解説に移る。まず、Dominoで書き出したSMF（拡張子は「.sty」）をCasmEditで開く（ドラッグアンドドロップで良い）。そうすると、そのSMFのMIDIイベントのリストが表示される。ちなみに、この画面ではDominoのイベントリストと同じように、MIDIデータの直打ちを行うことでヤマハのスタイル楽器に特化したエディットが可能である。だが、本稿ではこのエディタは使用せず、CASMセクションの編集のみを行う。

CASMセクションの編集を行うには、当然ながら、ファイルにCASMセクションが存在しないといけない。しかし、Dominoで作成されたSMFにはCASMセクションがないため、まずCasmEditでデフォルトのCASMセクションをファイルに結合する必要がある。メニューバーの「Create」$\rightarrow$「Create CASM Section F4」を選択し、新しく現れたウィンドウの「Create CASM」のボタンを押すと、CASMセクションが作られ、新たにCASM編集のウィンドウ「CASM Editor...」が現れる。なお、この新しく現れたウィンドウを誤って消してしまった場合、最初のウィンドウの上部にある「CASM」ボタンを押すことでも呼び出すことができる（図\ref{figCasmCreate}）。

さて、CASMセクション編集ウィンドウの解説をする。CASMセクション編集ウィンドウでは、Ctabを編集できる。ウィンドウ下半分にあるリストの「Section」はセクションパターンのことで、「Tr」は入力チャンネルを示している。「Name」は英字8文字まででつけることができる\cite{style}が、編集しないほうが無難である。「Section」「Tr」「Name」の3つを見て編集すべきCtabを特定したら、そのCtabをクリックして編集を開始できる。

編集すべきCtabをクリックして選択状態にすれば、ウィンドウ上半分の編集部分でパラメータの編集ができる。また、ウィンドウ下半分のリストの該当する部分をダブルクリックすることでも編集可能である。特にCnttの設定においては、番号で指定するのは実質的に不可能なので\footnote{もちろん、\cite{style}の通りに番号が振られているので、覚えていれば番号指定でも構わない。}、リストのCntt欄をダブルクリックして指定する（図\ref{figCasmEdit}）。

\begin{figure}[h]
  \centering
  \includegraphics[keepaspectratio,width=120mm]{CasmEdit.pdf}
  \caption{CASMセクション編集ウィンドウ。Ctabを選択してから図の点線囲み部分でパラメータを指定するか、Ctabのリストの該当部分を直接ダブルクリックすることでも編集できる。}
  \label{figCasmEdit}
\end{figure}

\subsubsection{CASMセクションの保存とバックアップ}

全てのCtabについて適切な編集が終わったら、CASMセクションを保存しよう。CASM編集ウィンドウである「CASM Editor...」のメニューバーの「File」$\rightarrow$「Save (F2)」$\rightarrow$「OK」で\emphj{このCASMセクションが編集中のスタイルファイルに保存される}。まだこの段階では\emphj{スタイルファイル自体の保存はされていないということに十分注意せよ}。CASMセクションの保存が終わったら、「CASM Editor...」のウィンドウを閉じて、MIDIイベントが並んだ最初のウィンドウで\emphj{もう一度}、メニューバーから「File」$\rightarrow$「Save as ...(F2)」$\rightarrow$「Yamaha styles(*.sty)で保存」で、ようやくスタイルファイルが保存される。後は、前の章と同様にエレクトーンで読み込んで、ユーザーリズムとして保存する。

ちなみに、CasmEditは、CASMセクションをスタイルファイルから切り出して保存できる。これにより、DominoなどでMIDIセクションを編集した後（ここでCASMセクションは捨てられる）、バックアップしておいた編集前のCASMセクションを結合することで、Ctabを復元できる。

CASMセクションをバックアップするには、CASMセクションを編集するウィンドウのメニューバーから「File」$\rightarrow$「Save as ...(F2)」$\rightarrow$「保存」して、次のウィンドウで「OK」を押せば良い。

バックアップしておいたCASMセクションを結合するには、CASMセクション編集のウィンドウで「File」$\rightarrow$「Open...(F3)」$\rightarrow$（csmファイルの選択）$\rightarrow$「開く」$\rightarrow$「Yes２回」で読み込むことができる。

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\clearpage

\section{Arduinoを用いたMIDIデバイス製作}
この章ではMIDIデバイスの製作に役立つArduinoの説明と、回路設計に関する簡単な説明を与える。ただし、Arduinoの文法等に関する詳細な解説はしない。
\begin{itembox}{この章の参考書}
\begin{itemize}
\item MIDI1.0規格書\cite{規格}

きちんとしたものを作るなら、まず規格を参照しなくてはいけない。

\item Arduinoのすすめ\cite{Arduinoのすすめ}

Arduinoを解説しているサイトは多いが、その中で私が最もお世話になったサイト。

\item Arduino 日本語リファレンス\cite{Arduinoリファレンス}

Arduino言語についての説明。

\item Arduino MIDI Libraryの使い方\cite{ArduinoMIDILib}

Arduinoを使ってMIDIを処理するなら間違いなく使うライブラリの詳細な解説。もしこの方がMIDI Libraryの紹介を書いていなければ、私は本稿のようなハックはしていなかった。
\end{itemize}
\end{itembox}

\subsection{Arduinoの基礎}
\subsubsection{Arduinoとは}
\emphj{Arduino}はマイコンの一種で、ArduinoボードにArduino言語を書き込んで使う。Arduinoができることは単純で、せいぜい「電圧の値を読む」「電圧を出力する」「計算する」ことしかできない。しかし、それらを組み合わせれば、大いに役立つデバイスを工夫次第で作ることができる。Arduino開発環境であるArduino IDEは、\href{https://www.arduino.cc/en/software}{公式サイト}\footnote{\url{https://www.arduino.cc/en/software}}から無料でダウンロードできる。

\subsubsection{Arduinoボード}
Arduino公式が出しているハードウェアにはいくつか種類がある。以下に代表的なArduinoボードを紹介する。
\begin{itemize}
\item Arduino UNO

Arduinoの主要モデルである。インターネット上に情報が多いので、分からないことがあったときに解決策にたどり着く可能性が高い。初心者はまずこれを買うのが良い。

\item Arduino Leonardo

ArduinoをqwertyキーボードとしてWindowsに認識させることができる\cite{EMA}。

\item Aruduino MEGA

UNOと比べて約3倍多くピンソケットを装備しており、メモリも大きい。MIDI開発の観点から言うと、ハードウェアシリアルに対応しているソケットを4対持っていることが最大の特徴である。

\item Arduino Pro Mini

私が最もよく使っているArduino。書き込み装置がボード上に存在しないため自分で用意する必要がある。実際の運用において書き込み装置は不要であるから、その分コストとサイズを抑えることができる。出力電圧が3.3Vのものが存在し、それを使う場合は3.3V用の仕様\cite{3.3V}でハードウェアを設計することになる。

\end{itemize}

Arduinoはオープンソースであり、ハードウェアに関しても多くの互換品が出回っている。私は最初の1台だけ公式のArduino UNOを購入し、あとは全て互換品を使っている。初めてArduinoを勉強しようとする人は、AmazonなどでArduino初心者キットを手に入れるのが良いと思う。

\subsubsection{Arduino言語}
Arduino言語はC/C++言語をベースにしている。本稿を読みすすめるのに必要なArduinoに特有の知識を列挙する。Arduino言語についての詳細は、本稿以外で勉強してほしい。
\begin{itemize}
\item Arduinoにおけるソースコードは「スケッチ」と呼ばれる。
\item Arduino言語に\texttt{main( )}関数は無い。その代わり、Arduinoが起動したときに1度だけ呼ばれる\texttt{setup( )}関数と、起動している限り無限ループをする\texttt{loop( )}関数で構成されている。
\item Arduinoボードには入出力用ピンが複数存在し、\texttt{setup( )}の中でそれらのピンを入力で使うのか、出力で使うのかを宣言する。
\end{itemize}

\subsubsection{Arduino始めの一歩　Lチカ}
流石に外部サイトに投げっぱなしでは読者が興味を持たないと思ったので、本稿でも簡単に解説をする。Arduinoの雰囲気を感じ取ってもらいたい。

次はArduino言語におけるHello World的なスケッチであり、Blinkと呼ばれる。日本では「Lチカ」（LEDチカチカの略？）と呼ばれる。Arduino IDEのSample Sketchから見ることができる。
\begin{lstlisting}[caption=Lチカ]
void setup() {
  pinMode(LED_BUILTIN, OUTPUT);
}

void loop() {
  digitalWrite(LED_BUILTIN, HIGH);
  delay(1000);
  digitalWrite(LED_BUILTIN, LOW);
  delay(1000);
}
\end{lstlisting}

1行目から3行目までが\verb|setup( )|関数であり、\verb|LED_BUILTIN|\footnote{Arduinoボードには始めからLEDがインストールされていることが多い。UNOの場合は13番ピンについている。よってUNOにおいて\verb|LED_BUILTIN|は13番ピンのことである。}というピンを\verb|OUTPUT|で使う、と初期化している。これにより、\verb|LED_BUILTIN|に対し電圧（オン、オフ）を出力できるようになった\footnote{なお、初期化しなかった他のピンはデフォルトでINPUTとして扱われる。}。

5行目から最後までが\verb|loop( )|関数であり、\verb|digitalWrite( )|関数と\verb|delay( )|関数が並んでいる。\verb|digitalWrite( )|関数は、出力に設定されているピンに対してHIGHまたはLOWの電圧をかける関数である。HIGHにした6行目でLEDが点灯し、LOWにした8行目でLEDが消灯する。\verb|delay( )|関数は、引数（単位はミリ秒）の間待機するという関数である。今回は1000ミリ秒($=$1秒)待機する。よって、このスケッチを実行すると、LEDが1秒おきに点灯と消灯を繰り返すことになる。

\subsubsection{Arduinoとシリアル通信}
\emphj{シリアル通信}とは、HIGHまたはLOWの電圧レベルを時間的に連続に変化させることで、情報を送受信する通信である。MIDIがシリアル通信による送受信であるため、ここで簡単に説明する。

Arduino UNOはボードにシリアル通信用入出力ピンを装備しており、これを使うことで他の機器と通信できる。送信用のピンソケットにはTX、受信用のピンソケットにはRXと印刷されている。これらのシリアル通信用ピンを使ってシリアル通信する時、この通信を\emphj{HardwareSerial}と呼ぶ。なお、USBケーブルでパソコンと接続している場合、TX/RXを使わなくてもUSBを介してシリアル通信を行える。

これに対して、シリアル通信用ピンが何らかの理由で使えない時、\emphj{SoftwareSerial}ライブラリをインクルードすることで、他のピンをシリアル通信のために代用できる（SoftwareSerialは明示的に宣言しないと使用されない）。しかし、SoftwareSerialはコードによって通信するため、通信が終わるまでその先の処理ができない、割り込みされるとバグる、などの不安定要素がある。MIDIの送受信においては使い物にならないため、MIDI IN/OUTを2セット以上搭載したい場合は、Arduino MEGAなどのボードや、別なマイコンを検討する必要がある。

次のスケッチは、Arduino IDEのSample SketchのGraphである。

\begin{lstlisting}[caption=Graph]
void setup() {
  Serial.begin(9600);
}

void loop() {
  Serial.println(analogRead(A0));
  delay(2);
}
\end{lstlisting}

Arduino IDEには「シリアルモニタ」「シリアルプロッタ」という、Arduinoから送信されたシリアル通信のデータを表示する機能がある。このスケッチはそれらを用いてA0ピンの電位を表示する、というチュートリアルになっている。

シリアル通信をする時は、2行目のように\verb|setup( )|内で\verb|Serial.begin( )|する必要がある。\verb|Serial.begin( )|の引数は通信速度であり、bpsで指定する。ただし、Arduino MIDI Library（後述）を使ってMIDIとしてシリアル通信する場合は、\verb|Serial.begin( )|してはいけない。

\verb|loop( )|内ではA0ピンの電位を\verb|analogRead( )|関数で読んでいる\footnote{\verb|setup( )|内でA0ピンを\verb|pinMode(A0, INPUT)|しなくても良いのは、pinModeを指定しない場合のデフォルトがINPUTだからである。}。\verb|analogRead( )|関数は、アナログ入力ピンへの入力電圧を、5V$=$1023、GND$=$0として、整数で返す関数である。これを、\verb|Serial.println( )|に渡すことで、シリアル通信でその整数値（改行コードつき）を送信している。\verb|delay(2)|は\verb|analogRead( )|がデジタル値に変換するのにかかる時間を考慮して、安定化のために書いてある。

\subsection{MIDI ソフトウェア設計 (Arduino MIDI Library)}
MIDIの通信は、前述のシリアル通信で行われる。ArduinoでMIDIを簡単に送受信するためのライブラリがArduino MIDI Libraryである。インストールから基本的な使い方まで、Arduino MIDI Library の使い方\cite{ArduinoMIDILib}で丁寧に解説されているため、それを熟読してほしい。

非常に簡単に解説すると、MIDIメッセージを読む機械を作りたければ、次のようにすれば良い。「おまじない」を唱えたあと、\verb|setup( )|でハンドラを用意して、\verb|loop( )|で\verb|MIDI.read( )|すれば、用意したハンドラが勝手に呼び出されて、メッセージに対して応答できる。

\subsection{MIDI ハードウェア設計}
MIDIデータに関する処理はArduino MIDI Libraryでできるようになった。次にMIDIのハードウェアのことを考える。

Arduino UNOの場合、\href{https://www.switch-science.com/catalog/2492/}{MIDIシールド}\footnote{\url{https://www.switch-science.com/catalog/2492/}}というものがあり、これをUNOの上に重ねるだけでMIDIを送受信できるようになる。ただ、MIDIシールドは値段が高いうえに大きいので、MIDIインターフェースを備えたデバイスを自分で設計できるようになっておくことは有用である。MIDIの規格書\cite{規格}\cite{3.3V}に設計は書いてあるが、本稿でも説明しておく。ただし、簡単にしか説明しないため、実際にハードを作るなら必ず規格を参照すること。

MIDI端子には5ピンのDIN（180$^\circ$）を用いる。送受信ともソケット（メス端子）を用い、送信側には「MIDI OUT」、受信側には「MIDI IN」と表記しなければならない。また、MIDIの送信側と受信側とでは回路が電気的に絶縁されており、信号はフォトカプラ（別名オプトアイソレーター）というものでやり取りされている。これはLEDと感光素子がセットになっているものであり、送信側の回路は受信側のLEDを駆動し、受信側の回路はLEDの光を信号として得る。

\subsubsection{MIDI OUT}
\begin{figure}[h]
  \centering
  \includegraphics[width=6cm]{MIDIOUTstd.pdf}
  \caption{MIDI OUTの規格\cite{規格}。}
  \label{figMIDIOUTstd}
\end{figure}

図\ref{figMIDIOUTstd}は規格\cite{規格}のオプションを取り外した最小構成の回路図である。送信側の電圧が3.3Vの場合と5Vの場合が規格として定められており\cite{3.3V}、どちらを採用するかはArduinoボードの電圧による。Arduino UNOの場合は5Vなので、抵抗$R_{\mathrm{A}}$と$R_{\mathrm{C}}$はどちらも220$\Omega$を使う。3.3Vボードの場合は、$R_{\mathrm{A}}=33\Omega$、$R_{\mathrm{C}}=10\Omega$とする。

\begin{figure}[H]
    \begin{tabular}{cc}
      %---- 最初の図 ---------------------------
      \begin{minipage}[t]{0.45\hsize}
        \centering
        \includegraphics[width=6cm]{MIDIOUTshrink-min.png}
        \caption{ボードが5Vの場合のMIDI OUT回路を真上から見た場合の実体配線図。なお、ボードが3.3Vのときは、3.3V側の抵抗を$33\Omega$にし、TX側の抵抗を$10\Omega$にする。実体配線図は\href{http://uaubn.g2.xrea.com/pass/}{PasS}で描いた。}
        \label{figMIDIOUT}
      \end{minipage} &
      %---- 2番目の図 --------------------------
      \begin{minipage}[t]{0.45\hsize}
        \centering
        \includegraphics[width=5cm]{MIDIOUTreal.jpg}
        \caption{実際のMIDI OUT回路。Arduinoとはジャンパワイヤで接続する。3.3Vボードのため、抵抗は$33\Omega$と$10\Omega$である。}
        \label{figMIDIOUTreal}
      \end{minipage}
      %---- 図はここまで ----------------------
    \end{tabular}
  \end{figure}

また、図\ref{figMIDIOUT}はその実体配線図であり、図\ref{figMIDIOUTreal}はそれを実際にはんだ付けしたものである。必要なものは2個の抵抗だけであり、非常に簡単な回路であるということがわかると思う。

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%MIDI IN%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\subsubsection{MIDI IN}
\begin{figure}[h]
  \centering
  \includegraphics[width=10cm]{MIDIINstd.pdf}
  \caption{MIDI INの規格\cite{規格}。}
  \label{figMIDIINstd}
\end{figure}

図\ref{figMIDIINstd}はMIDI INの規格である\cite{規格}\footnote{元の規格\cite{規格}ではフォトカプラ側のパスコンが省略されていたため、図\ref{figMIDIINstd}では省略せずに描いた。}。プルアップ抵抗$R_{\mathrm{D}}$とバイパスコンデンサ$C_{\mathrm{A}}$は採用するフォトカプラに依存する。

フォトカプラは5 mA以下で駆動でき、2 $\mu$s以下の立ち上がり・立ち下がり時間でなくてはならない。また、MIDI規格書\cite{規格}に適合するフォトカプラの例が載っており、NJL-5127D、TLP513、PC-900V、PC-410(K)、PC-910(K)、HCPL-260L、HCPL-261A、HCPL-M600、QCPL-M605\#500とされている。

ここでは、電子工作を始める人のために、フォトカプラを使った実際の回路を設計していく際の流れを確認していく。まずは、選択したフォトカプラのデータシートを見よう。例として、ここではTLP552を採用したことにする。「TLP552 データシート」などでデータシートを閲覧できる\cite{TLP552}。

まずは最も重要な\emphj{絶対最大定格}から説明する。これは、このICを使う上で\emphj{最悪のケースでも絶対に一瞬も超過してはいけない値のこと}で、絶対最大定格の外側ではデバイスに損傷が出る。かならず絶対最大定格を守るように、余裕を持って設計する。

さて、設計のために1ページ目の内容を見ると、$V_{\mathrm{CC}}$$=$5 Vと書いてある。\emphj{つまりこのフォトカプラは5 Vで動作する}。また、内部回路図の注に、「8ピンと5ピンの間に、バイパス用のコンデンサ0.1 $\mu$Fをつける必要があります。」とある。このようなコンデンサを\emphj{パスコン}といい、ノイズ対策などのために付けることがある。なるべくICの電源に近いところに、高周波の性能が良いセラミックコンデンサをつける。

\begin{wrapfigure}{r}[5mm]{45mm}
  \centering
  \includegraphics[width=4cm]{TLP552_assign.png}
  \caption{TLP552のピン配線図\cite{TLP552}。}
  \label{fig552}
\end{wrapfigure}

新しくICを導入する際は必ず\emphj{ピン接続図（ピンアサイン）}を確認しよう\footnote{TLP552のようなICパッケージのピンは、丸印があるところを1番ピンとして、そこから反時計回りに順番に2番、3番……とピンを識別する。ICによっては、丸印ではなく、ICの上方向（12時の方向）に切り欠きがあって、そこから反時計回りに1番、2番……とすることもある。}。データシートの1ページ目の図（右図\ref{fig552}）を見ると、TLP552のそれぞれの足に異なる機能がついていることがわかる。また、MIDI INの回路図（図\ref{figMIDIINstd}）と見比べると、TLP552の2、3ピンをMIDI信号入力のLEDとして使うべきであるということもわかる。よって、\emphj{TLP552の2ピンをMIDI INの4ピンに、TLP552の3ピンをMIDI INの5ピンにつなぐように配線すれば良い}。また出力側も、\emphj{6ピンが出力なので、これをArduinoのRXにつなげば良い}。7\footnote{TLP552の7ピンは\emphj{イネーブル}で、ここにイネーブル電圧より高い電圧を印加しないと、このICは動かない。}、8ピンは5 Vにつないで、5ピンはGNDにつなぐので、あとはプルアップ抵抗$R_{\mathrm{D}}$の値を決めれば、MIDI INは実装できる。

\emphj{プルアップ抵抗}とは、入力が「浮く」のを防ぐために、スイッチが切られている状態の入力を高電圧に保つための抵抗である。インターネットで調べればいくらでも解説は出てくるのでここでの解説は省略するが、適切なプルアップ抵抗の決め方だけ簡単に解説しておく。

プルアップ抵抗の値が低すぎると、スイッチが閉じられている時に流れる電流が増える。そうすると、トランジスタで発生する電圧降下が大きくなってしまって、スイッチが閉じられているのにArduinoが「LOW」だと判定できなくなってしまう。

逆にプルアップ抵抗が大きすぎると、Arduinoのインピーダンス（大きい）を無視できなくなってしまって、スイッチが開いていても、入力端子での分圧が低すぎて「HIGH」だと判定されなくなってしまう。

したがって、プルアップ抵抗は適切な値を決める必要がある。TLP552のデータシートではプルアップ抵抗は$R_{\mathrm{L}}$という記号で表されているので、それに注意してデータシートのグラフ$V_{\mathrm{O}}-I_{\mathrm{F}}$を読むと、\emphj{入力電流が十分に小さいところでも俊敏に応答する1 k$\Omega$から4 k$\Omega$の抵抗値が良い}ことがわかる。

\begin{figure}[h]
  \centering
  \includegraphics[width=6cm]{MIDIINshrink-min.png}
  \caption{MIDI INの実体配線図。ICは高価で熱に弱いものが多い。そのため、ICは回路に直接はんだ付けせずに、ソケットだけを付ける。実体配線図においてはICがそのまま回路に乗っているが、実際にはんだ付けするのはソケットである。}
  \label{figMIDIIN}
\end{figure}

以上の内容を踏まえて、図\ref{figMIDIIN}でTLP552をフォトカプラとして採用したMIDI INの回路の実体配線図の例を示す。他のフォトカプラを使う場合、ピンアサインが異なったり、推奨されるパスコンの値やプルアップ抵抗の値が異なることがある。また、Arduinoによってはフォトカプラを3.3Vで動かす必要も出てくる。必ずデータシートを確認して、適切な設計をしよう。

\subsection{電子電気回路部品の紹介}
MIDIデバイスを作る上で便利な電子回路部品のうち、特に使用頻度が高いものについて、ごく簡単に解説する。
\begin{description}
\item[\emphj{抵抗}]\

多くの用途があるが、例えば、流れる電流に応じて電圧降下を生んだり、電流を減らしたりするのに使う。発熱するため、種類によって決まる抵抗の容量（ワット数）を超えないように気をつける。

\item[\emphj{可変抵抗}]\

抵抗の一種で、抵抗値が範囲内で自由に設定できる。Arduinoでは\verb|analogRead( )|すれば電圧を細かく読めるため、可変抵抗で分圧することで連続値を得られる。ボリュームノブや、フェーダーなどに使うことができるほか、圧力センサも可変抵抗であるため、ブレスコントローラも作ることができる\cite{ブレスコントローラ}。また、エクスプレッションペダルも可変抵抗である。

\item[\emphj{ダイオード}]\

主に、電流の流れる方向を1方向に制限するのに使う。順方向電圧ぶん電圧降下することに注意。
\item[\emphj{LED}]\

電流が流れると光る。ダイオードなので、向きがある。およそ2V程度の電圧降下が生じる。電流制限のための抵抗を直列に接続して、電流と光り方を制御する。
\item[\emphj{タクトスイッチ}]\

押している間、電流が流れる。プルアップ抵抗と組み合わせて\verb|digitalRead( )|をすれば、押されているかどうかをArduinoで検知できる。Arduinoで使う場合、\verb|pinMode( )|で\verb|INPUT_PULLUP|とすることで、プルアップ抵抗を自分で用意しなくとも、Arduinoのマイコン内部のものを利用できて便利である。チャタリング\footnote{チャタリングとは、物理的な衝撃によってオンとオフを高速で行き来してしまう現象のことである。}が起きたときに誤作動しないように、シュミットトリガ回路などを組むか、スケッチの側で調整する必要がある。チャタリング防止について、例えば\cite{チャタリング防止}などが参考になる。

\item[\emphj{LCDモジュール}]\

いわゆる1602系などの液晶ディスプレイ。ArduinoのLiquidCrystalライブラリを使えば、非常に簡単に文字などを出力できる。
\item[\emphj{トランジスタ}]\

微弱な電流を流すことで、大きな電流を制御できる。\verb|digitalWrite(HIGH)|で流せる電流値はごくごくわずかなので、大きな電流が必要なときはトランジスタを利用する。
\item[\emphj{リレー}]\

電流を流すことで、別な回路のスイッチを入れたり切ったりできる。Arduinoでは大きすぎて出力できないような電力の制御や、回路を能動的に「切る」必要があるとき\footnote{回路を切ることに直接の意味があるのは、たとえば、Arduinoでフットスイッチの動作を模倣するとき。フットスイッチはただのスイッチなので、「踏む・踏まない」を回路が繋がっているか、切れているかで判断している。}などに用いる。ただし、リレーの動作にもそこそこの電流が必要なため、\emphj{リレードライブ回路}というものを組む必要がある。また、リレー動作にはコイルが用いられているため、大きな逆起電力が生じる。これを吸収するためのダイオードを入れることに注意する。
\end{description}

\subsection{フォン端子とその他のインターフェース}
\subsubsection{フォン端子}
\begin{figure}[h]
  \centering
  \includegraphics[width=6cm]{phone.pdf}
  \caption{TSフォンとTRSフォンの概略図。}
  \label{figPhone}
\end{figure}

MIDIデバイスのインターフェースとして電子楽器用のコントローラを使うことが多いため、ここでフォン端子を紹介する。\emphj{フォン端子}は主にアナログオーディオの伝送に使われるが、電子楽器の拡張インターフェースの端子としても使われる。図\ref{figPhone}にフォン端子の概略図を示す。

フォン端子には絶縁体に区切られているいくつかの領域が存在している。この領域が2つのときは、それぞれチップ、スリーブと呼んで、端子を\emphj{TSフォン}と呼ぶ。領域が3つあるときは、真ん中の領域をリングと呼んで、端子を\emphj{TRSフォン}と呼ぶ。TSフォンを2極、TRSフォンを3極ということもある。イヤホンなどでオーディオを（アンバランスに）接続する場合、モノラルのものは2極、ステレオのものは3極になっていることが多い。ちなみに、マイク付きステレオイヤホンなど、コントローラーを拡張すると4極以上になることもある。

\subsubsection{その他のインターフェース}
ここでは、電子楽器用のインターフェースを紹介する。
\begin{description}
\item[\emphj{フットスイッチ}]\

足で操作するスイッチで、ヤマハFC5やFC4Aなどがある。2極のものは回路的にはただのスイッチであるため、通常のタクトスイッチと同様に回路を設計すれば良い。ただし、メーカーによって極性\footnote{踏んでいないときにONなのか、OFFなのか、という違い。ノーマルオープン、ノーマルクローズ、と呼ばれる。製品によっては極性切り替えスイッチがついていることもある。}が異なるため、事前に調べておくか、メーカーを固定してしまうのが良い。フットスイッチによっては踏む強さを感知できるものもある\footnote{ハーフペダル対応、と書いてあるフットスイッチ・フットペダルがそれである。}。その場合は3極になり、ただのスイッチではなく可変抵抗になる。

\item[\emphj{エクスプレッションペダル}]\

エレクトーンのものと同じように、足で操作する。普通は音量操作で用いるが、エフェクターの値をダイナミックに変更するために使うこともある。プラグは3極で、回路は可変抵抗。

\end{description}
\clearpage
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


\begin{thebibliography}{99}
\bibitem{製品情報} ヤマハ ELS-02C 仕様\footnote{ヤマハホームページや、取扱説明書のリンクは度々切れることがある。万が一リンク切れを起こしている場合は、自分で検索をかけてアクセスすること。}\url{https://jp.yamaha.com/products/musical_instruments/keyboards/electone/els-02c/specs.html#product-tabs}
\bibitem{MIDI入門} MIDI 入門\url{https://jp.yamaha.com/files/download/other_assets/6/315426/midi_basics_ja_v10a.pdf}
\bibitem{規格} MIDI1.0 規格書 \url{http://amei.or.jp/midistandardcommittee/MIDIspcj.html}
\bibitem{MIDIリファレンス} ELS-02/ELS-02C/ELS-02X MIDIリファレンス \url{https://jp.yamaha.com/files/download/other_assets/7/331457/els02_ja_mr_a0.pdf}
\bibitem{全面戦争} 藤本健の ``DTMステーション'' 94年にヤマハが宣戦布告。XG規格とMU80でDTM全面戦争勃発 \url{https://www.dtmstation.com/archives/51957752.html}
\bibitem{戦争収束} ASCII.jp ローランドとヤマハ、MIDIデータの互換性向上で相互協力 \url{https://ascii.jp/elem/000/000/319/319916/}
\bibitem{GMwiki} General MIDI -Wikipedia \url{https://ja.wikipedia.org/wiki/General_MIDI}
\bibitem{GMdtm} 偏ったDTM用語辞典 General MIDIとは\url{https://www.g200kg.com/jp/docs/dic/generalmidi.html}
\bibitem{CC一覧表} コントロールチェンジ一覧表 \url{http://quelque.sakura.ne.jp/midi_cc.html}
\bibitem{wakminblog} わくわくのわくみん \url{https://wakmin.blog.fc2.com/blog-entry-11.html}
\bibitem{XG仕様} XG仕様書 \url{https://jp.yamaha.com/files/download/other_assets/0/321740/xg_v135_j.pdf}
\bibitem{Dr青} Dr.青山のXG解体新書 \url{https://jp.yamaha.com/files/download/other_assets/9/321739/read_aoyama.pdf}
\bibitem{XG指針} XG楽曲データ製作の指針 \url{https://jp.yamaha.com/files/download/other_assets/6/321756/xgsongdata.pdf}
\bibitem{megavoice} CSP-170/CSP-150 データリスト \url{https://jp.yamaha.com/files/download/other_assets/3/1101213/csp170_ja_dl_a0.pdf}
\bibitem{スタイル} スタイル入門講座 \url{http://els01stylefile.music.coocan.jp/}
\bibitem{style} Peter Wierzba Style Files -- Description \url{http://www.wierzba.homepage.t-online.de/stylefiles.htm}
\bibitem{CASMeditor} YAMAHA Keyboard -- style CASM Format \url{http://www.jososoft.dk/yamaha/articles/style2_2.htm}
\bibitem{ELA1} ELA-1 Data List \url{https://my.yamaha.com/files/download/other_assets/8/1590748/ela1_en_zh_dl_a0.pdf}
\bibitem{PSR} ヤマハ PSR-SX600 Refernce Manual \url{https://jp.yamaha.com/files/download/other_assets/0/1346910/psrsx600_ja_rm_b0.pdf}
\bibitem{B00} All that I know about Electone files \url{http://serge45.free.fr/electone/texte.htm#b00evt}
\bibitem{cvp} ヤマハ クラビノーバ CVP-109/107/105 取扱説明書 \url{https://jp.yamaha.com/files/download/other_assets/4/314934/CVP109J1.PDF}
\bibitem{取説} ELECTONE STAGEA ELS-02 ELS-02C ELS-02X 取扱説明書 \url{https://jp.yamaha.com/files/download/other_assets/0/803680/els02_ja_om_g0.pdf}
\bibitem{初心者になるための} 初心者になるための耳コピMIDI講座 \url{http://mimikopi.nomaki.jp/}
\bibitem{elspc} STAGEAとPC編曲の連携 \url{https://kodack64.github.io/sound/manual/index.html}
\bibitem{Arduinoのすすめ} Arduinoのすすめ \url{https://n.mtng.org/ele/arduino/}
\bibitem{Arduinoリファレンス} Arduino 日本語リファレンス \url{http://www.musashinodenpa.com/arduino/ref/}
\bibitem{ArduinoMIDILib} Arduino MIDI Libraryの使い方 \url{https://qiita.com/yudai220/items/3bde9461f282d56d1ac2}
\bibitem{EMA} Electone $\times$ MIDI $\times$ Arduino \url{https://qiita.com/yudai220/items/b0b3dc6a8293780d5be2}
\bibitem{3.3V} MIDI 1.0 電気的仕様改訂 \url{http://amei.or.jp/midistandardcommittee/Recommended_Practice/ca33-j.pdf}
\bibitem{TLP552} TLP552 データシート \url{https://toshiba.semicon-storage.com/jp/semiconductor/product/isolators-solid-state-relays/detail.TLP552.html}
\bibitem{チャタリング防止} jumbleat  Arduinoのスケッチだけでスイッチのチャタリングを回避する \url{https://jumbleat.com/2016/08/19/switch_without_chatter/}
\bibitem{ブレスコントローラ} USB MIDI Breath Controller -- Hackaday.io \url{https://hackaday.io/project/161678-usb-midi-breath-controller}

\end{thebibliography}
\end{document}
